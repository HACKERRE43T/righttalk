<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Right Talk</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      display: flex; 
      justify-content: center; 
    }
    .app-shell { 
      max-width: 430px; width: 100%; min-height: 100vh; 
      background: rgba(255,255,255,0.97); 
      position: relative; overflow: hidden; 
      box-shadow: 0 14px 40px rgba(0,0,0,0.28); 
      border-radius: 18px; 
    }
    .hidden { display: none !important; }
    
    /* Auth */
    .auth-screen { padding: 40px 20px; text-align: center; }
    .logo { 
      font-size: 2.3rem; font-weight: 700; 
      background: linear-gradient(45deg, #667eea, #764ba2); 
      -webkit-background-clip: text; background-clip: text; 
      color: transparent; -webkit-text-fill-color: transparent;
      margin-bottom: 10px; 
    }
    .auth-card { 
      margin-top: 20px; padding: 24px 20px; 
      border-radius: 20px; background: rgba(255,255,255,0.96); 
      box-shadow: 0 10px 28px rgba(15,23,42,0.18); 
    }
    .auth-input { 
      width: 100%; padding: 12px 14px; margin-bottom: 12px; 
      border-radius: 12px; border: 1px solid #e5e7eb; 
      font-size: 0.95rem; background: #f9fafb; 
    }
    .auth-input:focus { 
      outline: none; border-color: #6366f1; 
      box-shadow: 0 0 0 1px #6366f133; background: #fff; 
    }
    .btn-primary { 
      width: 100%; padding: 12px 0; border-radius: 12px; 
      border: none; background: linear-gradient(45deg, #667eea, #764ba2); 
      color: white; font-weight: 600; cursor: pointer; 
      transition: transform 0.08s, box-shadow 0.15s; 
      box-shadow: 0 8px 20px rgba(79,70,229,0.4); 
    }
    .btn-primary:active { 
      transform: scale(0.97); 
      box-shadow: 0 4px 14px rgba(79,70,229,0.25); 
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .btn-outline { 
      width: 100%; padding: 10px 0; border-radius: 12px; 
      border: 2px solid #667eea; background: transparent; 
      color: #4f46e5; font-weight: 600; cursor: pointer; 
      margin-top: 8px; transition: background 0.15s, color 0.15s; 
    }
    .btn-outline:hover { background: #e0e7ff; }

    /* Signup wizard */
    #signup-flow { padding: 60px 20px 80px; }
    .setup-step { display: none; }
    .setup-step.active { display: block; animation: fadeIn 0.25s ease; }
    @keyframes fadeIn { 
      from{opacity:0;transform:translateY(15px);} 
      to{opacity:1;transform:translateY(0);} 
    }
    #signup-flow input, #signup-flow textarea { 
      width: 100%; padding: 12px 14px; margin-bottom: 12px; 
      border-radius: 12px; border: 1px solid #e5e7eb; 
      font-size: 0.95rem; background: #f9fafb; 
    }
    #signup-flow textarea { resize: none; min-height: 80px; }
    .tag-pill { 
      display: inline-block; background: #667eea; color: white; 
      padding: 4px 10px; border-radius: 999px; 
      font-size: 0.75rem; margin: 2px 4px 0 0; 
    }
    .tag-row { display:flex; gap:6px; margin-bottom:8px; }
    .wizard-footer { 
      position: fixed; left: 50%; transform: translateX(-50%); 
      bottom: 10px; width: 100%; max-width: 430px; 
      padding: 10px 20px; background: rgba(255,255,255,0.98); 
      border-top: 1px solid #e5e7eb; 
    }

    /* Header & nav */
    .top-bar { 
      position: sticky; top: 0; z-index: 10; 
      background: white; padding: 10px 16px; 
      display: flex; align-items: center; justify-content: space-between; 
      border-bottom: 1px solid #e5e7eb; 
    }
    .top-left-title { 
      font-weight: 700; font-size: 1.1rem; 
      display: flex; align-items: center; gap: 6px; 
    }
    .top-left-title span { 
      width: 24px; height: 24px; border-radius: 8px; 
      background: linear-gradient(135deg,#4f46e5,#f97316); 
      display:flex; align-items:center; justify-content:center; 
      color:#fff; font-size:0.8rem; 
    }
    .top-actions { display:flex; gap:10px; align-items:center; }
    .alarm { position: relative; cursor: pointer; }
    .alarm-dot { 
      position: absolute; width: 9px; height: 9px; 
      border-radius: 50%; background: #ef4444; 
      top: -2px; right: -2px; animation: pulse 1.8s infinite; 
    }
    @keyframes pulse { 
      0%{transform:scale(1);opacity:1;} 
      50%{transform:scale(1.6);opacity:0.6;} 
      100%{transform:scale(1);opacity:1;} 
    }

    .bottom-nav { 
      position: fixed; bottom: 10px; left: 50%; 
      transform: translateX(-50%); width: 92%; max-width: 430px; 
      background: rgba(255,255,255,0.97); border-radius: 20px; 
      display: flex; justify-content: space-around; padding: 8px 0; 
      box-shadow: 0 10px 24px rgba(15,23,42,0.35); 
      border: 1px solid #e5e7eb; z-index: 20; 
    }
    .nav-item { 
      font-size: 0.7rem; color: #6b7280; 
      text-align: center; cursor: pointer; flex:1; 
    }
    .nav-item i { 
      font-size: 1.3rem; display: block; margin-bottom: 2px; 
    }
    .nav-item.active { color: #4f46e5; font-weight:600; }

    /* Trending section */
    .trending-section { 
      padding: 12px 16px; background: #f9fafb; 
      border-bottom: 1px solid #e5e7eb; 
    }
    .trending-title { 
      font-weight: 600; font-size: 0.9rem; 
      color: #374151; margin-bottom: 8px; 
      display: flex; align-items: center; gap: 6px; 
    }
    .trending-tags { 
      display: flex; gap: 8px; overflow-x: auto; 
      padding-bottom: 4px; 
    }
    .trending-tags::-webkit-scrollbar { height: 4px; }
    .trending-tags::-webkit-scrollbar-thumb { 
      background: #d1d5db; border-radius: 10px; 
    }
    .trending-tag { 
      padding: 6px 12px; border-radius: 999px; 
      background: white; border: 1px solid #e5e7eb; 
      font-size: 0.8rem; cursor: pointer; 
      white-space: nowrap; transition: all 0.2s; 
      display: flex; align-items: center; gap: 4px; 
    }
    .trending-tag:hover { 
      background: #eef2ff; border-color: #6366f1; 
      transform: translateY(-1px); 
    }
    .trending-count { 
      font-size: 0.7rem; color: #6b7280; 
      background: #f3f4f6; padding: 2px 6px; 
      border-radius: 999px; font-weight: 600; 
    }

    /* Stories / Reels bar */
    .stories-row { 
      padding: 8px 12px 4px; display: flex; gap: 10px; 
      overflow-x: auto; border-bottom: 1px solid #e5e7eb; 
      background: #f9fafb; 
    }
    .stories-row::-webkit-scrollbar { display:none; }
    .story-bubble { 
      width: 66px; flex: 0 0 auto; 
      text-align: center; cursor: pointer; 
    }
    .story-ring { 
      width: 54px; height: 54px; border-radius: 999px; 
      padding: 2px; 
      background: conic-gradient(#f97316, #facc15, #22c55e, #4f46e5, #f97316); 
      display:flex; align-items:center; justify-content:center; 
      margin: 0 auto 4px; 
    }
    .story-avatar { 
      width: 48px; height: 48px; border-radius: 999px; 
      object-fit: cover; border: 2px solid #fff; 
    }
    .story-name { 
      font-size: 0.65rem; color:#4b5563; 
      white-space: nowrap; overflow:hidden; text-overflow:ellipsis; 
    }

    .story-modal { 
      position: fixed; inset: 0; 
      background: rgba(15,23,42,0.92); 
      display:flex; align-items:center; justify-content:center; 
      z-index:30; 
    }
    .story-modal-inner { 
      width: 100%; max-width: 430px; padding: 16px; 
    }
    .story-header { 
      display:flex; justify-content:space-between; 
      align-items:center; color:#e5e7eb; 
      margin-bottom:8px; font-size:0.85rem; 
    }
    .story-video { 
      width: 100%; max-height: 75vh; 
      border-radius: 18px; background:black; 
    }
    .story-close-btn { 
      border:none; background:transparent; 
      color:#e5e7eb; font-size:1.1rem; cursor:pointer; 
    }

    /* Post creator */
    .post-creator { 
      margin: 8px 10px 10px; padding: 12px; 
      border-radius: 16px; background: #f9fafb; 
      box-shadow: 0 2px 12px rgba(15,23,42,0.08); 
    }
    .row-flex { display:flex; align-items:flex-start; gap:10px; }
    .avatar-sm { 
      width: 40px; height: 40px; 
      border-radius: 50%; object-fit: cover; 
    }
    .creator-textarea { 
      width: 100%; border: none; background: transparent; 
      resize: none; font-size: 0.95rem; 
      font-family: inherit; min-height: 50px; 
    }
    .creator-textarea:focus { outline: none; }
    .media-preview img, .media-preview video { 
      width: 100%; border-radius: 12px; margin-top: 8px; 
    }

    /* Topic chips */
    .chip-row { 
      display:flex; gap:6px; padding: 0 12px 6px; 
      overflow-x:auto; 
    }
    .chip-row::-webkit-scrollbar { display:none; }
    .chip { 
      font-size:0.75rem; padding:4px 10px; 
      border-radius:999px; border:1px solid #e5e7eb; 
      background:#f3f4f6; cursor:pointer; 
      white-space:nowrap; transition: all 0.2s; 
    }
    .chip.active { 
      background:#e0e7ff; border-color:#6366f1; 
      color:#3730a3; font-weight:500; 
    }

    /* Feed cards */
    .post-card { 
      background: white; margin: 6px 10px 10px; 
      border-radius: 16px; 
      box-shadow: 0 4px 18px rgba(15,23,42,0.06); 
      overflow: hidden; 
    }
    .post-header { 
      padding: 10px 14px; display: flex; 
      align-items: center; gap: 10px; 
    }
    .avatar-xs { 
      width: 36px; height: 36px; 
      border-radius: 50%; object-fit: cover; 
    }
    .child-badge { 
      display: inline-block; margin-left: 6px; 
      padding: 2px 8px; border-radius: 999px; 
      background: #f97316; color: white; 
      font-size: 0.7rem; font-weight: 600; 
    }
    .solved-badge { 
      display:inline-block; margin-left:8px; 
      padding:2px 8px; border-radius:999px; 
      background:#16a34a; color:white; 
      font-size:0.7rem; font-weight:600; 
    }
    .post-body { 
      padding: 0 14px 12px; font-size: 0.92rem; 
    }
    .tag-strip { margin-top: 6px; }
    .tag-strip .tag-pill { 
      background:#e5e7eb; color:#4b5563; cursor: pointer; 
      transition: all 0.2s; 
    }
    .tag-strip .tag-pill:hover { 
      background:#dbeafe; color:#1e40af; 
      transform: translateY(-1px); 
    }

    .media-wrapper { 
      position: relative; margin-top: 8px; 
      border-radius: 16px; overflow:hidden; 
      background:#000; 
    }
    .media-wrapper img, .media-wrapper video { 
      width: 100%; max-height: 360px; 
      object-fit: cover; display:block; 
    }
    .heart-burst { 
      position:absolute; top:50%; left:50%; 
      transform:translate(-50%,-50%) scale(0); 
      color:#f97316; opacity:0; pointer-events:none; 
      font-size:3rem; 
    }
    .heart-burst i { text-shadow:0 4px 14px rgba(0,0,0,0.6); }
    .heart-burst.active { animation: heartPop 0.6s ease-out; }
    @keyframes heartPop { 
      0% { transform:translate(-50%,-50%) scale(0); opacity:0; } 
      40% { transform:translate(-50%,-50%) scale(1.3); opacity:1; } 
      100% { transform:translate(-50%,-50%) scale(0.9); opacity:0; } 
    }

    .post-actions { 
      display:flex; gap:14px; font-size: 0.8rem; 
      color:#6b7280; margin-top:8px; flex-wrap:wrap; 
    }
    .post-actions span { 
      cursor:pointer; display:flex; 
      align-items:center; gap:4px; 
      transition: all 0.2s; 
    }
    .post-actions span:hover { 
      color:#4f46e5; 
      transform: scale(1.1); 
    }
    .likes-line { 
      font-size:0.8rem; color:#4b5563; 
      margin-top:4px; font-weight:500; 
    }

    /* Poll options */
    .poll-options { margin-top: 8px; }
    .poll-btn { 
      width: 100%; margin-top: 4px; padding: 8px 10px; 
      border-radius: 10px; border: 1px solid #e5e7eb; 
      background: #f9fafb; font-size: 0.85rem; 
      text-align: left; cursor: pointer; 
      transition: all 0.2s; 
    }
    .poll-btn:hover { 
      background:#eef2ff; border-color:#6366f1; 
      transform: translateX(4px); 
    }

    /* Views */
    .view { padding-bottom: 80px; }

    /* Profile view */
    .profile-view { padding: 20px 20px 90px; text-align: center; }
    .profile-avatar-lg { 
      width: 90px; height: 90px; border-radius: 50%; 
      object-fit: cover; border: 3px solid #4f46e5; 
      margin-bottom: 8px; 
    }
    .profile-stats { 
      display:flex; justify-content:space-around; 
      margin-top:10px; padding:10px 14px; 
      border-radius:14px; background:#f3f4f6; 
    }
    .stat-number { font-weight:700; font-size:0.95rem; }
    .stat-label { font-size:0.7rem; color:#6b7280; }
    .profile-edit-panel { 
      margin-top:12px; padding:12px; 
      border-radius:14px; background:#f3f4f6; 
      text-align:left; font-size:0.85rem; 
    }
    .my-post-item { 
      margin-top:6px; padding:8px 10px; 
      border-radius:10px; border:1px solid #e5e7eb; 
      font-size:0.85rem; text-align:left; 
      background:#f9fafb; 
    }
    .my-posts-grid { 
      margin-top:8px; display:grid; 
      grid-template-columns: repeat(3, 1fr); gap:3px; 
    }
    .my-grid-item { 
      width:100%; padding-top:100%; position:relative; 
      overflow:hidden; background:#111827; cursor:pointer; 
      transition: transform 0.2s; 
    }
    .my-grid-item:hover { 
      transform: scale(1.05); 
      z-index: 1; 
    }
    .my-grid-item img, .my-grid-item video { 
      position:absolute; inset:0; width:100%; 
      height:100%; object-fit:cover; 
    }
    .my-grid-item-fallback { 
      position:absolute; inset:0; display:flex; 
      align-items:center; justify-content:center; 
      font-size:0.55rem; color:#e5e7eb; 
      padding:4px; text-align:center; 
    }

    /* Friends / search */
    .user-item { 
      display:flex; align-items:center; gap:10px; 
      padding:8px 10px; border-radius:10px; 
      border:1px solid #e5e7eb; margin-top:6px; 
      background:#f9fafb; transition: all 0.2s; 
    }
    .user-item:hover { 
      background:#f3f4f6; 
      transform: translateX(4px); 
    }
    .user-item button { 
      margin-left:auto; padding:4px 10px; 
      border-radius:999px; border:none; 
      background:#4f46e5; color:white; 
      font-size:0.75rem; cursor:pointer; 
      transition: all 0.2s; 
    }
    .user-item button:hover { 
      background:#3730a3; 
      transform: scale(1.05); 
    }

    /* Chat view */
    .chat-header { 
      padding:10px 14px; border-bottom:1px solid #e5e7eb; 
      display:flex; align-items:center; gap:8px; 
      background: white; 
    }
    .chat-body { 
      padding:10px 14px; 
      max-height: calc(100vh - 240px); 
      overflow-y:auto; 
    }
    .chat-input-row { 
      display:flex; gap:8px; padding:8px 14px 16px; 
      border-top:1px solid #e5e7eb; 
      background: white; 
    }
    .bubble { 
      max-width:75%; padding:8px 10px; 
      border-radius:12px; margin-bottom:6px; 
      font-size:0.85rem; animation: slideIn 0.2s ease; 
    }
    @keyframes slideIn { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    .bubble.me { margin-left:auto; background:#e0e7ff; }
    .bubble.them { margin-right:auto; background:#f3f4f6; }

    /* Loading */
    .loading-msg {
      text-align: center;
      padding: 20px;
      color: #6b7280;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="auth-screen">
      <div class="logo">Right Talk</div>
      <p style="color:#6b7280;margin-bottom:18px;">Community social media for ideas, problems, help, polls & reels.</p>
      <div class="auth-card">
        <input id="auth-email" class="auth-input" type="email" placeholder="Email" />
        <input id="auth-password" class="auth-input" type="password" placeholder="Password" />
        <button class="btn-primary" onclick="login()">Sign In</button>
        <button class="btn-outline" onclick="startSignup()">Create Account</button>
        <div id="auth-error" style="color:#ef4444;font-size:0.8rem;margin-top:8px;"></div>
      </div>
    </div>

    <!-- SIGNUP FLOW -->
    <div id="signup-flow" class="hidden">
      <div style="position:absolute;top:14px;left:14px;cursor:pointer;" onclick="backToLogin()">
        <i class="bi bi-arrow-left" style="font-size:1.4rem;"></i>
      </div>

      <div id="signup-step-1" class="setup-step active">
        <h2 style="margin-bottom:18px;">Set your name</h2>
        <input id="full-name" type="text" placeholder="Full name" />
        <input id="username" type="text" placeholder="Username (unique)" />
      </div>

      <div id="signup-step-2" class="setup-step">
        <h2 style="margin-bottom:18px;">Personal info</h2>
        <label style="font-size:0.8rem;color:#6b7280;">Date of birth</label>
        <input id="dob" type="date" />
        <textarea id="bio" placeholder="Short bio (optional)"></textarea>
      </div>

      <div id="signup-step-3" class="setup-step">
        <h2 style="margin-bottom:18px;">Avatar & tags</h2>
        <label style="font-size:0.8rem;color:#6b7280;">Profile picture (optional)</label>
        <input id="avatar-file" type="file" accept="image/*" />
        <div class="tag-row">
          <input id="profile-tag-input" type="text" placeholder="#ideas #help ..." />
          <button type="button" onclick="addProfileTag()" style="padding:0 10px;border-radius:10px;border:1px solid #d1d5db;background:#f3f4f6;cursor:pointer;">Add</button>
        </div>
        <div id="profile-tags-view"></div>
      </div>

      <div class="wizard-footer">
        <button id="wizard-next-btn" class="btn-primary" onclick="nextSignupStep()">Next</button>
      </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
      <!-- Header -->
      <div class="top-bar">
        <div class="top-left-title">
          <span><i class="bi bi-chat-dots-fill"></i></span> Right Talk
        </div>
        <div class="top-actions">
          <div class="alarm" onclick="showHotFeed()" title="Hot feed">
            <i class="bi bi-fire" style="font-size:1.4rem;color:#ef4444;"></i>
            <div id="alarm-dot" class="alarm-dot hidden"></div>
          </div>
        </div>
      </div>

      <!-- Trending Problems Section -->
      <div class="trending-section">
        <div class="trending-title">
          <i class="bi bi-fire" style="color:#ef4444;"></i>
          Trending Problems
        </div>
        <div id="trending-tags" class="trending-tags">
          <div class="loading-msg">Loading trending...</div>
        </div>
      </div>

      <!-- Stories / Reels bar -->
      <div id="stories-row" class="stories-row"></div>

      <!-- VIEWS -->
      <div id="feed-view" class="view">
        <!-- Post creator -->
        <div class="post-creator">
          <div class="row-flex">
            <img id="creator-avatar" class="avatar-sm" src="" alt="me" />
            <textarea id="post-content" class="creator-textarea" placeholder="Share note, poll or 1â€‘minute reel... use #tags"></textarea>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:8px;">
            <div style="display:flex;gap:6px;align-items:center;">
              <label style="cursor:pointer;padding:6px 10px;border-radius:999px;background:#e5e7eb;font-size:0.8rem;">
                <i class="bi bi-image"></i>
                <input id="media-file" type="file" accept="image/*,video/*" onchange="handleMedia()" style="display:none;" />
              </label>
              <select id="post-kind" style="font-size:0.75rem;padding:6px 8px;border-radius:999px;border:1px solid #d1d5db;">
                <option value="note">Note</option>
                <option value="poll">Poll</option>
                <option value="reel">Reel</option>
              </select>
            </div>
            <button id="post-btn" class="btn-primary" style="width:auto;padding:7px 16px;font-size:0.85rem;" onclick="createPost()">Post</button>
          </div>

          <!-- Poll option inputs -->
          <div id="poll-inputs" class="hidden" style="margin-top:8px;">
            <input id="poll-opt-1" class="auth-input" style="margin-bottom:6px;" placeholder="Option 1" />
            <input id="poll-opt-2" class="auth-input" style="margin-bottom:0;" placeholder="Option 2" />
          </div>

          <div id="creator-media-preview" class="media-preview"></div>
        </div>

        <!-- Topic chips -->
        <div class="chip-row">
          <div class="chip active" data-filter="all" onclick="applyFilter(this)">All</div>
          <div class="chip" data-filter="#problem" onclick="applyFilter(this)">#problem</div>
          <div class="chip" data-filter="#idea" onclick="applyFilter(this)">#idea</div>
          <div class="chip" data-filter="#help" onclick="applyFilter(this)">#help</div>
          <div class="chip" data-filter="reels" onclick="applyFilter(this)">Reels</div>
          <div class="chip" data-filter="polls" onclick="applyFilter(this)">Polls</div>
        </div>

        <!-- Feed -->
        <div id="feed-container">
          <div class="loading-msg">Loading posts...</div>
        </div>
      </div>

      <div id="friends-view" class="view hidden">
        <div style="padding:20px;">
          <h3>Community</h3>
          <p style="font-size:0.85rem;color:#6b7280;margin-top:6px;">Search people by name or username and start a DM.</p>
          <div class="tag-row" style="margin-top:10px;">
            <input id="user-search-input" type="text" placeholder="Search users..." />
            <button type="button" onclick="searchUsers()" style="padding:0 12px;border-radius:10px;border:none;background:#4f46e5;color:white;font-size:0.8rem;cursor:pointer;">Search</button>
          </div>
          <div id="user-search-results"></div>
        </div>
      </div>

      <div id="chat-view" class="view hidden">
        <div id="chat-empty" style="padding:20px;font-size:0.9rem;color:#6b7280;">
          Select a person from Community tab to chat.
        </div>
        <div id="chat-panel" class="hidden">
          <div class="chat-header">
            <img id="chat-avatar" class="avatar-xs" src="" />
            <div>
              <div id="chat-name" style="font-size:0.9rem;font-weight:600;"></div>
              <div id="chat-username" style="font-size:0.75rem;color:#6b7280;"></div>
            </div>
          </div>
          <div id="chat-messages" class="chat-body"></div>
          <div class="chat-input-row">
            <input id="chat-input" class="auth-input" style="margin-bottom:0;" placeholder="Type a message..." />
            <button class="btn-primary" style="width:auto;padding:0 14px;" onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>

      <div id="profile-view" class="view hidden">
        <div class="profile-view">
          <img id="profile-avatar-lg" class="profile-avatar-lg" src="" alt="avatar" />
          <div id="profile-name" style="font-weight:600;font-size:1.1rem;margin-bottom:4px;">User</div>
          <div id="profile-username" style="font-size:0.8rem;color:#6b7280;margin-bottom:6px;">@handle</div>
          <div id="profile-child-badge"></div>

          <div class="profile-stats">
            <div>
              <div id="stat-posts" class="stat-number">0</div>
              <div class="stat-label">Posts</div>
            </div>
            <div>
              <div id="stat-reels" class="stat-number">0</div>
              <div class="stat-label">Reels</div>
            </div>
            <div>
              <div id="stat-polls" class="stat-number">0</div>
              <div class="stat-label">Polls</div>
            </div>
            <div>
              <div id="stat-saved" class="stat-number">0</div>
              <div class="stat-label">Saved</div>
            </div>
          </div>

          <p id="profile-bio-text" style="font-size:0.9rem;color:#4b5563;margin-top:8px;"></p>
          <div id="profile-tags-strip" style="margin-top:10px;"></div>

          <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
            <button class="btn-primary" style="width:auto;padding:6px 14px;font-size:0.8rem;" onclick="toggleProfileEdit()">Edit profile</button>
            <button class="btn-outline" style="width:auto;padding:6px 14px;font-size:0.8rem;" onclick="shareProfile()">Share profile</button>
          </div>

          <div id="profile-edit-panel" class="profile-edit-panel hidden">
            <div style="font-weight:600;margin-bottom:4px;">Edit profile</div>
            <label>Full name</label>
            <input id="edit-full-name" class="auth-input" style="margin-bottom:6px;" />
            <label>Bio</label>
            <textarea id="edit-bio" class="auth-input" style="min-height:60px;margin-bottom:6px;"></textarea>
            <label>Tags (comma separated)</label>
            <input id="edit-tags" class="auth-input" style="margin-bottom:6px;" />
            <label>Change avatar</label>
            <input id="edit-avatar-file" type="file" accept="image/*" class="auth-input" style="margin-bottom:8px;" />
            <button class="btn-primary" style="width:100%;padding:8px 0;font-size:0.85rem;" onclick="saveProfileEdits()">Save changes</button>
          </div>

          <h4 style="margin-top:18px;">My posts</h4>
          <div id="my-posts-grid" class="my-posts-grid"></div>
          <div id="my-posts-list" style="margin-top:6px;"></div>

          <h4 style="margin-top:18px;">Saved posts</h4>
          <div id="bookmarks-list" style="margin-top:6px;font-size:0.85rem;color:#6b7280;"></div>

          <button class="btn-outline" style="margin-top:16px;" onclick="logout()">Sign out</button>
        </div>
      </div>

      <!-- Story modal -->
      <div id="story-modal" class="story-modal hidden">
        <div class="story-modal-inner">
          <div class="story-header">
            <div id="story-username" class="story-username"></div>
            <button class="story-close-btn" onclick="closeStoryModal()">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <video id="story-video" class="story-video" controls playsinline></video>
        </div>
      </div>

      <!-- Bottom nav -->
      <div class="bottom-nav">
        <div class="nav-item active" data-tab="feed" onclick="switchTab(this)">
          <i class="bi bi-house-door-fill"></i>Home
        </div>
        <div class="nav-item" data-tab="friends" onclick="switchTab(this)">
          <i class="bi bi-people-fill"></i>Community
        </div>
        <div class="nav-item" data-tab="chat" onclick="switchTab(this)">
          <i class="bi bi-chat-dots-fill"></i>Chat
        </div>
        <div class="nav-item" data-tab="profile" onclick="switchTab(this)">
          <i class="bi bi-person-circle"></i>Profile
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://vhklzctdzoqixtmaxlzp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoa2x6Y3Rkem9xaXh0bWF4bHpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzY2ODMsImV4cCI6MjA3OTY1MjY4M30.F0xOR1Nvn1LWV5GYQDDnoox9fwhEywxyp6JyzYdnwrk";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    let currentProfile = null;
    let signupStep = 1;
    let profileTags = [];
    let selectedMediaFile = null;
    let activeFilter = "all";
    let allPostsCache = [];
    let activeChatUser = null;

    // ---------- Helpers ----------
    function escapeHtml(str) {
      return (str || "").replace(/&/g,"&amp;")
                        .replace(/</g,"&lt;")
                        .replace(/>/g,"&gt;")
                        .replace(/"/g,"&quot;")
                        .replace(/'/g,"&#039;");
    }

    function log(message, data = null) {
      console.log(`[Right Talk] ${message}`, data || '');
    }

    // ---------- Init ----------
    (async function init() {
      try {
        const { data: { user } } = await sb.auth.getUser();
        if (user) {
          currentUser = user;
          log('User logged in', user.id);
          showMainApp();
          await loadProfileIntoUI();
          await Promise.all([
            loadFeed("smart"),
            loadStoriesBar(),
            loadTrendingTags(),
            checkAlarms()
          ]);
        } else {
          showLoginOnly();
        }
        document.getElementById("post-kind").addEventListener("change", handlePostKindChange);
      } catch (error) {
        log('Init error', error);
        showLoginOnly();
      }
    })();

    // ---------- Auth ----------
    async function login() {
      try {
        const email = document.getElementById("auth-email").value.trim();
        const password = document.getElementById("auth-password").value.trim();
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) {
          document.getElementById("auth-error").innerText = error.message;
        } else {
          const { data: { user } } = await sb.auth.getUser();
          currentUser = user;
          log('Login successful', user.id);
          document.getElementById("auth-error").innerText = "";
          showMainApp();
          await loadProfileIntoUI();
          await Promise.all([
            loadFeed("smart"),
            loadStoriesBar(),
            loadTrendingTags(),
            checkAlarms()
          ]);
        }
      } catch (error) {
        log('Login error', error);
        document.getElementById("auth-error").innerText = "Login failed. Please try again.";
      }
    }

    async function startSignup() {
      const email = document.getElementById("auth-email").value.trim();
      const password = document.getElementById("auth-password").value.trim();
      if (!email || !password) {
        document.getElementById("auth-error").innerText = "Enter email and password first.";
        return;
      }
      const { data, error } = await sb.auth.signUp({ email, password });
      if (error) {
        document.getElementById("auth-error").innerText = error.message;
        return;
      }
      currentUser = data.user;
      log('Signup initiated', data.user.id);
      document.getElementById("auth-error").innerText = "";
      showSignupFlow();
    }

    async function logout() {
      await sb.auth.signOut();
      location.reload();
    }

    function showLoginOnly() {
      document.getElementById("login-screen").classList.remove("hidden");
      document.getElementById("signup-flow").classList.add("hidden");
      document.getElementById("main-app").classList.add("hidden");
    }

    function showSignupFlow() {
      document.getElementById("login-screen").classList.add("hidden");
      document.getElementById("signup-flow").classList.remove("hidden");
      document.getElementById("main-app").classList.add("hidden");
      signupStep = 1;
      showStep(1);
    }

    function showMainApp() {
      document.getElementById("login-screen").classList.add("hidden");
      document.getElementById("signup-flow").classList.add("hidden");
      document.getElementById("main-app").classList.remove("hidden");
    }

    function backToLogin() {
      showLoginOnly();
    }

    function showStep(step) {
      ["signup-step-1","signup-step-2","signup-step-3"].forEach(id => {
        document.getElementById(id).classList.remove("active");
      });
      document.getElementById("signup-step-"+step).classList.add("active");
      document.getElementById("wizard-next-btn").innerText = step === 3 ? "Finish setup" : "Next";
    }

    async function nextSignupStep() {
      if (!currentUser) return;
      try {
        if (signupStep === 1) {
          const full_name = document.getElementById("full-name").value.trim();
          const username = document.getElementById("username").value.trim();
          if (!full_name || !username) { alert("Enter full name and username."); return; }
          const { error } = await sb.from("profiles").update({ full_name, username }).eq("id", currentUser.id);
          if (error) { alert(error.message); return; }
          signupStep = 2;
          showStep(2);
        } else if (signupStep === 2) {
          const dob = document.getElementById("dob").value;
          const bio = document.getElementById("bio").value.trim();
          if (!dob) { alert("Select date of birth."); return; }
          const { error } = await sb.from("profiles").update({ date_of_birth: dob, bio }).eq("id", currentUser.id);
          if (error) { alert(error.message); return; }
          signupStep = 3;
          showStep(3);
        } else if (signupStep === 3) {
          const file = document.getElementById("avatar-file").files[0];
          let avatarPath = null;
          if (file) {
            const ext = file.name.split(".").pop();
            avatarPath = `${currentUser.id}_${Date.now()}.${ext}`;
            const { error: upErr } = await sb.storage.from("avatars").upload(avatarPath, file, { upsert: true });
            if (upErr) { alert(upErr.message); return; }
          }
          const updateData = { profile_tags: profileTags };
          if (avatarPath) updateData.avatar_url = avatarPath;
          await sb.from("profiles").update(updateData).eq("id", currentUser.id);
          showMainApp();
          await loadProfileIntoUI();
          await Promise.all([
            loadFeed("smart"),
            loadStoriesBar(),
            loadTrendingTags(),
            checkAlarms()
          ]);
        }
      } catch (error) {
        log('Signup step error', error);
        alert('An error occurred. Please try again.');
      }
    }

    function addProfileTag() {
      const inp = document.getElementById("profile-tag-input");
      const val = inp.value.trim();
      if (!val) return;
      if (!profileTags.includes(val)) profileTags.push(val);
      inp.value = "";
      renderTagStrip("profile-tags-view", profileTags);
    }

    function renderTagStrip(containerId, tags) {
      const el = document.getElementById(containerId);
      el.innerHTML = (tags || []).map(t => `<span class="tag-pill">${escapeHtml(t)}</span>`).join("");
    }

    // ---------- Profile UI ----------
    async function loadProfileIntoUI() {
      if (!currentUser) return;
      try {
        const { data, error } = await sb.from("profiles").select("*").eq("id", currentUser.id).single();
        if (error) {
          log('Profile load error', error);
          return;
        }
        if (!data) {
          log('No profile data found');
          return;
        }
        currentProfile = data;
        log('Profile loaded', data);

        let avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(data.full_name || "")}`;
        if (data.avatar_url) {
          const { data: urlData } = sb.storage.from("avatars").getPublicUrl(data.avatar_url);
          if (urlData?.publicUrl) avatar = urlData.publicUrl;
        }

        document.getElementById("creator-avatar").src = avatar;
        document.getElementById("profile-avatar-lg").src = avatar;
        document.getElementById("profile-name").innerText = data.full_name || "";
        document.getElementById("profile-username").innerText = data.username ? "@"+data.username : "";
        document.getElementById("profile-bio-text").innerText = data.bio || "";
        document.getElementById("profile-tags-strip").innerHTML =
          (data.profile_tags || []).map(t => `<span class="tag-pill">${escapeHtml(t)}</span>`).join("");
        document.getElementById("profile-child-badge").innerHTML =
          data.is_child ? `<span class="child-badge">CHILD TALKIE</span>` : "";

        // Prefill edit fields
        document.getElementById("edit-full-name").value = data.full_name || "";
        document.getElementById("edit-bio").value = data.bio || "";
        document.getElementById("edit-tags").value = (data.profile_tags || []).join(", ");

        await loadMyPosts();
        await loadBookmarks();
      } catch (error) {
        log('Profile UI error', error);
      }
    }

    function toggleProfileEdit() {
      document.getElementById("profile-edit-panel").classList.toggle("hidden");
    }

    async function saveProfileEdits() {
      if (!currentUser) return;
      try {
        const fullName = document.getElementById("edit-full-name").value.trim();
        const bio = document.getElementById("edit-bio").value.trim();
        const tagsStr = document.getElementById("edit-tags").value.trim();
        const file = document.getElementById("edit-avatar-file").files[0];

        const updateData = {};
        if (fullName) updateData.full_name = fullName;
        updateData.bio = bio;
        if (tagsStr) {
          updateData.profile_tags = tagsStr.split(",").map(s => s.trim()).filter(Boolean);
        }

        if (file) {
          const ext = file.name.split(".").pop();
          const avatarPath = `${currentUser.id}_${Date.now()}.${ext}`;
          const { error: upErr } = await sb.storage.from("avatars").upload(avatarPath, file, { upsert: true });
          if (upErr) { alert(upErr.message); return; }
          updateData.avatar_url = avatarPath;
        }

        const { error } = await sb.from("profiles").update(updateData).eq("id", currentUser.id);
        if (error) { alert(error.message); return; }

        document.getElementById("profile-edit-panel").classList.add("hidden");
        await loadProfileIntoUI();
        await loadFeed("smart");
        await loadStoriesBar();
      } catch (error) {
        log('Save profile error', error);
        alert('Failed to save profile changes.');
      }
    }

    async function loadMyPosts() {
      const listBox = document.getElementById("my-posts-list");
      const gridBox = document.getElementById("my-posts-grid");
      listBox.innerHTML = "Loading...";
      gridBox.innerHTML = "";
      try {
        const { data, error } = await sb
          .from("posts")
          .select("*")
          .eq("user_id", currentUser.id)
          .order("created_at", { ascending: false })
          .limit(30);
        
        if (error) { 
          log('Load my posts error', error);
          listBox.innerHTML = "Error loading posts"; 
          return; 
        }
        if (!data || !data.length) { 
          listBox.innerHTML = "You have not posted yet."; 
          gridBox.innerHTML = "";
          return; 
        }

        let reelsCount = 0;
        let pollsCount = 0;

        const listHtml = data.map(p => {
          if (p.media_type === "video") reelsCount++;
          if (p.poll_options && p.poll_options.length) pollsCount++;
          const text = p.content ? p.content.slice(0,80) : (p.poll_question || "[media]");
          return `<div class="my-post-item">
             ${escapeHtml(text)}
             <div style="font-size:0.7rem;color:#6b7280;margin-top:2px;">${new Date(p.created_at).toLocaleDateString()}</div>
           </div>`;
        }).join("");

        const gridHtml = data.map(p => {
          if (p.media_url) {
            const isVideo = p.media_type === "video";
            return `<div class="my-grid-item" onclick="scrollToPost('${p.id}')">
              ${isVideo
                ? `<video src="${p.media_url}" muted></video>`
                : `<img src="${p.media_url}" alt="post" />`}
            </div>`;
          } else {
            const text = p.content ? p.content.slice(0,40) : (p.poll_question || "Post");
            return `<div class="my-grid-item" onclick="scrollToPost('${p.id}')">
              <div class="my-grid-item-fallback">${escapeHtml(text)}</div>
            </div>`;
          }
        }).join("");

        listBox.innerHTML = listHtml;
        gridBox.innerHTML = gridHtml;
        document.getElementById("stat-posts").innerText = data.length.toString();
        document.getElementById("stat-reels").innerText = reelsCount.toString();
        document.getElementById("stat-polls").innerText = pollsCount.toString();
      } catch (error) {
        log('Load my posts error', error);
        listBox.innerHTML = "Error loading posts";
      }
    }

    async function loadBookmarks() {
      const box = document.getElementById("bookmarks-list");
      box.innerHTML = "Loading...";
      try {
        const { data: bookmarks, error } = await sb
          .from("bookmarks")
          .select("post_id")
          .eq("user_id", currentUser.id);
        
        if (error) { 
          log('Load bookmarks error', error);
          box.innerHTML = "Error loading bookmarks"; 
          return; 
        }
        if (!bookmarks || !bookmarks.length) {
          box.innerHTML = "No saved posts yet.";
          document.getElementById("stat-saved").innerText = "0";
          return;
        }
        const ids = bookmarks.map(b => b.post_id);
        const { data: posts, error: pErr } = await sb
          .from("posts")
          .select("id, content, created_at")
          .in("id", ids);
        
        if (pErr) { 
          log('Load bookmark posts error', pErr);
          box.innerHTML = "Error loading posts"; 
          return; 
        }
        const html = posts.map(p =>
          `<div>- ${escapeHtml(p.content ? p.content.slice(0,60) : "[media]")} (${new Date(p.created_at).toLocaleDateString()})</div>`
        ).join("");
        box.innerHTML = html;
        document.getElementById("stat-saved").innerText = posts.length.toString();
      } catch (error) {
        log('Bookmarks error', error);
        box.innerHTML = "Error loading bookmarks";
      }
    }

    function shareProfile() {
      if (!currentUser || !currentProfile) return;
      const url = window.location.href.split("#")[0] + "#user-" + currentUser.id;
      const title = `Right Talk profile: ${currentProfile.full_name}`;
      if (navigator.share) {
        navigator.share({ title, url });
      } else {
        navigator.clipboard?.writeText(url);
        alert("Profile link copied!");
      }
    }

    // ---------- Trending Tags ----------
    async function loadTrendingTags() {
      try {
        const { data, error } = await sb
          .from("trending_tags")
          .select("*")
          .order("post_count", { ascending: false })
          .limit(10);
        
        if (error) {
          log('Load trending error', error);
          document.getElementById("trending-tags").innerHTML = '<div style="font-size:0.8rem;color:#6b7280;">Failed to load trending</div>';
          return;
        }
        
        if (!data || !data.length) {
          document.getElementById("trending-tags").innerHTML = '<div style="font-size:0.8rem;color:#6b7280;">No trending topics yet</div>';
          return;
        }

        const html = data.map(t => `
          <div class="trending-tag" onclick="filterByTag('${escapeHtml(t.tag)}')">
            ${escapeHtml(t.tag)}
            <span class="trending-count">${t.post_count}</span>
          </div>
        `).join("");
        
        document.getElementById("trending-tags").innerHTML = html;
        log('Trending tags loaded', data.length);
      } catch (error) {
        log('Trending tags error', error);
        document.getElementById("trending-tags").innerHTML = '<div style="font-size:0.8rem;color:#6b7280;">Error loading trending</div>';
      }
    }

    function filterByTag(tag) {
      activeFilter = tag;
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      loadFeed("smart");
      document.getElementById("feed-container").scrollIntoView({ behavior: "smooth" });
    }

    // ---------- Media handling ----------
    function handleMedia() {
      const input = document.getElementById("media-file");
      const file = input.files[0];
      selectedMediaFile = null;
      const prev = document.getElementById("creator-media-preview");
      prev.innerHTML = "";
      if (!file) return;
      selectedMediaFile = file;
      const url = URL.createObjectURL(file);
      if (file.type.startsWith("image/")) {
        prev.innerHTML = `<img src="${url}" alt="preview" />`;
      } else if (file.type.startsWith("video/")) {
        prev.innerHTML = `<video src="${url}" controls></video>`;
      }
    }

    function handlePostKindChange() {
      const kind = document.getElementById("post-kind").value;
      const pollDiv = document.getElementById("poll-inputs");
      if (kind === "poll") pollDiv.classList.remove("hidden");
      else pollDiv.classList.add("hidden");
    }

    function extractHashTags(text) {
      const matches = text.match(/#[\p{L}0-9_]+/gu) || [];
      return matches;
    }

    // ---------- Create post ----------
    async function createPost() {
      if (!currentUser) return;
      
      const postBtn = document.getElementById("post-btn");
      postBtn.disabled = true;
      postBtn.innerText = "Posting...";
      
      try {
        const content = document.getElementById("post-content").value.trim();
        const kind = document.getElementById("post-kind").value;
        
        if (!content && !selectedMediaFile) { 
          alert("Write something or attach media."); 
          postBtn.disabled = false;
          postBtn.innerText = "Post";
          return; 
        }

        let mediaUrl = null;
        let mediaType = null;
        
        if (selectedMediaFile) {
          const path = `${currentUser.id}_${Date.now()}_${selectedMediaFile.name}`;
          log('Uploading media', path);
          const { error: upErr } = await sb.storage.from("media").upload(path, selectedMediaFile, { upsert: false });
          if (upErr) { 
            log('Media upload error', upErr);
            alert(upErr.message); 
            postBtn.disabled = false;
            postBtn.innerText = "Post";
            return; 
          }
          const { data: urlData } = sb.storage.from("media").getPublicUrl(path);
          mediaUrl = urlData.publicUrl;
          mediaType = selectedMediaFile.type.startsWith("video/") ? "video" : "image";
          log('Media uploaded', mediaUrl);
        }

        let poll_question = null;
        let poll_options = null;
        
        if (kind === "poll") {
          const opt1 = document.getElementById("poll-opt-1").value.trim();
          const opt2 = document.getElementById("poll-opt-2").value.trim();
          if (!opt1 || !opt2) { 
            alert("Poll needs at least 2 options."); 
            postBtn.disabled = false;
            postBtn.innerText = "Post";
            return; 
          }
          poll_question = content || "Poll";
          poll_options = [opt1, opt2];
        }

        const tags = extractHashTags(content);
        log('Creating post', { content, mediaType, tags });
        
        const { data: newPost, error } = await sb.from("posts").insert({
          user_id: currentUser.id,
          content,
          media_url: mediaUrl,
          media_type: mediaType,
          tags,
          poll_question,
          poll_options
        }).select().single();
        
        if (error) { 
          log('Post creation error', error);
          alert(error.message); 
          postBtn.disabled = false;
          postBtn.innerText = "Post";
          return; 
        }

        log('Post created successfully', newPost);

        // Clear form
        document.getElementById("post-content").value = "";
        document.getElementById("creator-media-preview").innerHTML = "";
        document.getElementById("poll-opt-1").value = "";
        document.getElementById("poll-opt-2").value = "";
        selectedMediaFile = null;
        document.getElementById("media-file").value = "";
        
        // Reset button
        postBtn.disabled = false;
        postBtn.innerText = "Post";
        
        // Reload everything
        log('Refreshing feed after post creation');
        await Promise.all([
          loadFeed("smart"),
          loadMyPosts(),
          loadStoriesBar(),
          loadTrendingTags(),
          checkAlarms()
        ]);
        
        // Scroll to top of feed
        document.getElementById("feed-container").scrollIntoView({ behavior: "smooth", block: "start" });
        
      } catch (error) {
        log('Create post error', error);
        alert('Failed to create post. Please try again.');
        postBtn.disabled = false;
        postBtn.innerText = "Post";
      }
    }

    // ---------- Ranking & filtering ----------
    function computeScore(post) {
      const likes = post.likes_count || 0;
      const dislikes = post.dislikes_count || 0;
      const engagement = likes * 3 - dislikes;
      const ageHours = (Date.now() - new Date(post.created_at).getTime()) / 3600000;
      const recencyBoost = Math.max(24 - ageHours, 0);
      const reelBoost = post.media_type === "video" ? 3 : 0;
      return engagement + recencyBoost + reelBoost;
    }

    function passesFilter(post) {
      if (activeFilter === "all") return true;
      if (activeFilter === "reels") return post.media_type === "video";
      if (activeFilter === "polls") return Array.isArray(post.poll_options) && post.poll_options.length > 0;
      const tags = post.tags || [];
      return tags.includes(activeFilter);
    }

    async function loadFeed(mode = "smart") {
      const container = document.getElementById("feed-container");
      
      try {
        log('Loading feed', mode);
        container.innerHTML = '<div class="loading-msg">Loading posts...</div>';
        
        // FIX: Load posts and profiles separately, then join in JavaScript
        let { data: postsData, error: postsError } = await sb
          .from("posts")
          .select("*")
          .order("created_at", { ascending: false });
        
        if (postsError) { 
          log('Feed load error', postsError);
          container.innerHTML = '<div class="loading-msg">Error loading posts</div>';
          return; 
        }
        
        if (!postsData || !postsData.length) {
          container.innerHTML = '<div class="loading-msg">No posts yet. Be the first to post!</div>';
          return;
        }
        
        // Get unique user IDs
        const userIds = [...new Set(postsData.map(p => p.user_id))];
        
        // Load profiles
        const { data: profilesData, error: profilesError } = await sb
          .from("profiles")
          .select("*")
          .in("id", userIds);
        
        if (profilesError) {
          log('Profiles load error', profilesError);
        }
        
        // Create profiles map
        const profilesMap = {};
        if (profilesData) {
          profilesData.forEach(prof => {
            profilesMap[prof.id] = prof;
          });
        }
        
        // Attach profiles to posts
        const data = postsData.map(post => ({
          ...post,
          profiles: profilesMap[post.user_id] || null
        }));
        
        allPostsCache = data;
        log('Posts loaded', data.length);

        let posts = [...allPostsCache];
        if (mode === "smart") {
          posts = posts.sort((a, b) => computeScore(b) - computeScore(a));
        } else {
          posts = posts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        }

        container.innerHTML = "";
        
        posts.forEach(p => {
          if (!passesFilter(p)) return;

          const prof = p.profiles || {};
          let avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(prof.full_name || "")}`;
          if (prof.avatar_url) {
            const { data: urlData } = sb.storage.from("avatars").getPublicUrl(prof.avatar_url);
            if (urlData?.publicUrl) avatar = urlData.publicUrl;
          }

          const isChild = prof.is_child;
          const tagsHtml = (p.tags || []).map(t => 
            `<span class="tag-pill" onclick="filterByTag('${escapeHtml(t)}')">${escapeHtml(t)}</span>`
          ).join("");

          let mediaHtml = "";
          if (p.media_url) {
            const isVideo = p.media_type === "video";
            const mediaTag = isVideo
              ? `<video src="${p.media_url}" controls playsinline></video>`
              : `<img src="${p.media_url}" alt="media" />`;
            mediaHtml = `
              <div class="media-wrapper" ondblclick="doubleTapLike('${p.id}')">
                ${mediaTag}
                <div class="heart-burst"><i class="bi bi-heart-fill"></i></div>
              </div>`;
          }

          let pollHtml = "";
          if (p.poll_options && p.poll_options.length) {
            pollHtml = `<div class="poll-options">` +
              p.poll_options.map((opt, idx) =>
                `<button class="poll-btn" onclick="votePoll('${p.id}', ${idx})">${escapeHtml(opt)}</button>`
              ).join("") +
              `</div>`;
          }

          const solvedBadge = p.is_solved ? '<span class="solved-badge">SOLVED</span>' : "";
          const isOwner = currentUser && p.user_id === currentUser.id;
          const likesCount = p.likes_count || 0;

          const likesLine = likesCount
            ? `<div class="likes-line">${likesCount === 1 ? '1 like' : likesCount + ' likes'}</div>`
            : "";

          container.innerHTML += `
            <div class="post-card" data-post-id="${p.id}">
              <div class="post-header">
                <img src="${avatar}" class="avatar-xs" alt="avatar" />
                <div>
                  <div style="font-weight:600;font-size:0.9rem;">${escapeHtml(prof.full_name || "User")}</div>
                  <div style="font-size:0.75rem;color:#6b7280;">@${escapeHtml(prof.username || "user")}</div>
                </div>
                ${isChild ? '<span class="child-badge">CHILD TALKIE</span>' : ""}
                ${solvedBadge}
                <button onclick="quickDM('${p.user_id}')" title="Quick DM" style="margin-left:auto;padding:4px;border:none;background:transparent;cursor:pointer;">
                  <i class="bi bi-chat-dots" style="font-size:1rem;color:#6b7280;"></i>
                </button>
              </div>
              <div class="post-body">
                ${p.content ? `<div>${escapeHtml(p.content)}</div>` : ""}
                ${p.poll_question ? `<div style="font-weight:600;margin-top:6px;">${escapeHtml(p.poll_question)}</div>` : ""}
                ${tagsHtml ? `<div class="tag-strip">${tagsHtml}</div>` : ""}
                ${mediaHtml}
                ${pollHtml}
                <div class="post-actions">
                  <span onclick="toggleLike('${p.id}')"><i class="bi bi-heart"></i> ${likesCount || 0}</span>
                  <span onclick="toggleDislike('${p.id}')"><i class="bi bi-hand-thumbs-down"></i> ${p.dislikes_count || 0}</span>
                  <span onclick="toggleBookmark('${p.id}')"><i class="bi bi-bookmark"></i></span>
                  <span onclick="reportPost('${p.id}')"><i class="bi bi-flag"></i></span>
                  ${isOwner ? `<span onclick="markSolved('${p.id}')" style="color:#16a34a;"><i class="bi bi-check-circle${p.is_solved ? '-fill' : ''}"></i></span>` : ""}
                </div>
                ${likesLine}
              </div>
            </div>`;
        });
        
        if (container.innerHTML === "") {
          container.innerHTML = '<div class="loading-msg">No posts match this filter</div>';
        }
        
        log('Feed rendered successfully');
      } catch (error) {
        log('Load feed error', error);
        container.innerHTML = '<div class="loading-msg">Error loading posts</div>';
      }
    }

    // ---------- Stories/Reels bar ----------
    async function loadStoriesBar() {
      try {
        // FIX: Load separately and join in JS
        const { data: recentReels, error } = await sb
          .from("posts")
          .select("*")
          .eq("media_type", "video")
          .order("created_at", { ascending: false })
          .limit(12);
        
        if (error) {
          log('Stories load error', error);
          document.getElementById("stories-row").innerHTML = "";
          return;
        }
        
        if (!recentReels || !recentReels.length) {
          document.getElementById("stories-row").innerHTML = "";
          return;
        }

        // Get user IDs
        const userIds = [...new Set(recentReels.map(p => p.user_id))];
        
        // Load profiles
        const { data: profilesData } = await sb
          .from("profiles")
          .select("*")
          .in("id", userIds);
        
        const profilesMap = {};
        if (profilesData) {
          profilesData.forEach(prof => {
            profilesMap[prof.id] = prof;
          });
        }

        const html = recentReels.map(post => {
          const prof = profilesMap[post.user_id] || {};
          let avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(prof.full_name || "")}`;
          if (prof.avatar_url) {
            const { data: urlData } = sb.storage.from("avatars").getPublicUrl(prof.avatar_url);
            if (urlData?.publicUrl) avatar = urlData.publicUrl;
          }
          return `
            <div class="story-bubble" onclick="openStory('${post.media_url}', '${escapeHtml(prof.full_name || "User")}')">
              <div class="story-ring">
                <img src="${avatar}" class="story-avatar" alt="story" />
              </div>
              <div class="story-name">${escapeHtml(prof.full_name || "User")}</div>
            </div>`;
        }).join("");
        document.getElementById("stories-row").innerHTML = html;
        log('Stories loaded', recentReels.length);
      } catch (error) {
        log('Stories error', error);
        document.getElementById("stories-row").innerHTML = "";
      }
    }

    function openStory(videoUrl, username) {
      document.getElementById("story-video").src = videoUrl;
      document.getElementById("story-username").innerText = username;
      document.getElementById("story-modal").classList.remove("hidden");
    }

    function closeStoryModal() {
      document.getElementById("story-modal").classList.add("hidden");
      document.getElementById("story-video").pause();
    }

    // ---------- Interactions ----------
    async function doubleTapLike(postId) {
      const card = document.querySelector(`[data-post-id="${postId}"]`);
      if (!card) return;
      const heart = card.querySelector(".heart-burst");
      heart.classList.add("active");
      setTimeout(() => heart.classList.remove("active"), 600);
      await toggleLike(postId, true);
    }

    async function toggleLike(postId, force = false) {
      try {
        const { data: existing } = await sb
          .from("likes")
          .select("*")
          .eq("post_id", postId)
          .eq("user_id", currentUser.id)
          .single();

        if (existing) {
          await sb.from("likes").delete().eq("post_id", postId).eq("user_id", currentUser.id);
          log('Like removed', postId);
        } else {
          await sb.from("likes").insert({ post_id: postId, user_id: currentUser.id });
          log('Like added', postId);
        }
        
        await loadFeed("smart");
      } catch (error) {
        log('Toggle like error', error);
      }
    }

    async function toggleDislike(postId) {
      try {
        const { data: existing } = await sb
          .from("dislikes")
          .select("*")
          .eq("post_id", postId)
          .eq("user_id", currentUser.id)
          .single();

        if (existing) {
          await sb.from("dislikes").delete().eq("post_id", postId).eq("user_id", currentUser.id);
        } else {
          await sb.from("dislikes").insert({ post_id: postId, user_id: currentUser.id });
        }
        
        await loadFeed("smart");
      } catch (error) {
        log('Toggle dislike error', error);
      }
    }

    async function toggleBookmark(postId) {
      try {
        const { data: existing } = await sb
          .from("bookmarks")
          .select("*")
          .eq("post_id", postId)
          .eq("user_id", currentUser.id)
          .single();

        if (existing) {
          await sb.from("bookmarks").delete().eq("post_id", postId).eq("user_id", currentUser.id);
        } else {
          await sb.from("bookmarks").insert({ post_id: postId, user_id: currentUser.id });
        }
        
        await loadFeed("smart");
      } catch (error) {
        log('Toggle bookmark error', error);
      }
    }

    async function votePoll(postId, optionIndex) {
      try {
        const { error } = await sb.from("poll_votes").upsert({
          post_id: postId,
          user_id: currentUser.id,
          option_index: optionIndex
        }, { onConflict: "post_id,user_id" });
        if (error) {
          log('Vote poll error', error);
          alert(error.message);
        }
        await loadFeed("smart");
      } catch (error) {
        log('Vote poll error', error);
      }
    }

    async function markSolved(postId) {
      try {
        const { error } = await sb.from("posts").update({ is_solved: true }).eq("id", postId).eq("user_id", currentUser.id);
        if (error) {
          log('Mark solved error', error);
          alert(error.message);
        }
        await loadFeed("smart");
      } catch (error) {
        log('Mark solved error', error);
      }
    }

    async function reportPost(postId) {
      try {
        const { error } = await sb.from("reports").insert({
          post_id: postId,
          user_id: currentUser.id,
          reason: "User reported content"
        });
        if (error) {
          log('Report error', error);
          alert(error.message);
        } else {
          alert("Reported. Thanks for keeping community clean!");
        }
      } catch (error) {
        log('Report error', error);
      }
    }

    function scrollToPost(postId) {
      switchTab(document.querySelector("[data-tab='feed']"));
      setTimeout(() => {
        const card = document.querySelector(`[data-post-id="${postId}"]`);
        if (card) card.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 300);
    }

    // ---------- Filters ----------
    function applyFilter(chip) {
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      activeFilter = chip.dataset.filter;
      loadFeed("smart");
    }

    // ---------- Navigation ----------
    function switchTab(item) {
      document.querySelectorAll(".nav-item").forEach(i => i.classList.remove("active"));
      item.classList.add("active");
      document.querySelectorAll(".view").forEach(v => v.classList.add("hidden"));
      document.getElementById(item.dataset.tab + "-view").classList.remove("hidden");
      
      if (item.dataset.tab === "feed") {
        loadFeed("smart");
        loadStoriesBar();
        loadTrendingTags();
      } else if (item.dataset.tab === "profile") {
        loadProfileIntoUI();
      }
    }

    async function showHotFeed() {
      activeFilter = "all";
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      document.querySelector("[data-filter='all']")?.classList.add("active");
      loadFeed("hot");
    }

    // ---------- Users & Chat ----------
    async function searchUsers() {
      const query = document.getElementById("user-search-input").value.trim();
      if (!query) return;
      
      try {
        const { data, error } = await sb
          .from("profiles")
          .select("*")
          .or(`full_name.ilike.%${query}%,username.ilike.%${query}%`)
          .neq("id", currentUser.id)
          .limit(20);
        
        if (error) {
          log('Search users error', error);
          document.getElementById("user-search-results").innerHTML = "Error searching.";
          return;
        }
        
        if (!data || !data.length) {
          document.getElementById("user-search-results").innerHTML = "<div>No users found.</div>";
          return;
        }
        
        const html = data.map(prof => {
          let avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(prof.full_name || "")}`;
          if (prof.avatar_url) {
            const { data: urlData } = sb.storage.from("avatars").getPublicUrl(prof.avatar_url);
            if (urlData?.publicUrl) avatar = urlData.publicUrl;
          }
          return `
            <div class="user-item">
              <img src="${avatar}" class="avatar-xs" />
              <div style="flex:1;">
                <div style="font-weight:600;">${escapeHtml(prof.full_name)}</div>
                <div style="font-size:0.8rem;color:#6b7280;">@${escapeHtml(prof.username || "user")}</div>
              </div>
              <button onclick="startChat('${prof.id}')">Message</button>
            </div>`;
        }).join("");
        document.getElementById("user-search-results").innerHTML = html;
      } catch (error) {
        log('Search users error', error);
        document.getElementById("user-search-results").innerHTML = "Error searching.";
      }
    }

    function quickDM(userId) {
      startChat(userId);
      setTimeout(() => {
        switchTab(document.querySelector("[data-tab='chat']"));
      }, 100);
    }

    async function startChat(userId) {
      try {
        const { data: prof } = await sb.from("profiles").select("*").eq("id", userId).single();
        if (!prof) return;
        
        let avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(prof.full_name || "")}`;
        if (prof.avatar_url) {
          const { data: urlData } = sb.storage.from("avatars").getPublicUrl(prof.avatar_url);
          if (urlData?.publicUrl) avatar = urlData.publicUrl;
        }
        
        document.getElementById("chat-avatar").src = avatar;
        document.getElementById("chat-name").innerText = prof.full_name;
        document.getElementById("chat-username").innerText = prof.username ? "@"+prof.username : "";
        document.getElementById("chat-empty").classList.add("hidden");
        document.getElementById("chat-panel").classList.remove("hidden");
        activeChatUser = userId;
        
        await loadChatMessages();
      } catch (error) {
        log('Start chat error', error);
      }
    }

    async function loadChatMessages() {
      if (!activeChatUser) return;
      try {
        const { data, error } = await sb
          .from("direct_messages")
          .select("*")
          .or(`and(from_user_id.eq.${currentUser.id},to_user_id.eq.${activeChatUser}),and(from_user_id.eq.${activeChatUser},to_user_id.eq.${currentUser.id})`)
          .order("created_at", { ascending: true });
        
        if (error) {
          log('Load messages error', error);
          return;
        }
        
        const messagesEl = document.getElementById("chat-messages");
        messagesEl.innerHTML = data.map(msg => {
          const isMe = msg.from_user_id === currentUser.id;
          return `<div class="bubble ${isMe ? 'me' : 'them'}">
            ${escapeHtml(msg.content)}
          </div>`;
        }).join("");
        messagesEl.scrollTop = messagesEl.scrollHeight;
      } catch (error) {
        log('Load chat error', error);
      }
    }

    async function sendMessage() {
      const content = document.getElementById("chat-input").value.trim();
      if (!content || !activeChatUser) return;
      
      try {
        const { error } = await sb.from("direct_messages").insert({
          from_user_id: currentUser.id,
          to_user_id: activeChatUser,
          content
        });
        
        if (!error) {
          document.getElementById("chat-input").value = "";
          await loadChatMessages();
        } else {
          log('Send message error', error);
        }
      } catch (error) {
        log('Send message error', error);
      }
    }

    // ---------- Alarms/Notifications ----------
    async function checkAlarms() {
      try {
        const { data: recent } = await sb
          .from("posts")
          .select("id")
          .gt("created_at", new Date(Date.now() - 5*60*1000).toISOString())
          .limit(1);
        const dot = document.getElementById("alarm-dot");
        dot?.classList.toggle("hidden", !recent?.length);
      } catch (error) {
        log('Check alarms error', error);
      }
    }

    // Event listeners
    document.getElementById("chat-input")?.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });
    document.getElementById("post-content")?.addEventListener("keypress", e => {
      if (e.key === "Enter" && e.ctrlKey) createPost();
    });
    document.getElementById("user-search-input")?.addEventListener("keypress", e => {
      if (e.key === "Enter") searchUsers();
    });

    // Auto-refresh
    setInterval(() => {
      if (document.visibilityState === "visible") {
        loadFeed("smart");
        loadStoriesBar();
        loadTrendingTags();
        checkAlarms();
      }
    }, 30000);
  </script>
</body>
</html>
