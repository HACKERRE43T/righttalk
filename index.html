<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Right Talk - Complete Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.1/picker.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.18.1/index.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #06b6d4;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #1e293b;
      --gray: #64748b;
      --light: #f8fafc;
      --border: #e2e8f0;
    }
    
    body { 
      font-family: 'Inter', sans-serif; 
      background: var(--light);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }
    
    .hidden { display: none !important; }
    button { font-family: inherit; }
    
    /* AUTH */
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    
    .auth-box {
      width: 100%;
      max-width: 420px;
      background: white;
      border-radius: 24px;
      padding: 40px 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .logo-auth {
      font-size: 2.8rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-align: center;
      margin-bottom: 12px;
    }
    
    .tagline {
      text-align: center;
      color: var(--gray);
      font-size: 1rem;
      margin-bottom: 32px;
      font-weight: 500;
    }
    
    .input-group { margin-bottom: 20px; }
    
    .input-label {
      display: block;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .input-field {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s;
      font-family: inherit;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59,130,246,0.1);
    }
    
    .btn-primary {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1.05rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 8px 20px rgba(59,130,246,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(59,130,246,0.5);
    }
    
    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      width: 100%;
      padding: 14px;
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.3s;
    }
    
    .error-msg {
      background: #fee2e2;
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.9rem;
      margin-top: 16px;
      display: none;
      border-left: 4px solid var(--danger);
    }
    
    .error-msg.show { display: block; }
    
    /* ONBOARDING - Same as before */
    .onboarding-container {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .onboarding-card {
      width: 100%;
      max-width: 520px;
      background: white;
      border-radius: 24px;
      padding: 40px 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .onboarding-step { display: none; }
    .onboarding-step.active { display: block; }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }
    
    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.4s;
    }
    
    .step-dot.active {
      width: 36px;
      border-radius: 5px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    
    .step-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--dark);
      margin-bottom: 8px;
    }
    
    .step-subtitle {
      color: var(--gray);
      margin-bottom: 28px;
      font-size: 1.05rem;
    }
    
    .avatar-upload {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      border: 3px dashed var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 28px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
      background: var(--light);
    }
    
    .avatar-upload:hover {
      border-color: var(--primary);
      transform: scale(1.05);
    }
    
    .avatar-upload img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .avatar-upload i {
      font-size: 2.5rem;
      color: var(--gray);
    }
    
    .textarea-field {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      resize: vertical;
      min-height: 110px;
      transition: all 0.3s;
    }
    
    .textarea-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59,130,246,0.1);
    }
    
    .interest-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 20px;
    }
    
    .interest-btn {
      padding: 14px 12px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      text-align: center;
    }
    
    .interest-btn:hover {
      border-color: var(--primary);
    }
    
    .interest-btn.selected {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-color: var(--primary);
    }
    
    .btn-row {
      display: flex;
      gap: 12px;
      margin-top: 28px;
    }
    
    .btn-back {
      flex: 1;
      padding: 14px;
      background: var(--light);
      border: 2px solid var(--border);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-next {
      flex: 2;
      padding: 14px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(59,130,246,0.4);
    }
    
    /* MAIN APP */
    .app-container {
      max-width: 430px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      position: relative;
      box-shadow: 0 0 50px rgba(0,0,0,0.1);
    }
    
    .top-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(20px);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }
    
    .logo-small {
      font-size: 1.6rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
    }
    
    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--light);
      color: var(--gray);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .icon-btn:hover {
      background: var(--border);
      transform: scale(1.08);
      color: var(--primary);
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px;
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      padding: 10px 8px 8px;
      display: flex;
      z-index: 100;
    }
    
    .nav-btn {
      flex: 1;
      padding: 8px 6px;
      text-align: center;
      color: var(--gray);
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 14px;
      margin: 0 2px;
    }
    
    .nav-btn i {
      display: block;
      font-size: 1.5rem;
      margin-bottom: 4px;
    }
    
    .nav-btn span {
      font-size: 0.72rem;
      font-weight: 600;
    }
    
    .nav-btn.active {
      color: var(--primary);
      background: rgba(59,130,246,0.1);
    }
    
    /* STORIES */
    .stories-bar {
      display: flex;
      gap: 14px;
      padding: 16px;
      overflow-x: auto;
      background: white;
      border-bottom: 1px solid var(--border);
    }
    
    .stories-bar::-webkit-scrollbar { display: none; }
    
    .story-item {
      flex-shrink: 0;
      width: 72px;
      text-align: center;
      cursor: pointer;
      position: relative;
    }
    
    .story-ring {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      padding: 3px;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      margin: 0 auto 8px;
      position: relative;
    }
    
    .story-ring.add-story {
      background: var(--border);
    }
    
    .story-avatar {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid white;
      object-fit: cover;
    }
    
    .add-story-icon {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 24px;
      height: 24px;
      background: var(--primary);
      border-radius: 50%;
      border: 3px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.9rem;
    }
    
    .story-name {
      font-size: 0.72rem;
      color: var(--dark);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
    }
    
    /* STORY VIEWER */
    .story-viewer {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 300;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .story-content {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    .story-media {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .story-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10;
    }
    
    .story-progress {
      position: absolute;
      top: 10px;
      left: 20px;
      right: 20px;
      height: 3px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .story-progress-bar {
      height: 100%;
      background: white;
      width: 0%;
      transition: width 0.1s linear;
    }
    
    .story-user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    
    .story-user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid white;
    }
    
    .story-user-name {
      color: white;
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .story-time {
      color: rgba(255,255,255,0.8);
      font-size: 0.8rem;
    }
    
    .story-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }
    
    /* FEED - POST CARD */
    .feed-container {
      padding-bottom: 85px;
      background: var(--light);
    }
    
    .post-card {
      background: white;
      margin: 0 0 10px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .post-header {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .post-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--light);
    }
    
    .post-info {
      flex: 1;
      min-width: 0;
    }
    
    .post-author {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--dark);
    }
    
    .post-meta {
      font-size: 0.78rem;
      color: var(--gray);
    }
    
    .post-options {
      color: var(--gray);
      font-size: 1.3rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .post-options:hover {
      background: var(--light);
    }
    
    .post-content {
      padding: 0 16px 14px;
      line-height: 1.6;
      color: var(--dark);
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .post-media {
      width: 100%;
      max-height: 550px;
      background: #000;
      position: relative;
    }
    
    .post-media img,
    .post-media video {
      width: 100%;
      max-height: 550px;
      object-fit: contain;
      display: block;
    }
    
    .double-tap-zone {
      position: absolute;
      inset: 0;
      cursor: pointer;
    }
    
    .heart-burst {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 6rem;
      color: white;
      opacity: 0;
      pointer-events: none;
      text-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    
    .heart-burst.show {
      animation: heartPop 0.8s ease-out;
    }
    
    @keyframes heartPop {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.4); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
    }
    
    .post-actions {
      padding: 10px 12px;
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .action-btn {
      background: none;
      border: none;
      color: var(--dark);
      font-size: 1.6rem;
      cursor: pointer;
      transition: all 0.2s;
      padding: 6px;
      border-radius: 50%;
    }
    
    .action-btn:hover {
      transform: scale(1.12);
      background: var(--light);
    }
    
    .action-btn.liked {
      color: var(--danger);
    }
    
    .action-btn.bookmarked {
      color: var(--primary);
    }
    
    .post-likes {
      padding: 0 16px 10px;
      font-size: 0.92rem;
      font-weight: 700;
      color: var(--dark);
    }
    
    .post-tags {
      padding: 0 16px 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .tag {
      color: var(--primary);
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
    }
    
    .post-timestamp {
      padding: 0 16px 14px;
      font-size: 0.75rem;
      color: var(--gray);
    }
    
    /* POST OPTIONS MENU */
    .options-menu {
      position: absolute;
      right: 16px;
      top: 50px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      overflow: hidden;
      z-index: 200;
      min-width: 200px;
    }
    
    .menu-item {
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
      color: var(--dark);
      border-bottom: 1px solid var(--border);
    }
    
    .menu-item:last-child {
      border-bottom: none;
    }
    
    .menu-item:hover {
      background: var(--light);
    }
    
    .menu-item.danger {
      color: var(--danger);
    }
    
    .menu-item i {
      font-size: 1.2rem;
    }
    
    /* CHATS */
    .chats-container {
      padding-bottom: 85px;
    }
    
    .chat-list {
      background: white;
    }
    
    .chat-item {
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .chat-item:hover {
      background: var(--light);
    }
    
    .chat-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    
    .chat-name {
      font-weight: 700;
      font-size: 0.98rem;
      color: var(--dark);
      margin-bottom: 4px;
    }
    
    .chat-last-message {
      font-size: 0.88rem;
      color: var(--gray);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .chat-time {
      font-size: 0.78rem;
      color: var(--gray);
      flex-shrink: 0;
    }
    
    .unread-badge {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* CHAT WINDOW */
    .chat-window {
      position: fixed;
      inset: 0;
      background: white;
      z-index: 250;
      display: flex;
      flex-direction: column;
    }
    
    .chat-header {
      padding: 14px 18px;
      background: white;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .chat-back-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--light);
      color: var(--dark);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    
    .chat-header-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: var(--light);
    }
    
    .message-item {
      display: flex;
      margin-bottom: 16px;
      gap: 10px;
    }
    
    .message-item.own {
      flex-direction: row-reverse;
    }
    
    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .message-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 18px;
      background: white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .message-item.own .message-bubble {
      background: var(--primary);
      color: white;
    }
    
    .message-text {
      font-size: 0.95rem;
      line-height: 1.4;
      word-wrap: break-word;
    }
    
    .message-image {
      max-width: 250px;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .message-image img {
      width: 100%;
      display: block;
    }
    
    .message-voice {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .voice-play-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .voice-waveform {
      flex: 1;
      height: 30px;
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
    }
    
    .message-location {
      width: 250px;
      height: 150px;
      border-radius: 12px;
      background: var(--light);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .message-location i {
      font-size: 2rem;
      color: var(--danger);
    }
    
    .location-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--dark);
    }
    
    .message-time {
      font-size: 0.7rem;
      color: var(--gray);
      margin-top: 4px;
    }
    
    /* CHAT INPUT */
    .chat-input-container {
      padding: 12px 16px;
      background: white;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chat-input-actions {
      display: flex;
      gap: 8px;
    }
    
    .chat-action-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--light);
      color: var(--gray);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    
    .chat-action-btn:hover {
      background: var(--border);
      color: var(--primary);
    }
    
    .chat-input-wrapper {
      flex: 1;
      position: relative;
    }
    
    .chat-input {
      width: 100%;
      padding: 10px 42px 10px 16px;
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--light);
    }
    
    .chat-input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
    }
    
    .emoji-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      font-size: 1.3rem;
      cursor: pointer;
    }
    
    .chat-send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: all 0.2s;
    }
    
    .chat-send-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }
    
    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* EMOJI PICKER */
    .emoji-picker-container {
      position: absolute;
      bottom: 60px;
      right: 16px;
      z-index: 300;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      border-radius: 12px;
      overflow: hidden;
    }
    
    /* GIF PICKER */
    .gif-picker {
      position: absolute;
      bottom: 60px;
      left: 16px;
      right: 16px;
      max-height: 300px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 300;
      overflow: hidden;
    }
    
    .gif-search {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .gif-search input {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 0.9rem;
    }
    
    .gif-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      padding: 8px;
      max-height: 220px;
      overflow-y: auto;
    }
    
    .gif-item {
      aspect-ratio: 1;
      cursor: pointer;
      overflow: hidden;
      border-radius: 8px;
    }
    
    .gif-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* VOICE RECORDER */
    .voice-recorder {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 20px;
      padding: 20px 30px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      z-index: 300;
    }
    
    .recording-indicator {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--danger);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.8rem;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .recording-time {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
    }
    
    .recording-actions {
      display: flex;
      gap: 16px;
    }
    
    .recording-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      transition: all 0.2s;
    }
    
    .recording-cancel {
      background: var(--light);
      color: var(--gray);
    }
    
    .recording-send {
      background: var(--primary);
      color: white;
    }
    
    /* CREATE POST */
    .create-post-btn {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 62px;
      height: 62px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(59,130,246,0.5);
      transition: all 0.3s;
      z-index: 90;
    }
    
    .create-post-btn:hover {
      transform: scale(1.12) rotate(90deg);
    }
    
    /* MODAL */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      max-width: 520px;
      width: 100%;
      max-height: 92vh;
      overflow-y: auto;
      padding: 28px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .modal-title {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--dark);
    }
    
    .modal-close {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      background: var(--light);
      font-size: 1.3rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-close:hover {
      background: var(--border);
      transform: rotate(90deg);
    }
    
    .post-type-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 22px;
    }
    
    .type-btn {
      padding: 16px 10px;
      border: 2px solid var(--border);
      border-radius: 14px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .type-btn i {
      display: block;
      font-size: 1.6rem;
      margin-bottom: 8px;
      color: var(--gray);
    }
    
    .type-btn span {
      font-size: 0.82rem;
      color: var(--gray);
      font-weight: 600;
    }
    
    .type-btn.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-color: var(--primary);
    }
    
    .type-btn.active i,
    .type-btn.active span {
      color: white;
    }
    
    .media-upload-zone {
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 50px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 18px;
      background: var(--light);
    }
    
    .media-upload-zone:hover {
      border-color: var(--primary);
    }
    
    .media-preview {
      margin-bottom: 18px;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      background: #000;
    }
    
    .media-preview img,
    .media-preview video {
      width: 100%;
      max-height: 420px;
      object-fit: contain;
    }
    
    .remove-media {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0,0,0,0.8);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1.3rem;
    }
    
    .remove-media:hover {
      background: var(--danger);
    }
    
    /* COMMENTS */
    .comments-section {
      padding: 16px;
      border-top: 1px solid var(--border);
      background: var(--light);
    }
    
    .comment-input-area {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .comment-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .comment-input-wrapper {
      flex: 1;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .comment-input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 0.9rem;
      font-family: inherit;
      background: white;
    }
    
    .comment-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .comment-send-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .comment-send-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }
    
    .comments-list {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .comment-item {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      padding: 10px;
      background: white;
      border-radius: 12px;
    }
    
    .comment-content {
      flex: 1;
    }
    
    .comment-author {
      font-weight: 700;
      font-size: 0.88rem;
      color: var(--dark);
      margin-bottom: 4px;
    }
    
    .comment-text {
      font-size: 0.88rem;
      color: var(--dark);
      line-height: 1.5;
    }
    
    .comment-time {
      font-size: 0.72rem;
      color: var(--gray);
      margin-top: 4px;
    }
    
    /* PROFILE */
    .profile-header {
      padding: 0 0 20px 0;
      text-align: center;
      background: white;
      border-bottom: 1px solid var(--border);
    }
    
    .profile-cover {
      width: 100%;
      height: 160px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    
    .profile-avatar-lg {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      border: 5px solid white;
      object-fit: cover;
      margin: -55px auto 18px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }
    
    .profile-name {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--dark);
      margin-bottom: 4px;
    }
    
    .profile-username {
      color: var(--gray);
      margin-bottom: 14px;
      font-size: 1.05rem;
    }
    
    .profile-bio {
      color: var(--dark);
      line-height: 1.6;
      margin-bottom: 18px;
      padding: 0 20px;
    }
    
    .profile-stats {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 24px 0;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--dark);
    }
    
    .stat-label {
      font-size: 0.82rem;
      color: var(--gray);
      font-weight: 600;
    }
    
    .profile-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
      padding: 0 20px;
    }
    
    .btn-edit {
      padding: 11px 28px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .profile-tabs {
      display: flex;
      background: white;
      border-bottom: 1px solid var(--border);
    }
    
    .tab-btn {
      flex: 1;
      padding: 18px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: 700;
      color: var(--gray);
      transition: all 0.3s;
    }
    
    .tab-btn.active {
      color: var(--dark);
      border-bottom-color: var(--primary);
    }
    
    .posts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      background: var(--light);
    }
    
    .grid-item {
      aspect-ratio: 1;
      background: var(--border);
      overflow: hidden;
      cursor: pointer;
    }
    
    .grid-item img,
    .grid-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* LOADING & TOAST */
    .loading {
      text-align: center;
      padding: 50px 20px;
      color: var(--gray);
    }
    
    .spinner {
      width: 44px;
      height: 44px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 18px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      bottom: 110px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(30,41,59,0.95);
      color: white;
      padding: 14px 26px;
      border-radius: 14px;
      font-size: 0.92rem;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      z-index: 10000;
      opacity: 0;
      transition: all 0.3s;
      max-width: 340px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    .empty-state {
      text-align: center;
      padding: 70px 24px;
      color: var(--gray);
    }
    
    .empty-icon {
      font-size: 4.5rem;
      color: var(--border);
      margin-bottom: 20px;
    }
    
    .empty-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- AUTH -->
  <div id="auth-screen" class="auth-container">
    <div class="auth-box">
      <div class="logo-auth">Right Talk</div>
      <div class="tagline">Raise Your Voice ‚Ä¢ Create Change</div>
      
      <div class="input-group">
        <label class="input-label">Email</label>
        <input id="auth-email" class="input-field" type="email" placeholder="your@email.com" />
      </div>
      
      <div class="input-group">
        <label class="input-label">Password</label>
        <input id="auth-password" class="input-field" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      
      <button class="btn-primary" id="btn-signin" onclick="handleSignIn()">
        <i class="bi bi-box-arrow-in-right"></i>
        <span>Sign In</span>
      </button>
      <button class="btn-secondary" onclick="handleSignUp()">Create Account</button>
      
      <div id="auth-error" class="error-msg"></div>
    </div>
  </div>

  <!-- ONBOARDING (Same as before, keeping it brief) -->
  <div id="onboarding-screen" class="onboarding-container hidden">
    <div class="onboarding-card">
      <div class="step-indicator">
        <div class="step-dot active"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
      </div>
      
      <div id="step-1" class="onboarding-step active">
        <h2 class="step-title">Welcome! üëã</h2>
        <p class="step-subtitle">Let's set up your profile</p>
        <div class="input-group">
          <label class="input-label">Full Name</label>
          <input id="onboard-name" class="input-field" type="text" placeholder="Your name" />
        </div>
        <div class="input-group">
          <label class="input-label">Username</label>
          <input id="onboard-username" class="input-field" type="text" placeholder="@username" />
        </div>
        <div class="btn-row">
          <button class="btn-next" onclick="nextStep()">Continue</button>
        </div>
      </div>
      
      <div id="step-2" class="onboarding-step">
        <h2 class="step-title">Profile Photo</h2>
        <p class="step-subtitle">Add a photo</p>
        <div class="avatar-upload" onclick="document.getElementById('avatar-file').click()">
          <img id="avatar-preview" style="display:none;" />
          <i class="bi bi-camera-fill" id="avatar-icon"></i>
        </div>
        <input id="avatar-file" type="file" accept="image/*" style="display:none;" onchange="handleAvatarSelect()" />
        <div class="btn-row">
          <button class="btn-back" onclick="prevStep()">Back</button>
          <button class="btn-next" onclick="nextStep()">Continue</button>
        </div>
      </div>
      
      <div id="step-3" class="onboarding-step">
        <h2 class="step-title">About You</h2>
        <p class="step-subtitle">Tell us about yourself</p>
        <div class="input-group">
          <label class="input-label">Bio</label>
          <textarea id="onboard-bio" class="textarea-field" placeholder="Your bio..."></textarea>
        </div>
        <div class="input-group">
          <label class="input-label">Date of Birth</label>
          <input id="onboard-dob" class="input-field" type="date" />
        </div>
        <div class="btn-row">
          <button class="btn-back" onclick="prevStep()">Back</button>
          <button class="btn-next" onclick="nextStep()">Continue</button>
        </div>
      </div>
      
      <div id="step-4" class="onboarding-step">
        <h2 class="step-title">Interests</h2>
        <p class="step-subtitle">What matters to you?</p>
        <div class="interest-grid">
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="education">üéì Education</div>
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="health">üè• Health</div>
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="environment">üåç Environment</div>
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="rights">‚öñÔ∏è Rights</div>
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="economy">üí∞ Economy</div>
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="technology">üíª Technology</div>
        </div>
        <div class="btn-row">
          <button class="btn-back" onclick="prevStep()">Back</button>
          <button class="btn-next" id="btn-complete" onclick="completeOnboarding()">Complete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="main-app" class="app-container hidden">
    <div class="top-header">
      <div class="logo-small">Right Talk</div>
      <div class="header-actions">
        <button class="icon-btn" onclick="switchView('chats')">
          <i class="bi bi-chat-dots-fill"></i>
        </button>
        <button class="icon-btn" onclick="showNotifications()">
          <i class="bi bi-bell-fill"></i>
        </button>
      </div>
    </div>

    <!-- FEED -->
    <div id="feed-view">
      <div class="stories-bar" id="stories-bar">
        <div class="story-item" onclick="openAddStory()">
          <div class="story-ring add-story">
            <img class="story-avatar" id="user-story-avatar" src="" />
            <div class="add-story-icon">
              <i class="bi bi-plus-lg"></i>
            </div>
          </div>
          <div class="story-name">Your Story</div>
        </div>
      </div>
      
      <div id="feed-container" class="feed-container">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading...</div>
        </div>
      </div>
    </div>

    <!-- CHATS -->
    <div id="chats-view" class="hidden chats-container">
      <div id="chats-list" class="chat-list">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading chats...</div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="profile-view" class="hidden">
      <div class="profile-header">
        <div class="profile-cover"></div>
        <img id="profile-avatar" class="profile-avatar-lg" src="" />
        <div class="profile-name" id="profile-name">Loading...</div>
        <div class="profile-username" id="profile-username">@username</div>
        <div class="profile-bio" id="profile-bio"></div>
        <div class="profile-stats">
          <div class="stat">
            <span class="stat-number" id="stat-posts">0</span>
            <span class="stat-label">Posts</span>
          </div>
          <div class="stat">
            <span class="stat-number" id="stat-followers">0</span>
            <span class="stat-label">Followers</span>
          </div>
          <div class="stat">
            <span class="stat-number" id="stat-following">0</span>
            <span class="stat-label">Following</span>
          </div>
        </div>
        <div class="profile-actions">
          <button class="btn-edit" onclick="openEditProfile()">
            <i class="bi bi-pencil-square"></i> Edit Profile
          </button>
        </div>
      </div>
      <div class="profile-tabs">
        <button class="tab-btn active"><i class="bi bi-grid-3x3"></i> Posts</button>
        <button class="tab-btn"><i class="bi bi-bookmark-fill"></i> Saved</button>
      </div>
      <div class="posts-grid" id="profile-posts">
        <div class="empty-state">
          <div class="empty-icon"><i class="bi bi-grid-3x3-gap"></i></div>
          <div class="empty-title">No Posts Yet</div>
        </div>
      </div>
    </div>

    <button class="create-post-btn" onclick="openCreatePost()">
      <i class="bi bi-plus-lg"></i>
    </button>

    <div class="bottom-nav">
      <div class="nav-btn active" data-view="feed" onclick="switchView('feed')">
        <i class="bi bi-house-door-fill"></i>
        <span>Home</span>
      </div>
      <div class="nav-btn" data-view="explore" onclick="switchView('explore')">
        <i class="bi bi-compass-fill"></i>
        <span>Explore</span>
      </div>
      <div class="nav-btn" data-view="chats" onclick="switchView('chats')">
        <i class="bi bi-chat-dots-fill"></i>
        <span>Chats</span>
      </div>
      <div class="nav-btn" data-view="profile" onclick="switchView('profile')">
        <i class="bi bi-person-circle"></i>
        <span>Profile</span>
      </div>
    </div>
  </div>

  <!-- STORY VIEWER -->
  <div id="story-viewer" class="story-viewer hidden">
    <div class="story-content">
      <div class="story-progress">
        <div class="story-progress-bar" id="story-progress-bar"></div>
      </div>
      <div class="story-header">
        <div class="story-user-info">
          <img class="story-user-avatar" id="story-user-avatar" src="" />
          <div>
            <div class="story-user-name" id="story-user-name">User</div>
            <div class="story-time" id="story-time">2h ago</div>
          </div>
        </div>
        <button class="story-close" onclick="closeStory()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <img class="story-media" id="story-media-img" style="display:none;" />
      <video class="story-media" id="story-media-video" style="display:none;" playsinline></video>
    </div>
  </div>

  <!-- CHAT WINDOW -->
  <div id="chat-window" class="chat-window hidden">
    <div class="chat-header">
      <button class="chat-back-btn" onclick="closeChatWindow()">
        <i class="bi bi-arrow-left"></i>
      </button>
      <div class="chat-header-info">
        <img class="chat-avatar" id="chat-partner-avatar" src="" />
        <div>
          <div style="font-weight:700;font-size:0.95rem;" id="chat-partner-name">User</div>
          <div style="font-size:0.75rem;color:var(--gray);">Active now</div>
        </div>
      </div>
    </div>
    
    <div class="chat-messages" id="chat-messages"></div>
    
    <div class="chat-input-container">
      <div class="chat-input-actions">
        <button class="chat-action-btn" onclick="toggleGifPicker()">
          <i class="bi bi-filetype-gif"></i>
        </button>
        <button class="chat-action-btn" onclick="selectChatImage()">
          <i class="bi bi-image"></i>
        </button>
        <button class="chat-action-btn" onclick="startVoiceRecording()">
          <i class="bi bi-mic-fill"></i>
        </button>
        <button class="chat-action-btn" onclick="shareLocation()">
          <i class="bi bi-geo-alt-fill"></i>
        </button>
      </div>
      <div class="chat-input-wrapper">
        <input class="chat-input" id="chat-input" type="text" placeholder="Type a message..." onkeypress="handleChatEnter(event)" />
        <button class="emoji-btn" onclick="toggleEmojiPicker()">üòä</button>
      </div>
      <button class="chat-send-btn" onclick="sendChatMessage()">
        <i class="bi bi-send-fill"></i>
      </button>
    </div>
    
    <!-- EMOJI PICKER -->
    <div id="emoji-picker-container" class="emoji-picker-container hidden"></div>
    
    <!-- GIF PICKER -->
    <div id="gif-picker" class="gif-picker hidden">
      <div class="gif-search">
        <input type="text" placeholder="Search GIFs..." oninput="searchGifs(this.value)" />
      </div>
      <div class="gif-grid" id="gif-grid"></div>
    </div>
    
    <!-- VOICE RECORDER -->
    <div id="voice-recorder" class="voice-recorder hidden">
      <div class="recording-indicator">
        <i class="bi bi-mic-fill"></i>
      </div>
      <div class="recording-time" id="recording-time">0:00</div>
      <div class="recording-actions">
        <button class="recording-btn recording-cancel" onclick="cancelRecording()">
          <i class="bi bi-x-lg"></i>
        </button>
        <button class="recording-btn recording-send" onclick="sendVoiceMessage()">
          <i class="bi bi-check-lg"></i>
        </button>
      </div>
    </div>
    
    <input id="chat-image-input" type="file" accept="image/*" style="display:none;" onchange="sendChatImage()" />
  </div>

  <!-- CREATE POST MODAL -->
  <div id="create-post-modal" class="modal hidden" onclick="closeOnOutside(event, 'create-post-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Create Post</h3>
        <button class="modal-close" onclick="closeCreatePost()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="post-type-selector">
        <div class="type-btn active" data-type="note" onclick="selectPostType('note')">
          <i class="bi bi-pencil-square"></i>
          <span>Note</span>
        </div>
        <div class="type-btn" data-type="image" onclick="selectPostType('image')">
          <i class="bi bi-image"></i>
          <span>Image</span>
        </div>
        <div class="type-btn" data-type="image_note" onclick="selectPostType('image_note')">
          <i class="bi bi-card-image"></i>
          <span>Image+Note</span>
        </div>
        <div class="type-btn" data-type="reel" onclick="selectPostType('reel')">
          <i class="bi bi-film"></i>
          <span>Reel</span>
        </div>
      </div>
      
      <div class="input-group">
        <textarea id="post-content" class="textarea-field" placeholder="What's on your mind?"></textarea>
      </div>
      
      <div id="media-upload-container" class="hidden">
        <div class="media-upload-zone" onclick="document.getElementById('post-media-file').click()">
          <i class="bi bi-cloud-upload"></i>
          <div>Upload media</div>
        </div>
        <input id="post-media-file" type="file" accept="image/*,video/*" style="display:none;" onchange="handlePostMediaSelect()" />
      </div>
      
      <div id="post-media-preview" class="media-preview hidden">
        <img id="preview-img" style="display:none;" />
        <video id="preview-video" style="display:none;" controls></video>
        <button class="remove-media" onclick="removePostMedia()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="input-group">
        <label class="input-label">Tags</label>
        <input id="post-tags" class="input-field" placeholder="#education #health" />
      </div>
      
      <button class="btn-primary" onclick="createPost()" id="btn-create">
        <i class="bi bi-send-fill"></i>
        <span>Share Post</span>
      </button>
    </div>
  </div>

  <!-- ADD STORY MODAL -->
  <div id="add-story-modal" class="modal hidden" onclick="closeOnOutside(event, 'add-story-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Add Story</h3>
        <button class="modal-close" onclick="closeAddStory()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="media-upload-zone" onclick="document.getElementById('story-media-file').click()">
        <i class="bi bi-camera-fill"></i>
        <div>Upload image or video</div>
        <div style="font-size:0.85rem;color:var(--gray);margin-top:10px;">Story will disappear in 24 hours</div>
      </div>
      <input id="story-media-file" type="file" accept="image/*,video/*" style="display:none;" onchange="handleStoryMediaSelect()" />
      
      <div id="story-media-preview" class="media-preview hidden">
        <img id="story-preview-img" style="display:none;" />
        <video id="story-preview-video" style="display:none;" controls></video>
        <button class="remove-media" onclick="removeStoryMedia()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="input-group">
        <input id="story-caption" class="input-field" placeholder="Add a caption..." />
      </div>
      
      <button class="btn-primary" onclick="postStory()" id="btn-post-story">
        <i class="bi bi-send-fill"></i>
        <span>Post Story</span>
      </button>
    </div>
  </div>

  <!-- EDIT PROFILE MODAL -->
  <div id="edit-profile-modal" class="modal hidden" onclick="closeOnOutside(event, 'edit-profile-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Edit Profile</h3>
        <button class="modal-close" onclick="closeEditProfile()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="avatar-upload" onclick="document.getElementById('edit-avatar-file').click()">
        <img id="edit-avatar-preview" style="display:none;" />
        <i class="bi bi-camera-fill" id="edit-avatar-icon"></i>
      </div>
      <input id="edit-avatar-file" type="file" accept="image/*" style="display:none;" onchange="handleEditAvatarSelect()" />
      
      <div class="input-group">
        <label class="input-label">Full Name</label>
        <input id="edit-name" class="input-field" type="text" />
      </div>
      
      <div class="input-group">
        <label class="input-label">Username</label>
        <input id="edit-username" class="input-field" type="text" />
      </div>
      
      <div class="input-group">
        <label class="input-label">Bio</label>
        <textarea id="edit-bio" class="textarea-field"></textarea>
      </div>
      
      <button class="btn-primary" onclick="saveProfile()" id="btn-save-profile">
        <i class="bi bi-check-circle-fill"></i>
        <span>Save Changes</span>
      </button>
    </div>
  </div>

  <!-- COMMENTS MODAL -->
  <div id="comments-modal" class="modal hidden" onclick="closeOnOutside(event, 'comments-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Comments</h3>
        <button class="modal-close" onclick="closeComments()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="comments-section">
        <div class="comment-input-area">
          <img id="comment-user-avatar" class="comment-avatar" src="" />
          <div class="comment-input-wrapper">
            <input id="comment-input" class="comment-input" type="text" placeholder="Add a comment..." onkeypress="handleCommentEnter(event)" />
            <button class="emoji-btn" onclick="toggleCommentEmojiPicker()" style="position:static;transform:none;">üòä</button>
            <button class="comment-send-btn" onclick="postComment()">
              <i class="bi bi-send-fill"></i>
            </button>
          </div>
        </div>
        
        <div id="comments-list" class="comments-list"></div>
      </div>
    </div>
  </div>

  <!-- REPORT MODAL -->
  <div id="report-modal" class="modal hidden" onclick="closeOnOutside(event, 'report-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Report Post</h3>
        <button class="modal-close" onclick="closeReportModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="input-group">
        <label class="input-label">Reason</label>
        <select id="report-reason" class="input-field">
          <option value="">Select a reason</option>
          <option value="spam">Spam</option>
          <option value="harassment">Harassment</option>
          <option value="hate_speech">Hate Speech</option>
          <option value="violence">Violence</option>
          <option value="misinformation">Misinformation</option>
          <option value="inappropriate">Inappropriate Content</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div class="input-group">
        <label class="input-label">Details (optional)</label>
        <textarea id="report-details" class="textarea-field" placeholder="Provide more information..."></textarea>
      </div>
      
      <button class="btn-primary" onclick="submitReport()" id="btn-submit-report">
        <i class="bi bi-flag-fill"></i>
        <span>Submit Report</span>
      </button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const SUPABASE_URL = 'https://vhklzctdzoqixtmaxlzp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoa2x6Y3Rkem9xaXh0bWF4bHpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzY2ODMsImV4cCI6MjA3OTY1MjY4M30.F0xOR1Nvn1LWV5GYQDDnoox9fwhEywxyp6JyzYdnwrk';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const TENOR_API_KEY = 'AIzaSyAVvz6jQIAuShzgj7TgGm5qcR-nIYtT9fM'; // Free Tenor API key

    let currentUser = null;
    let currentProfile = null;
    let onboardingStep = 1;
    let selectedAvatar = null;
    let selectedInterests = [];
    let currentPostType = 'note';
    let selectedPostMedia = null;
    let editAvatarFile = null;
    let currentCommentPostId = null;
    let currentReportPostId = null;
    let allPosts = [];
    let activeOptionsMenu = null;
    let emojiPickerInstance = null;
    let isRecording = false;
    let recordingStartTime = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let currentChatPartner = null;
    let selectedStoryMedia = null;
    let currentStoryIndex = 0;
    let currentStories = [];
    let storyTimer = null;

    async function init() {
      console.log('[Right Talk] v5.0 - Full Featured');
      
      try {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
          showAuth();
          return;
        }
        
        currentUser = user;
        await loadProfile();
        
        if (!currentProfile || !currentProfile.profile_completed) {
          showOnboarding();
        } else {
          showMainApp();
          await loadFeed();
          await loadStories();
        }
      } catch (error) {
        console.error('[Init] Error:', error);
        showAuth();
      }
    }

    // AUTH (keeping brief)
    async function handleSignIn() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value.trim();
      const btn = document.getElementById('btn-signin');
      
      if (!email || !password) {
        showError('Enter email and password');
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i><span>Signing in...</span>';
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        
        currentUser = data.user;
        await loadProfile();
        
        if (!currentProfile || !currentProfile.profile_completed) {
          showOnboarding();
        } else {
          showMainApp();
          await loadFeed();
          await loadStories();
        }
      } catch (error) {
        showError(error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-box-arrow-in-right"></i><span>Sign In</span>';
      }
    }

    async function handleSignUp() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value.trim();
      
      if (!email || !password) {
        showError('Enter email and password');
        return;
      }
      
      if (password.length < 6) {
        showError('Password must be 6+ characters');
        return;
      }
      
      try {
        const { data, error } = await supabase.auth.signUp({ 
          email, 
          password,
          options: { data: { full_name: email.split('@')[0] } }
        });
        
        if (error) throw error;
        
        currentUser = data.user;
        await new Promise(resolve => setTimeout(resolve, 1500));
        await loadProfile();
        showOnboarding();
      } catch (error) {
        showError(error.message);
      }
    }

    function showError(msg) {
      const errorEl = document.getElementById('auth-error');
      errorEl.textContent = msg;
      errorEl.classList.add('show');
      setTimeout(() => errorEl.classList.remove('show'), 5000);
    }

    // PROFILE
    async function loadProfile() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .maybeSingle();
        
        if (error && error.code !== 'PGRST116') throw error;
        
        if (!data) {
          await createProfile();
          return;
        }
        
        currentProfile = data;
        updateProfileUI();
      } catch (error) {
        console.error('[Profile] Error:', error);
        await createProfile();
      }
    }

    async function createProfile() {
      try {
        const username = currentUser.email.split('@')[0] + '_' + Date.now();
        
        const { data, error } = await supabase
          .from('profiles')
          .insert({
            id: currentUser.id,
            full_name: currentUser.email.split('@')[0],
            username: username,
            email: currentUser.email,
            profile_completed: false
          })
          .select()
          .single();
        
        if (error) throw error;
        currentProfile = data;
      } catch (error) {
        console.error('[Profile] Create error:', error);
      }
    }

    function updateProfileUI() {
      if (!currentProfile) return;
      
      const avatarUrl = getAvatarUrl(currentProfile);
      
      const elements = {
        'profile-avatar': avatarUrl,
        'user-story-avatar': avatarUrl,
        'profile-name': currentProfile.full_name || 'User',
        'profile-username': '@' + (currentProfile.username || 'user'),
        'profile-bio': currentProfile.bio || '',
        'comment-user-avatar': avatarUrl
      };
      
      Object.entries(elements).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) {
          if (id.includes('avatar')) {
            el.src = value;
          } else {
            el.textContent = value;
          }
        }
      });
    }

    async function loadProfileStats() {
      try {
        const { count } = await supabase
          .from('posts')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);
        
        const statPosts = document.getElementById('stat-posts');
        if (statPosts) statPosts.textContent = count || 0;
        
        await loadUserPosts();
      } catch (error) {
        console.error('[Stats] Error:', error);
      }
    }

    async function loadUserPosts() {
      try {
        const { data: posts } = await supabase
          .from('posts')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });
        
        const grid = document.getElementById('profile-posts');
        if (!posts || posts.length === 0) {
          grid.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="bi bi-grid-3x3-gap"></i></div><div class="empty-title">No Posts Yet</div></div>';
          return;
        }
        
        grid.innerHTML = posts.map(p => `
          <div class="grid-item" onclick="openPost('${p.id}')">
            ${p.media_url ? (p.media_type === 'video' ? 
              `<video src="${p.media_url}"></video>` : 
              `<img src="${p.media_url}" />`) : 
              `<div style="background:var(--light);display:flex;align-items:center;justify-content:center;height:100%;"><i class="bi bi-file-text" style="font-size:2rem;color:var(--gray);"></i></div>`}
          </div>
        `).join('');
      } catch (error) {
        console.error('[User Posts] Error:', error);
      }
    }

    function getAvatarUrl(profile) {
      if (profile?.avatar_url) {
        return supabase.storage.from('avatars').getPublicUrl(profile.avatar_url).data.publicUrl;
      }
      return `https://ui-avatars.com/api/?name=${encodeURIComponent(profile?.full_name || 'User')}&background=3b82f6&color=fff&size=200`;
    }

    // EDIT PROFILE
    function openEditProfile() {
      if (!currentProfile) return;
      
      document.getElementById('edit-name').value = currentProfile.full_name || '';
      document.getElementById('edit-username').value = currentProfile.username || '';
      document.getElementById('edit-bio').value = currentProfile.bio || '';
      
      const avatarUrl = getAvatarUrl(currentProfile);
      document.getElementById('edit-avatar-preview').src = avatarUrl;
      document.getElementById('edit-avatar-preview').style.display = 'block';
      document.getElementById('edit-avatar-icon').style.display = 'none';
      
      document.getElementById('edit-profile-modal').classList.remove('hidden');
    }

    function closeEditProfile() {
      document.getElementById('edit-profile-modal').classList.add('hidden');
      editAvatarFile = null;
    }

    function handleEditAvatarSelect() {
      const file = document.getElementById('edit-avatar-file').files[0];
      if (!file) return;
      
      editAvatarFile = file;
      document.getElementById('edit-avatar-preview').src = URL.createObjectURL(file);
      document.getElementById('edit-avatar-preview').style.display = 'block';
      document.getElementById('edit-avatar-icon').style.display = 'none';
    }

    async function saveProfile() {
      const btn = document.getElementById('btn-save-profile');
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i><span>Saving...</span>';
      
      try {
        const name = document.getElementById('edit-name').value.trim();
        const username = document.getElementById('edit-username').value.trim();
        const bio = document.getElementById('edit-bio').value.trim();
        
        let avatarPath = currentProfile.avatar_url;
        
        if (editAvatarFile) {
          const fileName = `${currentUser.id}_${Date.now()}_${editAvatarFile.name}`;
          const { error } = await supabase.storage.from('avatars').upload(fileName, editAvatarFile);
          if (!error) avatarPath = fileName;
        }
        
        const { error } = await supabase
          .from('profiles')
          .update({ full_name: name, username, bio, avatar_url: avatarPath })
          .eq('id', currentUser.id);
        
        if (error) throw error;
        
        await loadProfile();
        closeEditProfile();
        showToast('Profile updated! ‚úÖ');
      } catch (error) {
        console.error('[Save Profile] Error:', error);
        showToast('Failed to update profile');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle-fill"></i><span>Save Changes</span>';
      }
    }

    // ONBOARDING (Brief versions)
    function nextStep() {
      if (onboardingStep === 1) {
        const name = document.getElementById('onboard-name').value.trim();
        const username = document.getElementById('onboard-username').value.trim();
        if (!name || !username) {
          showToast('Fill all fields');
          return;
        }
      }
      
      if (onboardingStep < 4) {
        document.getElementById(`step-${onboardingStep}`).classList.remove('active');
        onboardingStep++;
        document.getElementById(`step-${onboardingStep}`).classList.add('active');
        document.querySelectorAll('.step-dot').forEach((dot, i) => dot.classList.toggle('active', i < onboardingStep));
      }
    }

    function prevStep() {
      if (onboardingStep > 1) {
        document.getElementById(`step-${onboardingStep}`).classList.remove('active');
        onboardingStep--;
        document.getElementById(`step-${onboardingStep}`).classList.add('active');
        document.querySelectorAll('.step-dot').forEach((dot, i) => dot.classList.toggle('active', i < onboardingStep));
      }
    }

    function handleAvatarSelect() {
      const file = document.getElementById('avatar-file').files[0];
      if (!file) return;
      
      selectedAvatar = file;
      document.getElementById('avatar-preview').src = URL.createObjectURL(file);
      document.getElementById('avatar-preview').style.display = 'block';
      document.getElementById('avatar-icon').style.display = 'none';
    }

    function toggleInterest(btn) {
      btn.classList.toggle('selected');
      const interest = btn.dataset.interest;
      if (selectedInterests.includes(interest)) {
        selectedInterests = selectedInterests.filter(i => i !== interest);
      } else {
        selectedInterests.push(interest);
      }
    }

    async function completeOnboarding() {
      const btn = document.getElementById('btn-complete');
      btn.disabled = true;
      btn.textContent = 'Setting up...';
      
      try {
        const name = document.getElementById('onboard-name').value.trim();
        const username = document.getElementById('onboard-username').value.trim();
        const bio = document.getElementById('onboard-bio').value.trim();
        const dob = document.getElementById('onboard-dob').value;
        
        let avatarPath = null;
        if (selectedAvatar) {
          const fileName = `${currentUser.id}_${Date.now()}_${selectedAvatar.name}`;
          const { error } = await supabase.storage.from('avatars').upload(fileName, selectedAvatar);
          if (!error) avatarPath = fileName;
        }
        
        const { error } = await supabase
          .from('profiles')
          .update({
            full_name: name,
            username,
            bio,
            date_of_birth: dob,
            avatar_url: avatarPath,
            interests: selectedInterests,
            profile_completed: true
          })
          .eq('id', currentUser.id);
        
        if (error) throw error;
        
        await loadProfile();
        showMainApp();
        await loadFeed();
        await loadStories();
        showToast('Welcome to Right Talk! üéâ');
      } catch (error) {
        console.error('[Onboarding] Error:', error);
        showToast('Setup failed');
        btn.disabled = false;
        btn.textContent = 'Complete';
      }
    }

    // STORIES
    async function loadStories() {
      try {
        const { data: stories, error } = await supabase
          .from('stories')
          .select('*, profiles(*)')
          .gt('expires_at', new Date().toISOString())
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const storyBar = document.getElementById('stories-bar');
        const addStoryHTML = storyBar.innerHTML; // Keep "Your Story" button
        
        if (!stories || stories.length === 0) {
          return;
        }
        
        // Group by user
        const groupedStories = {};
        stories.forEach(story => {
          if (!groupedStories[story.user_id]) {
            groupedStories[story.user_id] = [];
          }
          groupedStories[story.user_id].push(story);
        });
        
        const storiesHTML = Object.values(groupedStories).map(userStories => {
          const profile = userStories[0].profiles;
          const avatarUrl = getAvatarUrl(profile);
          return `
            <div class="story-item" onclick='viewStories(${JSON.stringify(userStories)})'>
              <div class="story-ring">
                <img class="story-avatar" src="${avatarUrl}" />
              </div>
              <div class="story-name">${profile.full_name || 'User'}</div>
            </div>
          `;
        }).join('');
        
        storyBar.innerHTML = addStoryHTML + storiesHTML;
      } catch (error) {
        console.error('[Stories] Error:', error);
      }
    }

    function openAddStory() {
      document.getElementById('add-story-modal').classList.remove('hidden');
    }

    function closeAddStory() {
      document.getElementById('add-story-modal').classList.add('hidden');
      removeStoryMedia();
    }

    function handleStoryMediaSelect() {
      const file = document.getElementById('story-media-file').files[0];
      if (!file) return;
      
      selectedStoryMedia = file;
      const url = URL.createObjectURL(file);
      
      const preview = document.getElementById('story-media-preview');
      const img = document.getElementById('story-preview-img');
      const video = document.getElementById('story-preview-video');
      
      if (file.type.startsWith('image/')) {
        img.src = url;
        img.style.display = 'block';
        video.style.display = 'none';
      } else {
        video.src = url;
        video.style.display = 'block';
        img.style.display = 'none';
      }
      
      preview.classList.remove('hidden');
    }

    function removeStoryMedia() {
      selectedStoryMedia = null;
      document.getElementById('story-media-file').value = '';
      document.getElementById('story-media-preview').classList.add('hidden');
      document.getElementById('story-preview-img').src = '';
      document.getElementById('story-preview-video').src = '';
    }

    async function postStory() {
      if (!selectedStoryMedia) {
        showToast('Select a photo or video');
        return;
      }
      
      const btn = document.getElementById('btn-post-story');
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i><span>Posting...</span>';
      
      try {
        const caption = document.getElementById('story-caption').value.trim();
        const fileName = `${currentUser.id}_${Date.now()}_${selectedStoryMedia.name}`;
        
        const { error: uploadError } = await supabase.storage
          .from('posts')
          .upload(fileName, selectedStoryMedia);
        
        if (uploadError) throw uploadError;
        
        const mediaUrl = supabase.storage.from('posts').getPublicUrl(fileName).data.publicUrl;
        const mediaType = selectedStoryMedia.type.startsWith('video/') ? 'video' : 'image';
        
        const { error } = await supabase.from('stories').insert({
          user_id: currentUser.id,
          media_url: mediaUrl,
          media_type: mediaType,
          caption: caption
        });
        
        if (error) throw error;
        
        closeAddStory();
        await loadStories();
        showToast('Story posted! üéâ');
      } catch (error) {
        console.error('[Post Story] Error:', error);
        showToast('Failed to post story');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send-fill"></i><span>Post Story</span>';
      }
    }

    function viewStories(stories) {
      currentStories = stories;
      currentStoryIndex = 0;
      showStory(currentStories[currentStoryIndex]);
    }

    function showStory(story) {
      document.getElementById('story-viewer').classList.remove('hidden');
      
      const profile = story.profiles;
      document.getElementById('story-user-avatar').src = getAvatarUrl(profile);
      document.getElementById('story-user-name').textContent = profile.full_name || 'User';
      document.getElementById('story-time').textContent = getTimeAgo(story.created_at);
      
      const img = document.getElementById('story-media-img');
      const video = document.getElementById('story-media-video');
      
      if (story.media_type === 'video') {
        video.src = story.media_url;
        video.style.display = 'block';
        img.style.display = 'none';
        video.play();
      } else {
        img.src = story.media_url;
        img.style.display = 'block';
        video.style.display = 'none';
      }
      
      // Auto progress
      const progressBar = document.getElementById('story-progress-bar');
      progressBar.style.width = '0%';
      progressBar.style.transition = 'width 5s linear';
      
      setTimeout(() => {
        progressBar.style.width = '100%';
      }, 10);
      
      if (storyTimer) clearTimeout(storyTimer);
      storyTimer = setTimeout(() => {
        nextStory();
      }, 5000);
    }

    function nextStory() {
      if (currentStoryIndex < currentStories.length - 1) {
        currentStoryIndex++;
        showStory(currentStories[currentStoryIndex]);
      } else {
        closeStory();
      }
    }

    function closeStory() {
      document.getElementById('story-viewer').classList.add('hidden');
      if (storyTimer) clearTimeout(storyTimer);
      const video = document.getElementById('story-media-video');
      video.pause();
      video.src = '';
    }

    // FEED
    async function loadFeed() {
      const container = document.getElementById('feed-container');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading...</div></div>';
      
      try {
        const { data: posts, error } = await supabase
          .from('posts')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        if (!posts || posts.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="bi bi-chat-dots"></i></div><div class="empty-title">No Posts Yet</div></div>';
          return;
        }
        
        allPosts = posts;
        const userIds = [...new Set(posts.map(p => p.user_id))];
        const { data: profiles } = await supabase.from('profiles').select('*').in('id', userIds);
        
        const profileMap = {};
        if (profiles) profiles.forEach(p => profileMap[p.id] = p);
        
        container.innerHTML = posts.map(post => createPostCard(post, profileMap[post.user_id])).join('');
      } catch (error) {
        console.error('[Feed] Error:', error);
        container.innerHTML = '<div class="empty-state"><div class="empty-title">Error loading feed</div></div>';
      }
    }

    function createPostCard(post, profile) {
      const avatarUrl = getAvatarUrl(profile);
      const timeAgo = getTimeAgo(post.created_at);
      
      let mediaHTML = '';
      if (post.media_url) {
        const mediaTag = post.media_type === 'video' ?
          `<video src="${post.media_url}" controls playsinline></video>` :
          `<img src="${post.media_url}" />`;
        
        mediaHTML = `
          <div class="post-media">
            ${mediaTag}
            <div class="double-tap-zone" ondblclick="doubleTapLike('${post.id}')">
              <div class="heart-burst" id="heart-${post.id}">
                <i class="bi bi-heart-fill"></i>
              </div>
            </div>
          </div>
        `;
      }
      
      let tagsHTML = '';
            if (post.tags && post.tags.length > 0) {
        tagsHTML = `<div class="post-tags">${post.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`;
      }
      
      return `
        <div class="post-card" data-post-id="${post.id}">
          <div class="post-header">
            <img src="${avatarUrl}" class="post-avatar" />
            <div class="post-info">
              <div class="post-author">${profile?.full_name || 'User'}</div>
              <div class="post-meta">${timeAgo}</div>
            </div>
            <div class="post-options" onclick="toggleOptionsMenu('${post.id}', '${post.user_id}')">
              <i class="bi bi-three-dots"></i>
            </div>
          </div>
          ${post.content ? `<div class="post-content">${escapeHtml(post.content)}</div>` : ''}
          ${mediaHTML}
          <div class="post-actions">
            <button class="action-btn" onclick="toggleLike('${post.id}')"><i class="bi bi-heart"></i></button>
            <button class="action-btn" onclick="openComments('${post.id}')"><i class="bi bi-chat"></i></button>
            <button class="action-btn" onclick="sharePost('${post.id}')"><i class="bi bi-share"></i></button>
            <button class="action-btn" onclick="toggleBookmark('${post.id}')" style="margin-left:auto;"><i class="bi bi-bookmark"></i></button>
          </div>
          <div class="post-likes">${post.likes_count || 0} likes</div>
          ${tagsHTML}
          <div class="post-timestamp">${timeAgo}</div>
        </div>
      `;
    }

    // POST OPTIONS MENU
    function toggleOptionsMenu(postId, postUserId) {
      if (activeOptionsMenu) {
        activeOptionsMenu.remove();
        activeOptionsMenu = null;
        return;
      }
      
      const isOwn = postUserId === currentUser.id;
      
      const menu = document.createElement('div');
      menu.className = 'options-menu';
      menu.innerHTML = `
        ${isOwn ? `
          <div class="menu-item" onclick="editPost('${postId}')">
            <i class="bi bi-pencil"></i> Edit Post
          </div>
          <div class="menu-item danger" onclick="deletePost('${postId}')">
            <i class="bi bi-trash"></i> Delete Post
          </div>
        ` : `
          <div class="menu-item danger" onclick="openReportModal('${postId}')">
            <i class="bi bi-flag"></i> Report Post
          </div>
          <div class="menu-item" onclick="openChatWith('${postUserId}')">
            <i class="bi bi-chat"></i> Message User
          </div>
        `}
        <div class="menu-item" onclick="copyPostLink('${postId}')">
          <i class="bi bi-link"></i> Copy Link
        </div>
      `;
      
      const postCard = document.querySelector(`[data-post-id="${postId}"]`);
      postCard.style.position = 'relative';
      postCard.appendChild(menu);
      activeOptionsMenu = menu;
      
      document.addEventListener('click', closeOptionsMenu);
    }

    function closeOptionsMenu(e) {
      if (activeOptionsMenu && !e.target.closest('.post-options') && !e.target.closest('.options-menu')) {
        activeOptionsMenu.remove();
        activeOptionsMenu = null;
        document.removeEventListener('click', closeOptionsMenu);
      }
    }

    function editPost(postId) {
      showToast('Edit post coming soon!');
      closeOptionsMenu({ target: document.body });
    }

    async function deletePost(postId) {
      if (!confirm('Delete this post?')) return;
      
      try {
        const { error } = await supabase.from('posts').delete().eq('id', postId);
        if (error) throw error;
        
        closeOptionsMenu({ target: document.body });
        await loadFeed();
        showToast('Post deleted ‚úÖ');
      } catch (error) {
        console.error('[Delete Post] Error:', error);
        showToast('Failed to delete post');
      }
    }

    function copyPostLink(postId) {
      const link = `${window.location.origin}?post=${postId}`;
      navigator.clipboard.writeText(link);
      showToast('Link copied! üìã');
      closeOptionsMenu({ target: document.body });
    }

    function sharePost(postId) {
      if (navigator.share) {
        navigator.share({
          title: 'Right Talk Post',
          url: `${window.location.origin}?post=${postId}`
        });
      } else {
        copyPostLink(postId);
      }
    }

    // REPORT
    function openReportModal(postId) {
      currentReportPostId = postId;
      document.getElementById('report-modal').classList.remove('hidden');
      closeOptionsMenu({ target: document.body });
    }

    function closeReportModal() {
      document.getElementById('report-modal').classList.add('hidden');
      currentReportPostId = null;
      document.getElementById('report-reason').value = '';
      document.getElementById('report-details').value = '';
    }

    async function submitReport() {
      const reason = document.getElementById('report-reason').value;
      const details = document.getElementById('report-details').value.trim();
      
      if (!reason) {
        showToast('Select a reason');
        return;
      }
      
      const btn = document.getElementById('btn-submit-report');
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i><span>Submitting...</span>';
      
      try {
        const { error } = await supabase.from('reports').insert({
          reporter_id: currentUser.id,
          post_id: currentReportPostId,
          reason: reason,
          details: details
        });
        
        if (error) throw error;
        
        closeReportModal();
        showToast('Report submitted. Thank you! üôè');
      } catch (error) {
        console.error('[Report] Error:', error);
        showToast('Failed to submit report');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-flag-fill"></i><span>Submit Report</span>';
      }
    }

    // LIKES & BOOKMARKS
    async function doubleTapLike(postId) {
      const heart = document.getElementById(`heart-${postId}`);
      if (heart) {
        heart.classList.add('show');
        setTimeout(() => heart.classList.remove('show'), 800);
      }
      await toggleLike(postId, true);
    }

    async function toggleLike(postId, force = false) {
      try {
        const { data: existing } = await supabase
          .from('likes')
          .select('*')
          .eq('post_id', postId)
          .eq('user_id', currentUser.id)
          .maybeSingle();
        
        if (existing && !force) {
          await supabase.from('likes').delete().eq('id', existing.id);
        } else if (!existing) {
          await supabase.from('likes').insert({ post_id: postId, user_id: currentUser.id });
        }
        
        await loadFeed();
      } catch (error) {
        console.error('[Like] Error:', error);
      }
    }

    async function toggleBookmark(postId) {
      try {
        const { data: existing } = await supabase
          .from('bookmarks')
          .select('*')
          .eq('post_id', postId)
          .eq('user_id', currentUser.id)
          .maybeSingle();
        
        if (existing) {
          await supabase.from('bookmarks').delete().eq('id', existing.id);
          showToast('Removed from bookmarks');
        } else {
          await supabase.from('bookmarks').insert({ post_id: postId, user_id: currentUser.id });
          showToast('Saved! ‚≠ê');
        }
      } catch (error) {
        console.error('[Bookmark] Error:', error);
      }
    }

    // COMMENTS
    async function openComments(postId) {
      currentCommentPostId = postId;
      document.getElementById('comments-modal').classList.remove('hidden');
      await loadComments(postId);
    }

    function closeComments() {
      document.getElementById('comments-modal').classList.add('hidden');
      currentCommentPostId = null;
    }

    async function loadComments(postId) {
      try {
        const { data: comments } = await supabase
          .from('comments')
          .select('*, profiles(*)')
          .eq('post_id', postId)
          .order('created_at', { ascending: false });
        
        const list = document.getElementById('comments-list');
        
        if (!comments || comments.length === 0) {
          list.innerHTML = '<div style="text-align:center;color:var(--gray);padding:20px;">No comments yet. Be the first!</div>';
          return;
        }
        
        list.innerHTML = comments.map(c => {
          const avatarUrl = getAvatarUrl(c.profiles);
          return `
            <div class="comment-item">
              <img src="${avatarUrl}" class="comment-avatar" />
              <div class="comment-content">
                <div class="comment-author">${c.profiles?.full_name || 'User'}</div>
                <div class="comment-text">${escapeHtml(c.content)}</div>
                <div class="comment-time">${getTimeAgo(c.created_at)}</div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('[Comments] Error:', error);
      }
    }

    async function postComment() {
      const input = document.getElementById('comment-input');
      const content = input.value.trim();
      
      if (!content) return;
      
      try {
        const { error } = await supabase.from('comments').insert({
          post_id: currentCommentPostId,
          user_id: currentUser.id,
          content
        });
        
        if (error) throw error;
        
        input.value = '';
        await loadComments(currentCommentPostId);
        showToast('Comment posted! üí¨');
      } catch (error) {
        console.error('[Post Comment] Error:', error);
        showToast('Failed to post comment');
      }
    }

    function handleCommentEnter(e) {
      if (e.key === 'Enter') postComment();
    }

    function toggleCommentEmojiPicker() {
      showToast('Emoji picker in comments coming soon! üòä');
    }

    // CHATS
    async function loadChats() {
      const container = document.getElementById('chats-list');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading chats...</div></div>';
      
      try {
        const { data: messages } = await supabase
          .from('messages')
          .select('*, profiles!messages_from_user_id_fkey(*)')
          .or(`from_user_id.eq.${currentUser.id},to_user_id.eq.${currentUser.id}`)
          .order('created_at', { ascending: false });
        
        if (!messages || messages.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="bi bi-chat-dots"></i></div><div class="empty-title">No chats yet</div></div>';
          return;
        }
        
        // Group by conversation
        const conversations = {};
        messages.forEach(msg => {
          const partnerId = msg.from_user_id === currentUser.id ? msg.to_user_id : msg.from_user_id;
          if (!conversations[partnerId]) {
            conversations[partnerId] = { lastMessage: msg, unread: 0 };
          }
          if (msg.to_user_id === currentUser.id && !msg.is_read) {
            conversations[partnerId].unread++;
          }
        });
        
        // Load partner profiles
        const partnerIds = Object.keys(conversations);
        const { data: profiles } = await supabase
          .from('profiles')
          .select('*')
          .in('id', partnerIds);
        
        const profileMap = {};
        if (profiles) profiles.forEach(p => profileMap[p.id] = p);
        
        container.innerHTML = Object.entries(conversations).map(([partnerId, conv]) => {
          const profile = profileMap[partnerId];
          const avatarUrl = getAvatarUrl(profile);
          const lastMsg = conv.lastMessage;
          const preview = lastMsg.message_type === 'text' ? lastMsg.content : 
            lastMsg.message_type === 'image' ? 'üì∑ Photo' :
            lastMsg.message_type === 'voice' ? 'üé§ Voice message' :
            lastMsg.message_type === 'location' ? 'üìç Location' : 'üé¨ GIF';
          
          return `
            <div class="chat-item" onclick="openChatWindow('${partnerId}')">
              <img src="${avatarUrl}" class="chat-avatar" />
              <div class="chat-info">
                <div class="chat-name">${profile?.full_name || 'User'}</div>
                <div class="chat-last-message">${preview}</div>
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                <div class="chat-time">${getTimeAgo(lastMsg.created_at)}</div>
                ${conv.unread > 0 ? `<div class="unread-badge">${conv.unread}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('[Chats] Error:', error);
        container.innerHTML = '<div class="empty-state"><div class="empty-title">Error loading chats</div></div>';
      }
    }

    async function openChatWindow(partnerId) {
      currentChatPartner = partnerId;
      document.getElementById('chat-window').classList.remove('hidden');
      
      try {
        const { data: profile } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', partnerId)
          .single();
        
        if (profile) {
          const avatarUrl = getAvatarUrl(profile);
          document.getElementById('chat-partner-avatar').src = avatarUrl;
          document.getElementById('chat-partner-name').textContent = profile.full_name || 'User';
        }
        
        await loadChatMessages(partnerId);
        
        // Mark messages as read
        await supabase
          .from('messages')
          .update({ is_read: true })
          .eq('to_user_id', currentUser.id)
          .eq('from_user_id', partnerId);
      } catch (error) {
        console.error('[Open Chat] Error:', error);
      }
    }

    function closeChatWindow() {
      document.getElementById('chat-window').classList.add('hidden');
      currentChatPartner = null;
      loadChats();
    }

    async function loadChatMessages(partnerId) {
      try {
        const { data: messages } = await supabase
          .from('messages')
          .select('*')
          .or(`and(from_user_id.eq.${currentUser.id},to_user_id.eq.${partnerId}),and(from_user_id.eq.${partnerId},to_user_id.eq.${currentUser.id})`)
          .order('created_at', { ascending: true });
        
        const container = document.getElementById('chat-messages');
        
        if (!messages || messages.length === 0) {
          container.innerHTML = '<div style="text-align:center;color:var(--gray);padding:40px 20px;">Start a conversation! üí¨</div>';
          return;
        }
        
        container.innerHTML = messages.map(msg => {
          const isOwn = msg.from_user_id === currentUser.id;
          
          let content = '';
          if (msg.message_type === 'text') {
            content = `<div class="message-text">${escapeHtml(msg.content)}</div>`;
          } else if (msg.message_type === 'image') {
            content = `<div class="message-image"><img src="${msg.media_url}" /></div>`;
          } else if (msg.message_type === 'voice') {
            content = `
              <div class="message-voice">
                <button class="voice-play-btn" onclick="playVoiceMessage('${msg.media_url}')">
                  <i class="bi bi-play-fill"></i>
                </button>
                <div class="voice-waveform"></div>
              </div>
            `;
          } else if (msg.message_type === 'location') {
            content = `
              <div class="message-location" onclick="openLocation(${msg.location_lat}, ${msg.location_lng})">
                <i class="bi bi-geo-alt-fill"></i>
                <div class="location-name">${msg.location_name || 'Location'}</div>
              </div>
            `;
          } else if (msg.message_type === 'gif') {
            content = `<div class="message-image"><img src="${msg.media_url}" /></div>`;
          }
          
          return `
            <div class="message-item ${isOwn ? 'own' : ''}">
              ${!isOwn ? `<img src="${getAvatarUrl(currentProfile)}" class="message-avatar" />` : ''}
              <div class="message-bubble">
                ${content}
                <div class="message-time">${getTimeAgo(msg.created_at)}</div>
              </div>
            </div>
          `;
        }).join('');
        
        container.scrollTop = container.scrollHeight;
      } catch (error) {
        console.error('[Chat Messages] Error:', error);
      }
    }

    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const content = input.value.trim();
      
      if (!content) return;
      
      try {
        const { error } = await supabase.from('messages').insert({
          from_user_id: currentUser.id,
          to_user_id: currentChatPartner,
          content: content,
          message_type: 'text'
        });
        
        if (error) throw error;
        
        input.value = '';
        await loadChatMessages(currentChatPartner);
      } catch (error) {
        console.error('[Send Message] Error:', error);
        showToast('Failed to send message');
      }
    }

    function handleChatEnter(e) {
      if (e.key === 'Enter') sendChatMessage();
    }

    function openChatWith(userId) {
      closeOptionsMenu({ target: document.body });
      switchView('chats');
      setTimeout(() => openChatWindow(userId), 300);
    }

    // EMOJI PICKER
    function toggleEmojiPicker() {
      const container = document.getElementById('emoji-picker-container');
      
      if (container.classList.contains('hidden')) {
        if (!emojiPickerInstance) {
          emojiPickerInstance = document.createElement('emoji-picker');
          emojiPickerInstance.addEventListener('emoji-click', (e) => {
            const input = document.getElementById('chat-input');
            input.value += e.detail.unicode;
            input.focus();
          });
          container.appendChild(emojiPickerInstance);
        }
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
      }
    }

    // GIF PICKER
    let gifSearchTimeout = null;

    function toggleGifPicker() {
      const picker = document.getElementById('gif-picker');
      
      if (picker.classList.contains('hidden')) {
        picker.classList.remove('hidden');
        searchGifs('trending');
      } else {
        picker.classList.add('hidden');
      }
    }

    function searchGifs(query) {
      if (gifSearchTimeout) clearTimeout(gifSearchTimeout);
      
      gifSearchTimeout = setTimeout(async () => {
        try {
          const endpoint = query === 'trending' ? 
            `https://tenor.googleapis.com/v2/featured?key=${TENOR_API_KEY}&limit=12` :
            `https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(query)}&key=${TENOR_API_KEY}&limit=12`;
          
          const response = await fetch(endpoint);
          const data = await response.json();
          
          const grid = document.getElementById('gif-grid');
          grid.innerHTML = data.results.map(gif => `
            <div class="gif-item" onclick="sendGif('${gif.media_formats.tinygif.url}')">
              <img src="${gif.media_formats.tinygif.url}" />
            </div>
          `).join('');
        } catch (error) {
          console.error('[GIF Search] Error:', error);
        }
      }, 500);
    }

    async function sendGif(gifUrl) {
      try {
        const { error } = await supabase.from('messages').insert({
          from_user_id: currentUser.id,
          to_user_id: currentChatPartner,
          media_url: gifUrl,
          message_type: 'gif'
        });
        
        if (error) throw error;
        
        toggleGifPicker();
        await loadChatMessages(currentChatPartner);
      } catch (error) {
        console.error('[Send GIF] Error:', error);
      }
    }

    // VOICE RECORDING
    async function startVoiceRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
          audioChunks.push(e.data);
        };
        
        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();
        
        document.getElementById('voice-recorder').classList.remove('hidden');
        
        const timerInterval = setInterval(() => {
          if (!isRecording) {
            clearInterval(timerInterval);
            return;
          }
          const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          document.getElementById('recording-time').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
      } catch (error) {
        console.error('[Voice Recording] Error:', error);
        showToast('Microphone access denied');
      }
    }

    function cancelRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        isRecording = false;
        audioChunks = [];
        document.getElementById('voice-recorder').classList.add('hidden');
      }
    }

    async function sendVoiceMessage() {
      if (!mediaRecorder || !isRecording) return;
      
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      isRecording = false;
      document.getElementById('voice-recorder').classList.add('hidden');
      
      mediaRecorder.onstop = async () => {
        try {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const fileName = `voice_${currentUser.id}_${Date.now()}.webm`;
          
          const { error: uploadError } = await supabase.storage
            .from('posts')
            .upload(fileName, audioBlob);
          
          if (uploadError) throw uploadError;
          
          const mediaUrl = supabase.storage.from('posts').getPublicUrl(fileName).data.publicUrl;
          
          const { error } = await supabase.from('messages').insert({
            from_user_id: currentUser.id,
            to_user_id: currentChatPartner,
            media_url: mediaUrl,
            message_type: 'voice'
          });
          
          if (error) throw error;
          
          await loadChatMessages(currentChatPartner);
          showToast('Voice message sent! üé§');
        } catch (error) {
          console.error('[Send Voice] Error:', error);
          showToast('Failed to send voice message');
        }
      };
    }

    function playVoiceMessage(url) {
      const audio = new Audio(url);
      audio.play();
    }

    // IMAGE IN CHAT
    function selectChatImage() {
      document.getElementById('chat-image-input').click();
    }

    async function sendChatImage() {
      const file = document.getElementById('chat-image-input').files[0];
      if (!file) return;
      
      try {
        const fileName = `chat_${currentUser.id}_${Date.now()}_${file.name}`;
        const { error: uploadError } = await supabase.storage
          .from('posts')
          .upload(fileName, file);
        
        if (uploadError) throw uploadError;
        
        const mediaUrl = supabase.storage.from('posts').getPublicUrl(fileName).data.publicUrl;
        
        const { error } = await supabase.from('messages').insert({
          from_user_id: currentUser.id,
          to_user_id: currentChatPartner,
          media_url: mediaUrl,
          message_type: 'image'
        });
        
        if (error) throw error;
        
        document.getElementById('chat-image-input').value = '';
        await loadChatMessages(currentChatPartner);
      } catch (error) {
        console.error('[Send Image] Error:', error);
        showToast('Failed to send image');
      }
    }

    // LOCATION SHARING
    function shareLocation() {
      if (!navigator.geolocation) {
        showToast('Geolocation not supported');
        return;
      }
      
      showToast('Getting your location...');
      
      navigator.geolocation.getCurrentPosition(async (position) => {
        try {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const locationName = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
          
          const { error } = await supabase.from('messages').insert({
            from_user_id: currentUser.id,
            to_user_id: currentChatPartner,
            message_type: 'location',
            location_lat: lat,
            location_lng: lng,
            location_name: locationName
          });
          
          if (error) throw error;
          
          await loadChatMessages(currentChatPartner);
          showToast('Location shared! üìç');
        } catch (error) {
          console.error('[Share Location] Error:', error);
          showToast('Failed to share location');
        }
      }, (error) => {
        showToast('Location access denied');
      });
    }

    function openLocation(lat, lng) {
      window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
    }

    // CREATE POST
    function openCreatePost() {
      document.getElementById('create-post-modal').classList.remove('hidden');
    }

    function closeCreatePost() {
      document.getElementById('create-post-modal').classList.add('hidden');
      document.getElementById('post-content').value = '';
      document.getElementById('post-tags').value = '';
      removePostMedia();
    }

    function selectPostType(type) {
      currentPostType = type;
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      document.getElementById('media-upload-container').classList.toggle('hidden', type === 'note');
    }

    function handlePostMediaSelect() {
      const file = document.getElementById('post-media-file').files[0];
      if (!file) return;
      
      if (currentPostType === 'reel' && file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.preload = 'metadata';
        video.onloadedmetadata = function() {
          window.URL.revokeObjectURL(video.src);
          if (video.duration > 35) {
            showToast('‚ö†Ô∏è Reel must be ‚â§35 seconds');
            return;
          }
        };
        video.src = URL.createObjectURL(file);
      }
      
      selectedPostMedia = file;
      const url = URL.createObjectURL(file);
      
      const preview = document.getElementById('post-media-preview');
      const img = document.getElementById('preview-img');
      const video = document.getElementById('preview-video');
      
      if (file.type.startsWith('image/')) {
        img.src = url;
        img.style.display = 'block';
        video.style.display = 'none';
      } else {
        video.src = url;
        video.style.display = 'block';
        img.style.display = 'none';
      }
      
      preview.classList.remove('hidden');
    }

    function removePostMedia() {
      selectedPostMedia = null;
      document.getElementById('post-media-file').value = '';
      document.getElementById('post-media-preview').classList.add('hidden');
      document.getElementById('preview-img').src = '';
      document.getElementById('preview-video').src = '';
    }

    async function createPost() {
      const content = document.getElementById('post-content').value.trim();
      const tagsInput = document.getElementById('post-tags').value.trim();
      const btn = document.getElementById('btn-create');
      
      if (!content && !selectedPostMedia) {
        showToast('‚ö†Ô∏è Add content or media');
        return;
      }
      
      if (currentPostType !== 'note' && !selectedPostMedia) {
        showToast('‚ö†Ô∏è Add media for this type');
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i><span>Posting...</span>';
      
      try {
        let mediaUrl = null;
        let mediaType = null;
        let mediaDuration = null;
        
        if (selectedPostMedia) {
          const fileName = `${currentUser.id}_${Date.now()}_${selectedPostMedia.name}`;
          const { error } = await supabase.storage.from('posts').upload(fileName, selectedPostMedia);
          if (error) throw error;
          
          mediaUrl = supabase.storage.from('posts').getPublicUrl(fileName).data.publicUrl;
          mediaType = selectedPostMedia.type.startsWith('video/') ? 'video' : 'image';
          
          if (mediaType === 'video') {
            const video = document.createElement('video');
            video.src = URL.createObjectURL(selectedPostMedia);
            await new Promise(resolve => video.onloadedmetadata = resolve);
            mediaDuration = Math.floor(video.duration);
          }
        }
        
        const tags = tagsInput.split(/\s+/).filter(t => t.startsWith('#'));
        
        const { error } = await supabase.from('posts').insert({
          user_id: currentUser.id,
          content,
          post_type: currentPostType,
          media_url: mediaUrl,
          media_type: mediaType,
          media_duration: mediaDuration,
          tags
        });
        
        if (error) throw error;
        
        closeCreatePost();
        await loadFeed();
        showToast('Post shared! üéâ');
      } catch (error) {
        console.error('[Post] Error:', error);
        showToast('‚ùå Failed to post');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send-fill"></i><span>Share Post</span>';
      }
    }

    // UI HELPERS
    function showAuth() {
      document.getElementById('auth-screen').classList.remove('hidden');
      document.getElementById('onboarding-screen').classList.add('hidden');
      document.getElementById('main-app').classList.add('hidden');
    }

    function showOnboarding() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('onboarding-screen').classList.remove('hidden');
      document.getElementById('main-app').classList.add('hidden');
    }

    function showMainApp() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('onboarding-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
    }

    function switchView(viewName) {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === viewName);
      });
      
      document.getElementById('feed-view').style.display = viewName === 'feed' ? 'block' : 'none';
      document.getElementById('chats-view').classList.toggle('hidden', viewName !== 'chats');
      document.getElementById('profile-view').classList.toggle('hidden', viewName !== 'profile');
      
      if (viewName === 'feed') loadFeed();
      if (viewName === 'chats') loadChats();
      if (viewName === 'explore') showToast('Explore coming soon! üîç');
      if (viewName === 'profile') {
        updateProfileUI();
        loadProfileStats();
      }
    }

    function showNotifications() {
      showToast('Notifications coming soon! üîî');
    }

    function openPost(postId) {
      const post = allPosts.find(p => p.id === postId);
      if (post) openComments(postId);
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3500);
    }

    function closeOnOutside(event, modalId) {
      if (event.target.id === modalId) {
        document.getElementById(modalId).classList.add('hidden');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getTimeAgo(dateString) {
      const seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd';
      return new Date(dateString).toLocaleDateString();
    }

    // START APP
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
