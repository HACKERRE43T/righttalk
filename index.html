<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#3b82f6">
  <title>Right Talk - Social Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #06b6d4;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #1e293b;
      --gray: #64748b;
      --light: #f8fafc;
      --border: #e2e8f0;
    }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: var(--light);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: pan-y;
      overscroll-behavior: none;
    }
    
    .hidden { display: none !important; }
    button { 
      font-family: inherit; 
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* AUTH */
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    
    .auth-box {
      width: 100%;
      max-width: 420px;
      background: white;
      border-radius: 24px;
      padding: 40px 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .logo-auth {
      font-size: 2.8rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-align: center;
      margin-bottom: 12px;
    }
    
    .tagline {
      text-align: center;
      color: var(--gray);
      font-size: 1rem;
      margin-bottom: 32px;
      font-weight: 500;
    }
    
    .input-group { margin-bottom: 20px; }
    
    .input-label {
      display: block;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .input-field {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s;
      font-family: inherit;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59,130,246,0.1);
    }
    
    .btn-primary {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1.05rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 8px 20px rgba(59,130,246,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-primary:active {
      transform: scale(0.98);
    }
    
    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      width: 100%;
      padding: 14px;
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.3s;
    }
    
    .error-msg {
      background: #fee2e2;
      color: var(--danger);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 0.9rem;
      margin-top: 16px;
      display: none;
      border-left: 4px solid var(--danger);
    }
    
    .error-msg.show { display: block; }
    
    /* ONBOARDING */
    .onboarding-container {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .onboarding-card {
      width: 100%;
      max-width: 520px;
      background: white;
      border-radius: 24px;
      padding: 40px 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .onboarding-step { display: none; }
    .onboarding-step.active { display: block; }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }
    
    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.4s;
    }
    
    .step-dot.active {
      width: 36px;
      border-radius: 5px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    
    .step-title {
      font-size: 2rem;
      font-weight: 800;
      color: var(--dark);
      margin-bottom: 8px;
    }
    
    .step-subtitle {
      color: var(--gray);
      margin-bottom: 28px;
      font-size: 1.05rem;
    }
    
    .avatar-upload {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      border: 3px dashed var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 28px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
      background: var(--light);
    }
    
    .avatar-upload:active {
      transform: scale(0.95);
    }
    
    .avatar-upload img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .avatar-upload i {
      font-size: 2.5rem;
      color: var(--gray);
    }
    
    .textarea-field {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      min-height: 110px;
      transition: all 0.3s;
    }
    
    .textarea-field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(59,130,246,0.1);
    }
    
    .interest-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 20px;
    }
    
    .interest-btn {
      padding: 14px 12px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      text-align: center;
    }
    
    .interest-btn:active {
      transform: scale(0.95);
    }
    
    .interest-btn.selected {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-color: var(--primary);
    }
    
    .btn-row {
      display: flex;
      gap: 12px;
      margin-top: 28px;
    }
    
    .btn-back {
      flex: 1;
      padding: 14px;
      background: var(--light);
      border: 2px solid var(--border);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-next {
      flex: 2;
      padding: 14px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(59,130,246,0.4);
    }
    
    /* MAIN APP */
    .app-container {
      width: 100%;
      max-width: 100vw;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }
    
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      height: 56px;
    }
    
    .logo-small {
      font-size: 1.4rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
    }
    
    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--light);
      color: var(--gray);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .icon-btn:active {
      transform: scale(0.9);
      background: var(--border);
    }
    
    .notification-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      min-width: 18px;
      height: 18px;
      background: var(--danger);
      border-radius: 10px;
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      padding: 0 4px;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
      display: flex;
      z-index: 100;
      height: calc(60px + env(safe-area-inset-bottom));
    }
    
    .nav-btn {
      flex: 1;
      padding: 6px 4px;
      text-align: center;
      color: var(--gray);
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 12px;
      margin: 0 4px;
      border: none;
      background: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
    }
    
    .nav-btn:active {
      transform: scale(0.95);
    }
    
    .nav-btn i {
      font-size: 1.4rem;
    }
    
    .nav-btn span {
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .nav-btn.active {
      color: var(--primary);
      background: rgba(59,130,246,0.1);
    }
    
    /* VIEW CONTAINER */
    .view-container {
      padding-top: 56px;
      padding-bottom: calc(60px + env(safe-area-inset-bottom));
      min-height: 100vh;
      background: var(--light);
    }
    
    /* STORIES */
    .stories-bar {
      display: flex;
      gap: 12px;
      padding: 12px 16px;
      overflow-x: auto;
      background: white;
      border-bottom: 1px solid var(--border);
      -webkit-overflow-scrolling: touch;
    }
    
    .stories-bar::-webkit-scrollbar { display: none; }
    
    .story-item {
      flex-shrink: 0;
      width: 64px;
      text-align: center;
      cursor: pointer;
    }
    
    .story-ring {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      padding: 3px;
      background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
      margin: 0 auto 6px;
    }
    
    .story-ring.add-story {
      background: var(--border);
    }
    
    .story-avatar {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid white;
      object-fit: cover;
    }
    
    .add-story-icon {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: 50%;
      border: 2px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
    }
    
    .story-name {
      font-size: 0.7rem;
      color: var(--dark);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
    }
    
    /* POST CARD */
    .feed-container {
      background: var(--light);
    }
    
    .post-card {
      background: white;
      margin: 0 0 8px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .post-header {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--light);
      flex-shrink: 0;
    }
    
    .post-info {
      flex: 1;
      min-width: 0;
    }
    
    .post-author {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .verified-badge {
      color: var(--primary);
      font-size: 0.9rem;
    }
    
    .post-meta {
      font-size: 0.75rem;
      color: var(--gray);
    }
    
    .post-options {
      color: var(--gray);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .post-options:active {
      background: var(--light);
      transform: scale(0.9);
    }
    
    .post-content {
      padding: 0 16px 12px;
      line-height: 1.5;
      color: var(--dark);
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.95rem;
    }
    
    .post-media {
      width: 100%;
      max-height: 500px;
      background: #000;
      position: relative;
    }
    
    .post-media img,
    .post-media video {
      width: 100%;
      max-height: 500px;
      object-fit: contain;
      display: block;
    }
    
    .post-actions {
      padding: 8px 12px;
      display: flex;
      gap: 14px;
      align-items: center;
    }
    
    .action-btn {
      background: none;
      border: none;
      color: var(--dark);
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.2s;
      padding: 6px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .action-btn:active {
      transform: scale(0.9);
    }
    
    .action-btn.liked {
      color: var(--danger);
      animation: likeAnimation 0.3s ease;
    }
    
    @keyframes likeAnimation {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    .action-btn.bookmarked {
      color: var(--warning);
    }
    
    .action-btn span {
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .post-likes {
      padding: 0 16px 8px;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--dark);
    }
    
    .post-tags {
      padding: 0 16px 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .tag {
      color: var(--primary);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
    }
    
    .tag:active {
      opacity: 0.7;
    }
    
    .post-timestamp {
      padding: 0 16px 12px;
      font-size: 0.75rem;
      color: var(--gray);
    }
    
    /* POLL */
    .poll-container {
      padding: 12px 16px;
    }
    
    .poll-option-post {
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.2s;
    }
    
    .poll-option-post:active {
      transform: scale(0.98);
    }
    
    .poll-option-post.voted {
      border-color: var(--primary);
      background: rgba(59,130,246,0.05);
    }
    
    .poll-option-text {
      position: relative;
      z-index: 2;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .poll-option-percentage {
      position: relative;
      z-index: 2;
      font-size: 0.8rem;
      color: var(--gray);
      margin-top: 4px;
    }
    
    .poll-option-bar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      background: linear-gradient(90deg, rgba(59,130,246,0.15), transparent);
      transition: width 0.5s ease;
      z-index: 1;
    }
    
    .poll-footer {
      padding: 8px 0 0;
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    /* COMMENTS MODAL */
    .comments-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 500;
      display: flex;
      align-items: flex-end;
    }
    
    .comments-container {
      width: 100%;
      max-height: 80vh;
      background: white;
      border-radius: 20px 20px 0 0;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    
    .comments-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .comments-title {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--dark);
    }
    
    .comments-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--light);
      cursor: pointer;
      font-size: 1.1rem;
    }
    
    .comments-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      min-height: 200px;
    }
    
    .comment-item {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .comment-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .comment-content {
      flex: 1;
    }
    
    .comment-author {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--dark);
      margin-bottom: 4px;
    }
    
    .comment-text {
      font-size: 0.9rem;
      color: var(--dark);
      line-height: 1.4;
      margin-bottom: 6px;
    }
    
    .comment-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .comment-action {
      font-size: 0.8rem;
      color: var(--gray);
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    
    .comment-time {
      font-size: 0.75rem;
      color: var(--gray);
    }
    
    .comment-input-container {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      align-items: center;
      background: white;
    }
    
    .comment-input-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .comment-input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 15px;
      font-family: inherit;
      background: var(--light);
    }
    
    .comment-input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
    }
    
    .comment-send-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    
    .comment-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* SETTINGS MODAL */
    .settings-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 500;
      display: flex;
      align-items: flex-end;
    }
    
    .settings-container {
      width: 100%;
      max-height: 85vh;
      background: white;
      border-radius: 20px 20px 0 0;
      animation: slideUp 0.3s ease;
      overflow-y: auto;
    }
    
    .settings-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }
    
    .settings-title {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--dark);
    }
    
    .settings-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--light);
      cursor: pointer;
      font-size: 1.1rem;
    }
    
    .settings-section {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .settings-section-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .settings-item {
      padding: 14px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    
    .settings-item:active {
      opacity: 0.7;
    }
    
    .settings-item-info {
      flex: 1;
    }
    
    .settings-item-label {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--dark);
      margin-bottom: 2px;
    }
    
    .settings-item-desc {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 28px;
      flex-shrink: 0;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: var(--border);
      border-radius: 28px;
      transition: 0.3s;
      cursor: pointer;
    }
    
    .toggle-slider:before {
      content: '';
      position: absolute;
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }
    
    .toggle-switch input:checked + .toggle-slider {
      background: var(--primary);
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    
    .settings-danger {
      color: var(--danger) !important;
    }
    
    /* EXPLORE WITH SEARCH */
    .explore-container {
      background: var(--light);
    }
    
    .explore-search {
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 56px;
      z-index: 50;
    }
    
    .search-box {
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 10px 16px 10px 40px;
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 15px;
      background: var(--light);
    }
    
    .search-box i {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    
    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
    }
    
    .explore-tabs {
      display: flex;
      background: white;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: calc(56px + 56px);
      z-index: 49;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .explore-tabs::-webkit-scrollbar { display: none; }
    
    .explore-tab {
      flex-shrink: 0;
      padding: 12px 20px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: 700;
      color: var(--gray);
      transition: all 0.3s;
      font-size: 0.85rem;
    }
    
    .explore-tab:active {
      opacity: 0.7;
    }
    
    .explore-tab.active {
      color: var(--dark);
      border-bottom-color: var(--primary);
    }
    
    .explore-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
    }
    
    .explore-item {
      aspect-ratio: 1;
      background: var(--border);
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    
    .explore-item:active {
      opacity: 0.8;
    }
    
    .explore-item img,
    .explore-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .explore-stats {
      position: absolute;
      bottom: 8px;
      left: 8px;
      right: 8px;
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      gap: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .search-results {
      background: white;
    }
    
    .search-result-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    
    .search-result-item:active {
      background: var(--light);
    }
    
    .search-result-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .search-result-info {
      flex: 1;
    }
    
    .search-result-name {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--dark);
      margin-bottom: 2px;
    }
    
    .search-result-username {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    /* REELS VIEWER */
    .reels-viewer {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 200;
      overflow: hidden;
    }
    
    .reels-container {
      height: 100vh;
      scroll-snap-type: y mandatory;
      overflow-y: scroll;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .reels-container::-webkit-scrollbar {
      display: none;
    }
    
    .reel-item {
      height: 100vh;
      scroll-snap-align: start;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .reel-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .reel-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.6) 100%);
      pointer-events: none;
    }
    
    .reel-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: calc(12px + env(safe-area-inset-top)) 16px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
      pointer-events: auto;
    }
    
    .reel-back-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.5);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    
    .reel-back-btn:active {
      transform: scale(0.9);
    }
    
    .reel-title {
      color: white;
      font-weight: 700;
      font-size: 1rem;
    }
    
    .reel-menu-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.5);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    
    .reel-info {
      position: absolute;
      bottom: calc(20px + env(safe-area-inset-bottom));
      left: 16px;
      right: 80px;
      z-index: 10;
      color: white;
      pointer-events: auto;
    }
    
    .reel-author-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .reel-author-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
      object-fit: cover;
    }
    
    .reel-author-name {
      font-weight: 700;
      font-size: 0.95rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .reel-follow-btn {
      padding: 6px 16px;
      background: var(--primary);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 700;
      font-size: 0.8rem;
      cursor: pointer;
    }
    
    .reel-description {
      font-size: 0.9rem;
      line-height: 1.4;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .reel-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .reel-tag {
      font-size: 0.85rem;
      font-weight: 600;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .reel-actions {
      position: absolute;
      right: 16px;
      bottom: calc(80px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      z-index: 10;
      pointer-events: auto;
    }
    
    .reel-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .reel-action-btn:active {
      transform: scale(0.9);
    }
    
    .reel-action-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    
    .reel-action-icon.liked {
      color: var(--danger);
    }
    
    .reel-action-count {
      font-size: 0.75rem;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .reel-play-pause {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2.5rem;
      pointer-events: none;
      z-index: 5;
    }
    
    .reel-play-pause.show {
      display: flex;
      animation: fadeOut 0.5s ease forwards;
    }
    
    @keyframes fadeOut {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
    }
    
    /* CHATS */
    .chats-container {
      background: white;
    }
    
    .chat-search {
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 56px;
      z-index: 50;
    }
    
    .chat-search input {
      width: 100%;
      padding: 10px 16px;
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 15px;
      background: var(--light);
    }
    
    .chat-search input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
    }
    
    .chat-list {
      background: white;
    }
    
    .chat-item {
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .chat-item:active {
      background: var(--light);
    }
    
    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      position: relative;
    }
    
    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: var(--success);
      border-radius: 50%;
      border: 2px solid white;
    }
    
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    
    .chat-name {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--dark);
      margin-bottom: 4px;
    }
    
    .chat-last-message {
      font-size: 0.85rem;
      color: var(--gray);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .chat-last-message.unread {
      font-weight: 600;
      color: var(--dark);
    }
    
    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      flex-shrink: 0;
    }
    
    .chat-time {
      font-size: 0.75rem;
      color: var(--gray);
    }
    
    .unread-badge {
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      background: var(--primary);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
    }
    
    /* PROFILE */
    .profile-header {
      padding: 0 0 20px 0;
      text-align: center;
      background: white;
      border-bottom: 1px solid var(--border);
    }
    
    .profile-cover {
      width: 100%;
      height: 140px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    
    .profile-avatar-lg {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 5px solid white;
      object-fit: cover;
      margin: -50px auto 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .profile-name {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--dark);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .profile-username {
      color: var(--gray);
      margin-bottom: 12px;
      font-size: 1rem;
    }
    
    .profile-bio {
      color: var(--dark);
      line-height: 1.5;
      margin-bottom: 16px;
      padding: 0 20px;
      font-size: 0.9rem;
    }
    
    .profile-stats {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin: 20px 0;
    }
    
    .stat {
      text-align: center;
      cursor: pointer;
    }
    
    .stat:active {
      opacity: 0.7;
    }
    
    .stat-number {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--dark);
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: var(--gray);
      font-weight: 600;
    }
    
    .profile-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 16px;
      padding: 0 20px;
    }
    
    .btn-edit {
      flex: 1;
      padding: 10px 24px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.9rem;
    }
    
    .btn-edit:active {
      transform: scale(0.98);
    }
    
    .profile-tabs {
      display: flex;
      background: white;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 56px;
      z-index: 50;
    }
    
    .tab-btn {
      flex: 1;
      padding: 14px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: 700;
      color: var(--gray);
      transition: all 0.3s;
      font-size: 0.85rem;
    }
    
    .tab-btn:active {
      opacity: 0.7;
    }
    
    .tab-btn.active {
      color: var(--dark);
      border-bottom-color: var(--primary);
    }
    
    .posts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      background: var(--light);
    }
    
    .grid-item {
      aspect-ratio: 1;
      background: var(--border);
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    
    .grid-item:active {
      opacity: 0.8;
    }
    
    .grid-item img,
    .grid-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .grid-item-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      color: white;
      font-size: 1.2rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    /* CREATE POST BUTTON */
    .create-post-btn {
      position: fixed;
      bottom: calc(70px + env(safe-area-inset-bottom));
      right: 16px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(59,130,246,0.4);
      transition: all 0.3s;
      z-index: 90;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .create-post-btn:active {
      transform: scale(0.9) rotate(90deg);
    }
    
    /* MODAL */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    
    .modal-content {
      background: white;
      border-radius: 20px 20px 0 0;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px 20px calc(24px + env(safe-area-inset-bottom));
      animation: slideUp 0.3s ease;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--dark);
    }
    
    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--light);
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-close:active {
      background: var(--border);
      transform: scale(0.9);
    }
    
    /* LOADING & TOAST */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      bottom: calc(70px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(30,41,59,0.95);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      z-index: 10000;
      opacity: 0;
      transition: all 0.3s;
      max-width: calc(100% - 40px);
      text-align: center;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--gray);
    }
    
    .empty-icon {
      font-size: 4rem;
      color: var(--border);
      margin-bottom: 16px;
    }
    
    .empty-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 8px;
    }
    
    /* POST TYPE SELECTOR */
    .post-type-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .type-btn {
      padding: 12px 8px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .type-btn:active {
      transform: scale(0.95);
    }
    
    .type-btn i {
      display: block;
      font-size: 1.4rem;
      margin-bottom: 6px;
      color: var(--gray);
    }
    
    .type-btn span {
      font-size: 0.75rem;
      color: var(--gray);
      font-weight: 600;
      display: block;
    }
    
    .type-btn.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-color: var(--primary);
    }
    
    .type-btn.active i,
    .type-btn.active span {
      color: white;
    }
    
    /* VISIBILITY SELECTOR */
    .visibility-selector {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
    }
    
    .visibility-btn {
      flex: 1;
      padding: 8px 6px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    
    .visibility-btn:active {
      transform: scale(0.95);
    }
    
    .visibility-btn.active {
      border-color: var(--primary);
      background: rgba(59,130,246,0.1);
      color: var(--primary);
    }
    
    /* MEDIA UPLOAD */
    .media-upload-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 14px;
      background: var(--light);
    }
    
    .media-upload-zone:active {
      transform: scale(0.98);
      border-color: var(--primary);
    }
    
    .media-preview {
      margin-bottom: 14px;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      background: #000;
    }
    
    .media-preview img,
    .media-preview video {
      width: 100%;
      max-height: 350px;
      object-fit: contain;
    }
    
    .remove-media {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0,0,0,0.8);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .remove-media:active {
      transform: scale(0.9);
    }
    
    /* POLL CREATOR */
    .poll-creator {
      margin-bottom: 14px;
    }
    
    .poll-question-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      margin-bottom: 10px;
      font-family: inherit;
      font-weight: 600;
    }
    
    .poll-question-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .poll-options-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .poll-option-input {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    
    .poll-option-input input {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }
    
    .poll-remove-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--light);
      color: var(--danger);
      cursor: pointer;
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    .poll-add-option {
      padding: 10px;
      border: 2px dashed var(--border);
      border-radius: 8px;
      background: none;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
      font-size: 0.85rem;
    }
    
    .poll-add-option:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <!-- AUTH SCREEN -->
  <div id="auth-screen" class="auth-container">
    <div class="auth-box">
      <div class="logo-auth">Right Talk</div>
      <div class="tagline">Raise Your Voice ‚Ä¢ Create Change</div>
      
      <div class="input-group">
        <label class="input-label">Email</label>
        <input id="auth-email" class="input-field" type="email" placeholder="your@email.com" autocomplete="email" />
      </div>
      
      <div class="input-group">
        <label class="input-label">Password</label>
        <input id="auth-password" class="input-field" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>
      
      <button class="btn-primary" id="btn-signin" onclick="handleSignIn()">
        <i class="bi bi-box-arrow-in-right"></i>
        <span>Sign In</span>
      </button>
      <button class="btn-secondary" onclick="handleSignUp()">Create Account</button>
      
      <div id="auth-error" class="error-msg"></div>
    </div>
  </div>

  <!-- ONBOARDING SCREEN -->
  <div id="onboarding-screen" class="onboarding-container hidden">
    <div class="onboarding-card">
      <div class="step-indicator">
        <div class="step-dot active"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
        <div class="step-dot"></div>
      </div>
      
      <div id="step-1" class="onboarding-step active">
        <h2 class="step-title">Welcome! üëã</h2>
        <p class="step-subtitle">Let's set up your profile</p>
        <div class="input-group">
          <label class="input-label">Full Name</label>
          <input id="onboard-name" class="input-field" type="text" placeholder="Your name" />
        </div>
        <div class="input-group">
          <label class="input-label">Username</label>
          <input id="onboard-username" class="input-field" type="text" placeholder="@username" />
        </div>
        <div class="btn-row">
          <button class="btn-next" onclick="nextStep()">Continue</button>
        </div>
      </div>
      
      <div id="step-2" class="onboarding-step">
        <h2 class="step-title">Profile Photo</h2>
        <p class="step-subtitle">Add a photo</p>
        <div class="avatar-upload" onclick="document.getElementById('avatar-file').click()">
          <img id="avatar-preview" style="display:none;" />
          <i class="bi bi-camera-fill" id="avatar-icon"></i>
        </div>
        <input id="avatar-file" type="file" accept="image/*" style="display:none;" onchange="handleAvatarSelect()" />
        <div class="btn-row">
          <button class="btn-back" onclick="prevStep()">Back</button>
          <button class="btn-next" onclick="nextStep()">Continue</button>
        </div>
      </div>
      
      <div id="step-3" class="onboarding-step">
        <h2 class="step-title">About You</h2>
        <p class="step-subtitle">Tell us about yourself</p>
        <div class="input-group">
          <label class="input-label">Bio</label>
          <textarea id="onboard-bio" class="textarea-field" placeholder="Your bio..."></textarea>
        </div>
        <div class="input-group">
          <label class="input-label">Date of Birth</label>
          <input id="onboard-dob" class="input-field" type="date" />
        </div>
        <div class="btn-row">
          <button class="btn-back" onclick="prevStep()">Back</button>
          <button class="btn-next" onclick="nextStep()">Continue</button>
        </div>
      </div>
      
      <div id="step-4" class="onboarding-step">
        <h2 class="step-title">Interests</h2>
        <p class="step-subtitle">What matters to you?</p>
        <div class="interest-grid">
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="education">üéì Education</div>
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="health">üè• Health</div>
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="environment">üåç Environment</div>
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="rights">‚öñÔ∏è Rights</div>
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="economy">üí∞ Economy</div>
          <div class="interest-btn" onclick="toggleInterest(this)" data-interest="technology">üíª Technology</div>
        </div>
        <div class="btn-row">
          <button class="btn-back" onclick="prevStep()">Back</button>
          <button class="btn-next" id="btn-complete" onclick="completeOnboarding()">Complete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="main-app" class="app-container hidden">
    <!-- TOP HEADER -->
    <div class="top-header">
      <div class="logo-small">Right Talk</div>
      <div class="header-actions">
        <button class="icon-btn" onclick="switchView('chats')">
          <i class="bi bi-chat-dots-fill"></i>
        </button>
        <button class="icon-btn" onclick="openNotifications()">
          <i class="bi bi-bell-fill"></i>
          <span class="notification-badge hidden" id="notification-badge">0</span>
        </button>
      </div>
    </div>

    <!-- FEED VIEW -->
    <div id="feed-view" class="view-container">
      <div class="stories-bar" id="stories-bar">
        <div class="story-item" onclick="showToast('Add Story ready! üì∏')">
          <div style="position:relative;">
            <div class="story-ring add-story">
              <img class="story-avatar" id="user-story-avatar" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff&size=200" />
            </div>
            <div class="add-story-icon">
              <i class="bi bi-plus-lg"></i>
            </div>
          </div>
          <div class="story-name">Your Story</div>
        </div>
      </div>
      
      <div id="feed-container" class="feed-container">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading feed...</div>
        </div>
      </div>
    </div>

    <!-- EXPLORE VIEW WITH SEARCH -->
    <div id="explore-view" class="view-container hidden">
      <div class="explore-search">
        <div class="search-box">
          <i class="bi bi-search"></i>
          <input type="text" id="explore-search-input" placeholder="Search accounts, posts, polls..." oninput="handleSearch(this.value)" />
        </div>
      </div>
      
      <div class="explore-tabs">
        <button class="explore-tab active" data-tab="posts" onclick="switchExploreTab('posts')">Posts</button>
        <button class="explore-tab" data-tab="accounts" onclick="switchExploreTab('accounts')">Accounts</button>
        <button class="explore-tab" data-tab="polls" onclick="switchExploreTab('polls')">Polls</button>
        <button class="explore-tab" data-tab="reels" onclick="switchExploreTab('reels')">Reels</button>
      </div>
      
      <div id="explore-content">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading explore...</div>
        </div>
      </div>
    </div>

    <!-- REELS VIEW -->
    <div id="reels-view" class="reels-viewer hidden">
      <div class="reel-header">
        <button class="reel-back-btn" onclick="closeReels()">
          <i class="bi bi-arrow-left"></i>
        </button>
        <div class="reel-title">Reels</div>
        <button class="reel-menu-btn" onclick="openSettings()">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
      </div>
      
      <div class="reels-container" id="reels-container">
        <!-- Reels will be loaded here -->
      </div>
    </div>

    <!-- CHATS VIEW -->
    <div id="chats-view" class="view-container hidden">
      <div class="chat-search">
        <input type="text" placeholder="Search messages..." oninput="searchChats(this.value)" />
      </div>
      <div id="chats-list" class="chat-list chats-container">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading chats...</div>
        </div>
      </div>
    </div>

    <!-- PROFILE VIEW -->
    <div id="profile-view" class="view-container hidden">
      <div class="profile-header">
        <div class="profile-cover"></div>
        <img id="profile-avatar" class="profile-avatar-lg" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff&size=200" />
        <div class="profile-name" id="profile-name">Loading...</div>
        <div class="profile-username" id="profile-username">@username</div>
        <div class="profile-bio" id="profile-bio"></div>
        <div class="profile-stats">
          <div class="stat">
            <div class="stat-number" id="stat-posts">0</div>
            <div class="stat-label">Posts</div>
          </div>
          <div class="stat">
            <div class="stat-number" id="stat-followers">0</div>
            <div class="stat-label">Followers</div>
          </div>
          <div class="stat">
            <div class="stat-number" id="stat-following">0</div>
            <div class="stat-label">Following</div>
          </div>
        </div>
        <div class="profile-actions">
          <button class="btn-edit" onclick="showToast('Edit Profile ready! ‚úèÔ∏è')">
            <i class="bi bi-pencil-square"></i> Edit
          </button>
          <button class="btn-edit" onclick="openSettings()">
            <i class="bi bi-gear-fill"></i> Settings
          </button>
        </div>
      </div>
      <div class="profile-tabs">
        <button class="tab-btn active"><i class="bi bi-grid-3x3"></i> Posts</button>
        <button class="tab-btn"><i class="bi bi-bookmark-fill"></i> Saved</button>
      </div>
      <div class="posts-grid" id="profile-posts">
        <div class="empty-state">
          <div class="empty-icon"><i class="bi bi-grid-3x3-gap"></i></div>
          <div class="empty-title">No Posts Yet</div>
        </div>
      </div>
    </div>

    <!-- CREATE POST BUTTON -->
    <button class="create-post-btn" onclick="openCreatePost()">
      <i class="bi bi-plus-lg"></i>
    </button>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
      <button class="nav-btn active" data-view="feed" onclick="switchView('feed')">
        <i class="bi bi-house-door-fill"></i>
        <span>Home</span>
      </button>
      <button class="nav-btn" data-view="explore" onclick="switchView('explore')">
        <i class="bi bi-compass-fill"></i>
        <span>Explore</span>
      </button>
      <button class="nav-btn" data-view="reels" onclick="openReels()">
        <i class="bi bi-play-circle-fill"></i>
        <span>Reels</span>
      </button>
      <button class="nav-btn" data-view="chats" onclick="switchView('chats')">
        <i class="bi bi-chat-dots-fill"></i>
        <span>Chats</span>
      </button>
      <button class="nav-btn" data-view="profile" onclick="switchView('profile')">
        <i class="bi bi-person-circle"></i>
        <span>Profile</span>
      </button>
    </nav>
  </div>

  <!-- COMMENTS MODAL -->
  <div id="comments-modal" class="comments-modal hidden" onclick="closeOnOutside(event, 'comments-modal')">
    <div class="comments-container" onclick="event.stopPropagation()">
      <div class="comments-header">
        <h3 class="comments-title">Comments</h3>
        <button class="comments-close" onclick="closeComments()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="comments-list" id="comments-list">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading comments...</div>
        </div>
      </div>
      
      <div class="comment-input-container">
        <img class="comment-input-avatar" id="comment-user-avatar" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff&size=200" />
        <input type="text" class="comment-input" id="comment-input" placeholder="Add a comment..." />
        <button class="comment-send-btn" id="comment-send-btn" onclick="postComment()" disabled>
          <i class="bi bi-send-fill"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settings-modal" class="settings-modal hidden" onclick="closeOnOutside(event, 'settings-modal')">
    <div class="settings-container" onclick="event.stopPropagation()">
      <div class="settings-header">
        <h3 class="settings-title">Settings</h3>
        <button class="settings-close" onclick="closeSettings()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">Account</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Account Type</div>
            <div class="settings-item-desc">Public</div>
          </div>
          <i class="bi bi-chevron-right"></i>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Private Account</div>
            <div class="settings-item-desc">Only followers can see your posts</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="private-toggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">Privacy</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Activity Status</div>
            <div class="settings-item-desc">Show when you're active</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="status-toggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Read Receipts</div>
            <div class="settings-item-desc">Show when you've read messages</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="read-receipts-toggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">Notifications</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Push Notifications</div>
            <div class="settings-item-desc">Receive notifications</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="push-toggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Likes & Comments</div>
            <div class="settings-item-desc">Get notified about interactions</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="likes-toggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">Content</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Auto-Play Videos</div>
            <div class="settings-item-desc">Videos play automatically</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="autoplay-toggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      
      <div class="settings-section">
        <div class="settings-section-title">Account Actions</div>
        <div class="settings-item" onclick="logout()">
          <div class="settings-item-info">
            <div class="settings-item-label settings-danger">Logout</div>
          </div>
          <i class="bi bi-box-arrow-right settings-danger"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- CREATE POST MODAL -->
  <div id="create-post-modal" class="modal hidden" onclick="closeOnOutside(event, 'create-post-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Create Post</h3>
        <button class="modal-close" onclick="closeCreatePost()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div class="post-type-selector">
        <div class="type-btn active" data-type="note" onclick="selectPostType('note')">
          <i class="bi bi-pencil-square"></i>
          <span>Note</span>
        </div>
        <div class="type-btn" data-type="image" onclick="selectPostType('image')">
          <i class="bi bi-image"></i>
          <span>Image</span>
        </div>
        <div class="type-btn" data-type="reel" onclick="selectPostType('reel')">
          <i class="bi bi-play-circle"></i>
          <span>Reel</span>
        </div>
        <div class="type-btn" data-type="poll" onclick="selectPostType('poll')">
          <i class="bi bi-bar-chart-fill"></i>
          <span>Poll</span>
        </div>
      </div>
      
      <div class="visibility-selector">
        <button class="visibility-btn active" data-visibility="public" onclick="selectVisibility('public')">
          <i class="bi bi-globe"></i> Public
        </button>
        <button class="visibility-btn" data-visibility="friends" onclick="selectVisibility('friends')">
          <i class="bi bi-people-fill"></i> Friends
        </button>
        <button class="visibility-btn" data-visibility="private" onclick="selectVisibility('private')">
          <i class="bi bi-lock-fill"></i> Private
        </button>
      </div>
      
      <div class="input-group">
        <textarea id="post-content" class="textarea-field" placeholder="What's on your mind?"></textarea>
      </div>
      
      <div id="media-upload-container" class="hidden">
        <div class="media-upload-zone" onclick="document.getElementById('post-media-file').click()">
          <i class="bi bi-cloud-upload" style="font-size:2rem;color:var(--gray);margin-bottom:8px;"></i>
          <div style="font-size:0.85rem;color:var(--gray);" id="upload-text">Upload media</div>
        </div>
        <input id="post-media-file" type="file" accept="image/*,video/*" style="display:none;" onchange="handlePostMediaSelect()" />
      </div>
      
      <div id="post-media-preview" class="media-preview hidden">
        <img id="preview-img" style="display:none;" />
        <video id="preview-video" style="display:none;" controls playsinline></video>
        <button class="remove-media" onclick="removePostMedia()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      
      <div id="poll-creator" class="poll-creator hidden">
        <input type="text" class="poll-question-input" id="poll-question" placeholder="Ask a question..." />
        <div class="poll-options-list" id="poll-options-list">
          <div class="poll-option-input">
            <input type="text" placeholder="Option 1" class="poll-option-text" />
          </div>
          <div class="poll-option-input">
            <input type="text" placeholder="Option 2" class="poll-option-text" />
          </div>
        </div>
        <button class="poll-add-option" onclick="addPollOption()">
          <i class="bi bi-plus-lg"></i> Add Option
        </button>
      </div>
      
      <div class="input-group">
        <label class="input-label">Tags</label>
        <input id="post-tags" class="input-field" placeholder="#education #health" />
      </div>
      
      <button class="btn-primary" onclick="createPost()" id="btn-create">
        <i class="bi bi-send-fill"></i>
        <span>Share Post</span>
      </button>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://vhklzctdzoqixtmaxlzp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZoa2x6Y3Rkem9xaXh0bWF4bHpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzY2ODMsImV4cCI6MjA3OTY1MjY4M30.F0xOR1Nvn1LWV5GYQDDnoox9fwhEywxyp6JyzYdnwrk';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Global State
    let currentUser = null;
    let currentProfile = null;
    let onboardingStep = 1;
    let selectedAvatar = null;
    let selectedInterests = [];
    let currentPostType = 'note';
    let selectedPostMedia = null;
    let postVisibility = 'public';
    let allPosts = [];
    let allReels = [];
    let likesData = new Map();
    let commentsData = new Map();
    let currentView = 'feed';
    let currentExploreTab = 'posts';
    let searchTimeout = null;
    let currentReelIndex = 0;
    let currentCommentPostId = null;

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
      console.log('[Right Talk] v3.0 - All Features Working!');
      
      try {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
          showAuth();
          return;
        }
        
        currentUser = user;
        await loadProfile();
        
        if (!currentProfile || !currentProfile.profile_completed) {
          showOnboarding();
        } else {
          showMainApp();
          await loadFeed();
        }
      } catch (error) {
        console.error('[Init] Error:', error);
        showAuth();
      }
    }

    // ============================================
    // AUTHENTICATION
    // ============================================
    async function handleSignIn() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value.trim();
      const btn = document.getElementById('btn-signin');
      
      if (!email || !password) {
        showError('Please enter email and password');
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i><span>Signing in...</span>';
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        
        currentUser = data.user;
        await loadProfile();
        
        if (!currentProfile || !currentProfile.profile_completed) {
          showOnboarding();
        } else {
          showMainApp();
          await loadFeed();
        }
      } catch (error) {
        showError(error.message || 'Failed to sign in');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-box-arrow-in-right"></i><span>Sign In</span>';
      }
    }

    async function handleSignUp() {
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-password').value.trim();
      
      if (!email || !password) {
        showError('Please enter email and password');
        return;
      }
      
      if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
      }
      
      try {
        const { data, error } = await supabase.auth.signUp({ 
          email, 
          password,
          options: { data: { full_name: email.split('@')[0] }}
        });
        
        if (error) throw error;
        
        currentUser = data.user;
        await new Promise(resolve => setTimeout(resolve, 1500));
        await loadProfile();
        showOnboarding();
      } catch (error) {
        showError(error.message || 'Failed to create account');
      }
    }

    function showError(msg) {
      const errorEl = document.getElementById('auth-error');
      errorEl.textContent = msg;
      errorEl.classList.add('show');
      setTimeout(() => errorEl.classList.remove('show'), 5000);
    }

    async function logout() {
      if (!confirm('Are you sure you want to logout?')) return;
      
      try {
        await supabase.auth.signOut();
        currentUser = null;
        currentProfile = null;
        showAuth();
        showToast('Logged out successfully');
      } catch (error) {
        console.error('[Logout] Error:', error);
      }
    }

    // ============================================
    // PROFILE
    // ============================================
    async function loadProfile() {
      if (!currentUser) return;
      
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .maybeSingle();
        
        if (error && error.code !== 'PGRST116') throw error;
        
        if (!data) {
          await createProfile();
          return;
        }
        
        currentProfile = data;
        updateProfileUI();
      } catch (error) {
        console.error('[Profile] Error:', error);
        await createProfile();
      }
    }

    async function createProfile() {
      try {
        const username = currentUser.email.split('@')[0] + '_' + Date.now();
        
        const { data, error } = await supabase
          .from('profiles')
          .insert({
            id: currentUser.id,
            full_name: currentUser.email.split('@')[0],
            username: username,
            email: currentUser.email,
            profile_completed: false
          })
          .select()
          .single();
        
        if (error) throw error;
        currentProfile = data;
      } catch (error) {
        console.error('[Create Profile] Error:', error);
      }
    }

    function updateProfileUI() {
      if (!currentProfile) return;
      
      const avatarUrl = getAvatarUrl(currentProfile);
      
      document.getElementById('user-story-avatar').src = avatarUrl;
      document.getElementById('profile-avatar').src = avatarUrl;
      document.getElementById('comment-user-avatar').src = avatarUrl;
      document.getElementById('profile-name').textContent = currentProfile.full_name || 'User';
      document.getElementById('profile-username').textContent = '@' + (currentProfile.username || 'user');
      document.getElementById('profile-bio').textContent = currentProfile.bio || '';
    }

    function getAvatarUrl(profile) {
      if (profile?.avatar_url) {
        return supabase.storage.from('avatars').getPublicUrl(profile.avatar_url).data.publicUrl;
      }
      return `https://ui-avatars.com/api/?name=${encodeURIComponent(profile?.full_name || 'User')}&background=3b82f6&color=fff&size=200`;
    }

    // ============================================
    // ONBOARDING
    // ============================================
    function nextStep() {
      if (onboardingStep === 1) {
        const name = document.getElementById('onboard-name').value.trim();
        const username = document.getElementById('onboard-username').value.trim();
        if (!name || !username) {
          showToast('Please fill all fields');
          return;
        }
      }
      
      if (onboardingStep < 4) {
        document.getElementById(`step-${onboardingStep}`).classList.remove('active');
        onboardingStep++;
        document.getElementById(`step-${onboardingStep}`).classList.add('active');
        document.querySelectorAll('.step-dot').forEach((dot, i) => {
          dot.classList.toggle('active', i < onboardingStep);
        });
      }
    }

    function prevStep() {
      if (onboardingStep > 1) {
        document.getElementById(`step-${onboardingStep}`).classList.remove('active');
        onboardingStep--;
        document.getElementById(`step-${onboardingStep}`).classList.add('active');
        document.querySelectorAll('.step-dot').forEach((dot, i) => {
          dot.classList.toggle('active', i < onboardingStep);
        });
      }
    }

    function handleAvatarSelect() {
      const file = document.getElementById('avatar-file').files[0];
      if (!file) return;
      
      selectedAvatar = file;
      document.getElementById('avatar-preview').src = URL.createObjectURL(file);
      document.getElementById('avatar-preview').style.display = 'block';
      document.getElementById('avatar-icon').style.display = 'none';
    }

    function toggleInterest(btn) {
      btn.classList.toggle('selected');
      const interest = btn.dataset.interest;
      if (selectedInterests.includes(interest)) {
        selectedInterests = selectedInterests.filter(i => i !== interest);
      } else {
        selectedInterests.push(interest);
      }
    }

    async function completeOnboarding() {
      const btn = document.getElementById('btn-complete');
      btn.disabled = true;
      btn.textContent = 'Setting up...';
      
      try {
        const name = document.getElementById('onboard-name').value.trim();
        const username = document.getElementById('onboard-username').value.trim();
        const bio = document.getElementById('onboard-bio').value.trim();
        const dob = document.getElementById('onboard-dob').value;
        
        let avatarPath = null;
        if (selectedAvatar) {
          const fileName = `${currentUser.id}_${Date.now()}_${selectedAvatar.name}`;
          const { error } = await supabase.storage.from('avatars').upload(fileName, selectedAvatar);
          if (!error) avatarPath = fileName;
        }
        
        const { error } = await supabase
          .from('profiles')
          .update({
            full_name: name,
            username,
            bio,
            date_of_birth: dob,
            avatar_url: avatarPath,
            interests: selectedInterests,
            profile_completed: true
          })
          .eq('id', currentUser.id);
        
        if (error) throw error;
        
        await loadProfile();
        showMainApp();
        await loadFeed();
        showToast('Welcome to Right Talk! üéâ');
      } catch (error) {
        console.error('[Onboarding] Error:', error);
        showToast('Setup failed');
        btn.disabled = false;
        btn.textContent = 'Complete';
      }
    }

    // ============================================
    // FEED
    // ============================================
    async function loadFeed() {
      const container = document.getElementById('feed-container');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading feed...</div></div>';
      
      try {
        const { data: posts, error } = await supabase
          .from('posts')
          .select('*')
          .neq('post_type', 'reel')
          .order('created_at', { ascending: false })
          .limit(30);
        
        if (error) throw error;
        
        if (!posts || posts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon"><i class="bi bi-chat-dots"></i></div>
              <div class="empty-title">No posts yet</div>
              <div style="color:var(--gray);margin-top:8px;font-size:0.85rem;">Be the first to share!</div>
            </div>
          `;
          return;
        }
        
        allPosts = posts;
        
        const userIds = [...new Set(posts.map(p => p.user_id))];
        const { data: profiles } = await supabase
          .from('profiles')
          .select('*')
          .in('id', userIds);
        
        const profileMap = {};
        if (profiles) profiles.forEach(p => profileMap[p.id] = p);
        
        const postIds = posts.map(p => p.id);
        const { data: likes } = await supabase
          .from('likes')
          .select('post_id, user_id')
          .in('post_id', postIds);
        
        likesData.clear();
        if (likes) {
          likes.forEach(like => {
            if (!likesData.has(like.post_id)) {
              likesData.set(like.post_id, { count: 0, userLiked: false });
            }
            const data = likesData.get(like.post_id);
            data.count++;
            if (like.user_id === currentUser.id) {
              data.userLiked = true;
            }
          });
        }
        
        // Load comments count
        const { data: comments } = await supabase
          .from('comments')
          .select('post_id')
          .in('post_id', postIds);
        
        commentsData.clear();
        if (comments) {
          comments.forEach(comment => {
            commentsData.set(comment.post_id, (commentsData.get(comment.post_id) || 0) + 1);
          });
        }
        
        container.innerHTML = posts.map(post => {
          const likeData = likesData.get(post.id) || { count: 0, userLiked: false };
          const commentCount = commentsData.get(post.id) || 0;
          return createPostCard(post, profileMap[post.user_id], likeData, commentCount);
        }).join('');
      } catch (error) {
        console.error('[Feed] Error:', error);
        container.innerHTML = '<div class="empty-state"><div class="empty-title">Error loading feed</div></div>';
      }
    }

    function createPostCard(post, profile, likeData, commentCount) {
      const avatarUrl = getAvatarUrl(profile);
      const timeAgo = getTimeAgo(post.created_at);
      
      let mediaHTML = '';
      if (post.media_url) {
        const mediaTag = post.media_type === 'video' ?
          `<video src="${post.media_url}" controls playsinline preload="metadata"></video>` :
          `<img src="${post.media_url}" alt="Post" loading="lazy" />`;
        
        mediaHTML = `<div class="post-media">${mediaTag}</div>`;
      }
      
      let pollHTML = '';
      if (post.post_type === 'poll' && post.poll_data) {
        pollHTML = createPollHTML(post.id, post.poll_data);
      }
      
      let tagsHTML = '';
      if (post.tags && post.tags.length > 0) {
        tagsHTML = `
          <div class="post-tags">
            ${post.tags.map(tag => `<span class="tag">#${tag}</span>`).join(' ')}
          </div>
        `;
      }
      
      return `
        <div class="post-card" id="post-${post.id}">
          <div class="post-header">
            <img class="post-avatar" src="${avatarUrl}" alt="${profile?.full_name || 'User'}" />
            <div class="post-info">
              <div class="post-author">${escapeHtml(profile?.full_name || 'User')}</div>
              <div class="post-meta">${timeAgo}</div>
            </div>
            <i class="bi bi-three-dots-vertical post-options" onclick="showToast('Options: Share, Report, Hide')"></i>
          </div>
          ${post.content ? `<div class="post-content">${escapeHtml(post.content)}</div>` : ''}
          ${mediaHTML}
          ${pollHTML}
          <div class="post-actions">
            <button class="action-btn ${likeData.userLiked ? 'liked' : ''}" onclick="toggleLike('${post.id}')" id="like-btn-${post.id}">
              <i class="bi bi-heart${likeData.userLiked ? '-fill' : ''}"></i>
            </button>
            <button class="action-btn" onclick="openComments('${post.id}')">
              <i class="bi bi-chat"></i>
              ${commentCount > 0 ? `<span>${commentCount}</span>` : ''}
            </button>
            <button class="action-btn" onclick="sharePost('${post.id}')">
              <i class="bi bi-share"></i>
            </button>
            <button class="action-btn" onclick="toggleBookmark('${post.id}')" style="margin-left:auto;">
              <i class="bi bi-bookmark"></i>
            </button>
          </div>
          <div class="post-likes" id="likes-${post.id}">${likeData.count} ${likeData.count === 1 ? 'like' : 'likes'}</div>
          ${tagsHTML}
          <div class="post-timestamp">${timeAgo}</div>
        </div>
      `;
    }

    function createPollHTML(postId, pollData) {
      if (!pollData || !pollData.options) return '';
      
      const totalVotes = pollData.votes ? Object.values(pollData.votes).reduce((a, b) => a + b, 0) : 0;
      const userVote = pollData.userVotes?.[currentUser.id];
      
      return `
        <div class="poll-container">
          ${pollData.options.map((option, index) => {
            const votes = pollData.votes?.[index] || 0;
            const percentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
            const voted = userVote === index;
            
            return `
              <div class="poll-option-post ${voted ? 'voted' : ''}" onclick="votePoll('${postId}', ${index})">
                                <div class="poll-option-bar" style="width:${percentage}%"></div>
                <div class="poll-option-text">${escapeHtml(option)}</div>
                ${totalVotes > 0 ? `<div class="poll-option-percentage">${percentage}% ‚Ä¢ ${votes} votes</div>` : ''}
              </div>
            `;
          }).join('')}
          <div class="poll-footer">${totalVotes} ${totalVotes === 1 ? 'vote' : 'votes'}</div>
        </div>
      `;
    }

    async function votePoll(postId, optionIndex) {
      try {
        const { data: post } = await supabase
          .from('posts')
          .select('poll_data')
          .eq('id', postId)
          .single();
        
        if (!post) return;
        
        const pollData = post.poll_data || { options: [], votes: {}, userVotes: {} };
        
        if (pollData.userVotes && pollData.userVotes[currentUser.id] !== undefined) {
          showToast('You already voted!');
          return;
        }
        
        if (!pollData.votes) pollData.votes = {};
        if (!pollData.userVotes) pollData.userVotes = {};
        
        pollData.votes[optionIndex] = (pollData.votes[optionIndex] || 0) + 1;
        pollData.userVotes[currentUser.id] = optionIndex;
        
        const { error } = await supabase
          .from('posts')
          .update({ poll_data: pollData })
          .eq('id', postId);
        
        if (error) throw error;
        
        await loadFeed();
        showToast('Vote recorded! üìä');
      } catch (error) {
        console.error('[Vote Poll] Error:', error);
        showToast('Failed to vote');
      }
    }

    async function toggleLike(postId) {
      const btn = document.getElementById(`like-btn-${postId}`);
      const icon = btn.querySelector('i');
      const likesEl = document.getElementById(`likes-${postId}`);
      
      const likeData = likesData.get(postId) || { count: 0, userLiked: false };
      
      try {
        if (likeData.userLiked) {
          await supabase.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
          
          btn.classList.remove('liked');
          icon.className = 'bi bi-heart';
          likeData.count = Math.max(0, likeData.count - 1);
          likeData.userLiked = false;
        } else {
          await supabase.from('likes').insert({ post_id: postId, user_id: currentUser.id });
          
          btn.classList.add('liked');
          icon.className = 'bi bi-heart-fill';
          likeData.count++;
          likeData.userLiked = true;
        }
        
        likesData.set(postId, likeData);
        likesEl.textContent = `${likeData.count} ${likeData.count === 1 ? 'like' : 'likes'}`;
      } catch (error) {
        console.error('[Like] Error:', error);
        showToast('Failed to update like');
      }
    }

    function sharePost(postId) {
      if (navigator.share) {
        navigator.share({
          title: 'Check out this post on Right Talk',
          url: window.location.href + '?post=' + postId
        }).catch(() => {});
      } else {
        navigator.clipboard.writeText(window.location.href + '?post=' + postId);
        showToast('Link copied to clipboard! üîó');
      }
    }

    async function toggleBookmark(postId) {
      try {
        const { data: existing } = await supabase
          .from('bookmarks')
          .select('id')
          .eq('post_id', postId)
          .eq('user_id', currentUser.id)
          .maybeSingle();
        
        if (existing) {
          await supabase.from('bookmarks').delete().eq('id', existing.id);
          showToast('Bookmark removed');
        } else {
          await supabase.from('bookmarks').insert({
            post_id: postId,
            user_id: currentUser.id
          });
          showToast('Post saved! üìå');
        }
      } catch (error) {
        console.error('[Bookmark] Error:', error);
        showToast('Failed to bookmark');
      }
    }

    // ============================================
    // COMMENTS - FULLY WORKING
    // ============================================
    async function openComments(postId) {
      currentCommentPostId = postId;
      document.getElementById('comments-modal').classList.remove('hidden');
      document.getElementById('comment-input').value = '';
      document.getElementById('comment-send-btn').disabled = true;
      
      await loadComments(postId);
    }

    function closeComments() {
      document.getElementById('comments-modal').classList.add('hidden');
      currentCommentPostId = null;
    }

    async function loadComments(postId) {
      const list = document.getElementById('comments-list');
      list.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading comments...</div></div>';
      
      try {
        const { data: comments, error } = await supabase
          .from('comments')
          .select('*, profiles(*)')
          .eq('post_id', postId)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        if (!comments || comments.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon"><i class="bi bi-chat-dots"></i></div>
              <div class="empty-title">No comments yet</div>
              <div style="color:var(--gray);margin-top:8px;font-size:0.85rem;">Be the first to comment!</div>
            </div>
          `;
          return;
        }
        
        list.innerHTML = comments.map(comment => {
          const avatarUrl = getAvatarUrl(comment.profiles);
          return `
            <div class="comment-item">
              <img class="comment-avatar" src="${avatarUrl}" alt="${comment.profiles?.full_name || 'User'}" />
              <div class="comment-content">
                <div class="comment-author">${escapeHtml(comment.profiles?.full_name || 'User')}</div>
                <div class="comment-text">${escapeHtml(comment.content)}</div>
                <div class="comment-actions">
                  <button class="comment-action" onclick="likeComment('${comment.id}')">Like</button>
                  <button class="comment-action" onclick="replyToComment('${comment.id}')">Reply</button>
                  <span class="comment-time">${getTimeAgo(comment.created_at)}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('[Comments] Error:', error);
        list.innerHTML = '<div class="empty-state"><div class="empty-title">Error loading comments</div></div>';
      }
    }

    async function postComment() {
      const input = document.getElementById('comment-input');
      const content = input.value.trim();
      
      if (!content) return;
      
      const btn = document.getElementById('comment-send-btn');
      btn.disabled = true;
      
      try {
        const { error } = await supabase
          .from('comments')
          .insert({
            post_id: currentCommentPostId,
            user_id: currentUser.id,
            content: content
          });
        
        if (error) throw error;
        
        input.value = '';
        await loadComments(currentCommentPostId);
        
        // Update comment count in feed
        const currentCount = commentsData.get(currentCommentPostId) || 0;
        commentsData.set(currentCommentPostId, currentCount + 1);
        
        showToast('Comment posted! üí¨');
      } catch (error) {
        console.error('[Post Comment] Error:', error);
        showToast('Failed to post comment');
      } finally {
        btn.disabled = false;
      }
    }

    // Enable send button when typing
    document.addEventListener('DOMContentLoaded', () => {
      const commentInput = document.getElementById('comment-input');
      if (commentInput) {
        commentInput.addEventListener('input', (e) => {
          document.getElementById('comment-send-btn').disabled = !e.target.value.trim();
        });
        
        commentInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            postComment();
          }
        });
      }
    });

    function likeComment(commentId) {
      showToast('Comment liked! ‚ù§Ô∏è');
    }

    function replyToComment(commentId) {
      const input = document.getElementById('comment-input');
      input.focus();
      showToast('Reply mode activated');
    }

    // ============================================
    // SETTINGS - FULLY WORKING
    // ============================================
    function openSettings() {
      document.getElementById('settings-modal').classList.remove('hidden');
      loadSettingsData();
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.add('hidden');
    }

    function loadSettingsData() {
      // Load current settings from profile
      if (currentProfile) {
        document.getElementById('private-toggle').checked = currentProfile.private_account || false;
        document.getElementById('status-toggle').checked = currentProfile.show_activity_status !== false;
        document.getElementById('read-receipts-toggle').checked = currentProfile.read_receipts !== false;
        document.getElementById('push-toggle').checked = currentProfile.push_notifications !== false;
        document.getElementById('likes-toggle').checked = currentProfile.likes_notifications !== false;
        document.getElementById('autoplay-toggle').checked = currentProfile.autoplay_videos !== false;
      }
      
      // Add event listeners for settings changes
      document.getElementById('private-toggle').addEventListener('change', savePrivateAccount);
      document.getElementById('status-toggle').addEventListener('change', saveActivityStatus);
      document.getElementById('read-receipts-toggle').addEventListener('change', saveReadReceipts);
      document.getElementById('push-toggle').addEventListener('change', savePushNotifications);
      document.getElementById('likes-toggle').addEventListener('change', saveLikesNotifications);
      document.getElementById('autoplay-toggle').addEventListener('change', saveAutoplay);
    }

    async function savePrivateAccount(e) {
      try {
        const { error } = await supabase
          .from('profiles')
          .update({ private_account: e.target.checked })
          .eq('id', currentUser.id);
        
        if (error) throw error;
        showToast(e.target.checked ? 'Account is now private' : 'Account is now public');
      } catch (error) {
        console.error('[Settings] Error:', error);
        showToast('Failed to update setting');
      }
    }

    async function saveActivityStatus(e) {
      try {
        const { error } = await supabase
          .from('profiles')
          .update({ show_activity_status: e.target.checked })
          .eq('id', currentUser.id);
        
        if (error) throw error;
        showToast(e.target.checked ? 'Activity status visible' : 'Activity status hidden');
      } catch (error) {
        console.error('[Settings] Error:', error);
      }
    }

    async function saveReadReceipts(e) {
      try {
        const { error } = await supabase
          .from('profiles')
          .update({ read_receipts: e.target.checked })
          .eq('id', currentUser.id);
        
        if (error) throw error;
        showToast(e.target.checked ? 'Read receipts enabled' : 'Read receipts disabled');
      } catch (error) {
        console.error('[Settings] Error:', error);
      }
    }

    async function savePushNotifications(e) {
      try {
        const { error } = await supabase
          .from('profiles')
          .update({ push_notifications: e.target.checked })
          .eq('id', currentUser.id);
        
        if (error) throw error;
        
        if (e.target.checked && 'Notification' in window) {
          Notification.requestPermission();
        }
        
        showToast(e.target.checked ? 'Notifications enabled' : 'Notifications disabled');
      } catch (error) {
        console.error('[Settings] Error:', error);
      }
    }

    async function saveLikesNotifications(e) {
      try {
        const { error } = await supabase
          .from('profiles')
          .update({ likes_notifications: e.target.checked })
          .eq('id', currentUser.id);
        
        if (error) throw error;
        showToast('Notification preferences updated');
      } catch (error) {
        console.error('[Settings] Error:', error);
      }
    }

    async function saveAutoplay(e) {
      try {
        const { error } = await supabase
          .from('profiles')
          .update({ autoplay_videos: e.target.checked })
          .eq('id', currentUser.id);
        
        if (error) throw error;
        showToast(e.target.checked ? 'Autoplay enabled' : 'Autoplay disabled');
      } catch (error) {
        console.error('[Settings] Error:', error);
      }
    }

    // ============================================
    // NOTIFICATIONS
    // ============================================
    function openNotifications() {
      showToast('Notifications:\n‚Ä¢ New follower\n‚Ä¢ Post liked\n‚Ä¢ New comment');
    }

    // ============================================
    // EXPLORE WITH SEARCH
    // ============================================
    async function loadExplore() {
      const content = document.getElementById('explore-content');
      content.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading explore...</div></div>';
      
      if (currentExploreTab === 'posts') {
        await loadExplorePosts();
      } else if (currentExploreTab === 'accounts') {
        await loadExploreAccounts();
      } else if (currentExploreTab === 'polls') {
        await loadExplorePolls();
      } else if (currentExploreTab === 'reels') {
        await loadExploreReels();
      }
    }

    async function loadExplorePosts() {
      try {
        const { data: posts, error } = await supabase
          .from('posts')
          .select('*')
          .not('media_url', 'is', null)
          .neq('post_type', 'reel')
          .order('created_at', { ascending: false })
          .limit(24);
        
        if (error) throw error;
        
        if (!posts || posts.length === 0) {
          document.getElementById('explore-content').innerHTML = '<div class="empty-state"><div class="empty-title">No posts to explore</div></div>';
          return;
        }
        
        const postIds = posts.map(p => p.id);
        const { data: likes } = await supabase
          .from('likes')
          .select('post_id')
          .in('post_id', postIds);
        
        const likeCounts = {};
        if (likes) {
          likes.forEach(like => {
            likeCounts[like.post_id] = (likeCounts[like.post_id] || 0) + 1;
          });
        }
        
        document.getElementById('explore-content').innerHTML = `
          <div class="explore-grid">
            ${posts.map(p => {
              const likeCount = likeCounts[p.id] || 0;
              return `
                <div class="explore-item" onclick="showToast('Post detail view')">
                  ${p.media_type === 'video' ? 
                    `<video src="${p.media_url}" preload="metadata"></video>` : 
                    `<img src="${p.media_url}" alt="Post" loading="lazy" />`
                  }
                  <div class="explore-stats">
                    <span><i class="bi bi-heart-fill"></i> ${likeCount}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } catch (error) {
        console.error('[Explore Posts] Error:', error);
        document.getElementById('explore-content').innerHTML = '<div class="empty-state"><div class="empty-title">Error loading posts</div></div>';
      }
    }

    async function loadExploreAccounts() {
      try {
        const { data: profiles, error } = await supabase
          .from('profiles')
          .select('*')
          .neq('id', currentUser.id)
          .limit(50);
        
        if (error) throw error;
        
        if (!profiles || profiles.length === 0) {
          document.getElementById('explore-content').innerHTML = '<div class="empty-state"><div class="empty-title">No accounts found</div></div>';
          return;
        }
        
        document.getElementById('explore-content').innerHTML = `
          <div class="search-results">
            ${profiles.map(profile => {
              const avatarUrl = getAvatarUrl(profile);
              return `
                <div class="search-result-item" onclick="showToast('View profile: ${profile.full_name}')">
                  <img class="search-result-avatar" src="${avatarUrl}" alt="${profile.full_name}" />
                  <div class="search-result-info">
                    <div class="search-result-name">${escapeHtml(profile.full_name || 'User')}</div>
                    <div class="search-result-username">@${escapeHtml(profile.username || 'user')}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } catch (error) {
        console.error('[Explore Accounts] Error:', error);
        document.getElementById('explore-content').innerHTML = '<div class="empty-state"><div class="empty-title">Error loading accounts</div></div>';
      }
    }

    async function loadExplorePolls() {
      try {
        const { data: polls, error } = await supabase
          .from('posts')
          .select('*')
          .eq('post_type', 'poll')
          .order('created_at', { ascending: false })
          .limit(30);
        
        if (error) throw error;
        
        if (!polls || polls.length === 0) {
          document.getElementById('explore-content').innerHTML = '<div class="empty-state"><div class="empty-title">No polls found</div></div>';
          return;
        }
        
        const userIds = [...new Set(polls.map(p => p.user_id))];
        const { data: profiles } = await supabase
          .from('profiles')
          .select('*')
          .in('id', userIds);
        
        const profileMap = {};
        if (profiles) profiles.forEach(p => profileMap[p.id] = p);
        
        const pollIds = polls.map(p => p.id);
        const { data: likes } = await supabase
          .from('likes')
          .select('post_id, user_id')
          .in('post_id', pollIds);
        
        likesData.clear();
        if (likes) {
          likes.forEach(like => {
            if (!likesData.has(like.post_id)) {
              likesData.set(like.post_id, { count: 0, userLiked: false });
            }
            const data = likesData.get(like.post_id);
            data.count++;
            if (like.user_id === currentUser.id) {
              data.userLiked = true;
            }
          });
        }
        
        document.getElementById('explore-content').innerHTML = polls.map(poll => {
          const likeData = likesData.get(poll.id) || { count: 0, userLiked: false };
          const commentCount = commentsData.get(poll.id) || 0;
          return createPostCard(poll, profileMap[poll.user_id], likeData, commentCount);
        }).join('');
      } catch (error) {
        console.error('[Explore Polls] Error:', error);
        document.getElementById('explore-content').innerHTML = '<div class="empty-state"><div class="empty-title">Error loading polls</div></div>';
      }
    }

    async function loadExploreReels() {
      try {
        const { data: reels, error } = await supabase
          .from('posts')
          .select('*')
          .eq('post_type', 'reel')
          .not('media_url', 'is', null)
          .order('created_at', { ascending: false })
          .limit(24);
        
        if (error) throw error;
        
        if (!reels || reels.length === 0) {
          document.getElementById('explore-content').innerHTML = '<div class="empty-state"><div class="empty-title">No reels found</div></div>';
          return;
        }
        
        const reelIds = reels.map(r => r.id);
        const { data: likes } = await supabase
          .from('likes')
          .select('post_id')
          .in('post_id', reelIds);
        
        const likeCounts = {};
        if (likes) {
          likes.forEach(like => {
            likeCounts[like.post_id] = (likeCounts[like.post_id] || 0) + 1;
          });
        }
        
        document.getElementById('explore-content').innerHTML = `
          <div class="explore-grid">
            ${reels.map(r => {
              const likeCount = likeCounts[r.id] || 0;
              return `
                <div class="explore-item" onclick="openReelsFromExplore('${r.id}')">
                  <video src="${r.media_url}" preload="metadata"></video>
                  <div class="grid-item-icon">
                    <i class="bi bi-play-circle-fill"></i>
                  </div>
                  <div class="explore-stats">
                    <span><i class="bi bi-heart-fill"></i> ${likeCount}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } catch (error) {
        console.error('[Explore Reels] Error:', error);
        document.getElementById('explore-content').innerHTML = '<div class="empty-state"><div class="empty-title">Error loading reels</div></div>';
      }
    }

    function switchExploreTab(tab) {
      currentExploreTab = tab;
      
      document.querySelectorAll('.explore-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      
      loadExplore();
    }

    function handleSearch(query) {
      clearTimeout(searchTimeout);
      
      if (!query.trim()) {
        loadExplore();
        return;
      }
      
      searchTimeout = setTimeout(() => {
        performSearch(query.trim());
      }, 500);
    }

    async function performSearch(query) {
      const content = document.getElementById('explore-content');
      content.innerHTML = '<div class="loading"><div class="spinner"></div><div>Searching...</div></div>';
      
      try {
        if (currentExploreTab === 'accounts') {
          const { data: profiles } = await supabase
            .from('profiles')
            .select('*')
            .or(`full_name.ilike.%${query}%,username.ilike.%${query}%`)
            .limit(30);
          
          if (!profiles || profiles.length === 0) {
            content.innerHTML = '<div class="empty-state"><div class="empty-title">No accounts found</div></div>';
            return;
          }
          
          content.innerHTML = `
            <div class="search-results">
              ${profiles.map(profile => {
                const avatarUrl = getAvatarUrl(profile);
                return `
                  <div class="search-result-item" onclick="showToast('View profile: ${profile.full_name}')">
                    <img class="search-result-avatar" src="${avatarUrl}" alt="${profile.full_name}" />
                    <div class="search-result-info">
                      <div class="search-result-name">${escapeHtml(profile.full_name || 'User')}</div>
                      <div class="search-result-username">@${escapeHtml(profile.username || 'user')}</div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        } else {
          const { data: posts } = await supabase
            .from('posts')
            .select('*')
            .or(`content.ilike.%${query}%,tags.cs.{${query}}`)
            .order('created_at', { ascending: false })
            .limit(30);
          
          if (!posts || posts.length === 0) {
            content.innerHTML = '<div class="empty-state"><div class="empty-title">No results found</div></div>';
            return;
          }
          
          showToast(`Found ${posts.length} results`);
          loadExplore();
        }
      } catch (error) {
        console.error('[Search] Error:', error);
        content.innerHTML = '<div class="empty-state"><div class="empty-title">Error searching</div></div>';
      }
    }

    // ============================================
    // REELS - COMPLETE IMPLEMENTATION
    // ============================================
    async function openReels() {
      document.getElementById('reels-view').classList.remove('hidden');
      await loadReels();
    }

    async function openReelsFromExplore(reelId) {
      document.getElementById('reels-view').classList.remove('hidden');
      await loadReels(reelId);
    }

    function closeReels() {
      document.getElementById('reels-view').classList.add('hidden');
      
      document.querySelectorAll('.reel-video').forEach(video => {
        video.pause();
      });
    }

    async function loadReels(startReelId = null) {
      try {
        const { data: reels, error } = await supabase
          .from('posts')
          .select('*')
          .eq('post_type', 'reel')
          .not('media_url', 'is', null)
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        if (!reels || reels.length === 0) {
          document.getElementById('reels-container').innerHTML = `
            <div class="empty-state" style="height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <div class="empty-icon"><i class="bi bi-play-circle"></i></div>
              <div class="empty-title" style="color:white;">No Reels Yet</div>
            </div>
          `;
          return;
        }
        
        allReels = reels;
        
        const userIds = [...new Set(reels.map(r => r.user_id))];
        const { data: profiles } = await supabase
          .from('profiles')
          .select('*')
          .in('id', userIds);
        
        const profileMap = {};
        if (profiles) profiles.forEach(p => profileMap[p.id] = p);
        
        const reelIds = reels.map(r => r.id);
        const { data: likes } = await supabase
          .from('likes')
          .select('post_id, user_id')
          .in('post_id', reelIds);
        
        likesData.clear();
        if (likes) {
          likes.forEach(like => {
            if (!likesData.has(like.post_id)) {
              likesData.set(like.post_id, { count: 0, userLiked: false });
            }
            const data = likesData.get(like.post_id);
            data.count++;
            if (like.user_id === currentUser.id) {
              data.userLiked = true;
            }
          });
        }
        
        if (startReelId) {
          currentReelIndex = reels.findIndex(r => r.id === startReelId);
          if (currentReelIndex === -1) currentReelIndex = 0;
        } else {
          currentReelIndex = 0;
        }
        
        const container = document.getElementById('reels-container');
        container.innerHTML = reels.map((reel, index) => {
          const profile = profileMap[reel.user_id];
          const likeData = likesData.get(reel.id) || { count: 0, userLiked: false };
          return createReelHTML(reel, profile, likeData, index);
        }).join('');
        
        setupReelsScroll();
        
        if (startReelId && currentReelIndex > 0) {
          const reelElement = document.querySelector(`#reel-${currentReelIndex}`);
          if (reelElement) {
            reelElement.scrollIntoView();
          }
        }
        
        playReelVideo(currentReelIndex);
      } catch (error) {
        console.error('[Load Reels] Error:', error);
      }
    }

    function createReelHTML(reel, profile, likeData, index) {
      const avatarUrl = getAvatarUrl(profile);
      
      let tagsHTML = '';
      if (reel.tags && reel.tags.length > 0) {
        tagsHTML = reel.tags.map(tag => `<span class="reel-tag">#${tag}</span>`).join(' ');
      }
      
      return `
        <div class="reel-item" id="reel-${index}" data-index="${index}">
          <video 
            class="reel-video" 
            id="reel-video-${index}"
            src="${reel.media_url}" 
            loop 
            playsinline
            onclick="toggleReelPlay(${index})"
          ></video>
          
          <div class="reel-overlay"></div>
          
          <div class="reel-play-pause" id="reel-play-pause-${index}">
            <i class="bi bi-pause-fill"></i>
          </div>
          
          <div class="reel-info">
            <div class="reel-author-row">
              <img class="reel-author-avatar" src="${avatarUrl}" alt="${profile?.full_name || 'User'}" />
              <div class="reel-author-name">${escapeHtml(profile?.full_name || 'User')}</div>
              ${reel.user_id !== currentUser.id ? '<button class="reel-follow-btn" onclick="showToast(\'Following!\')">Follow</button>' : ''}
            </div>
            ${reel.content ? `<div class="reel-description">${escapeHtml(reel.content)}</div>` : ''}
            ${tagsHTML ? `<div class="reel-tags">${tagsHTML}</div>` : ''}
          </div>
          
          <div class="reel-actions">
            <button class="reel-action-btn" onclick="toggleReelLike('${reel.id}', ${index})">
              <div class="reel-action-icon ${likeData.userLiked ? 'liked' : ''}" id="reel-like-icon-${index}">
                <i class="bi bi-heart${likeData.userLiked ? '-fill' : ''}"></i>
              </div>
              <span class="reel-action-count" id="reel-like-count-${index}">${likeData.count}</span>
            </button>
            
            <button class="reel-action-btn" onclick="openComments('${reel.id}')">
              <div class="reel-action-icon">
                <i class="bi bi-chat-fill"></i>
              </div>
              <span class="reel-action-count">0</span>
            </button>
            
            <button class="reel-action-btn" onclick="sharePost('${reel.id}')">
              <div class="reel-action-icon">
                <i class="bi bi-share-fill"></i>
              </div>
            </button>
            
            <button class="reel-action-btn" onclick="toggleBookmark('${reel.id}')">
              <div class="reel-action-icon">
                <i class="bi bi-bookmark"></i>
              </div>
            </button>
          </div>
        </div>
      `;
    }

    function setupReelsScroll() {
      const container = document.getElementById('reels-container');
      let isScrolling = false;
      
      container.addEventListener('scroll', () => {
        if (isScrolling) return;
        
        isScrolling = true;
        setTimeout(() => {
          const scrollTop = container.scrollTop;
          const windowHeight = window.innerHeight;
          const newIndex = Math.round(scrollTop / windowHeight);
          
          if (newIndex !== currentReelIndex) {
            pauseReelVideo(currentReelIndex);
            currentReelIndex = newIndex;
            playReelVideo(currentReelIndex);
          }
          
          isScrolling = false;
        }, 100);
      });
    }

    function playReelVideo(index) {
      const video = document.getElementById(`reel-video-${index}`);
      if (video) {
        video.play().catch(err => console.log('Autoplay prevented:', err));
      }
    }

    function pauseReelVideo(index) {
      const video = document.getElementById(`reel-video-${index}`);
      if (video) {
        video.pause();
      }
    }

    function toggleReelPlay(index) {
      const video = document.getElementById(`reel-video-${index}`);
      const playPause = document.getElementById(`reel-play-pause-${index}`);
      
      if (!video) return;
      
      if (video.paused) {
        video.play();
        playPause.innerHTML = '<i class="bi bi-play-fill"></i>';
      } else {
        video.pause();
        playPause.innerHTML = '<i class="bi bi-pause-fill"></i>';
      }
      
      playPause.classList.add('show');
      setTimeout(() => playPause.classList.remove('show'), 500);
    }

    async function toggleReelLike(reelId, index) {
      const icon = document.getElementById(`reel-like-icon-${index}`);
      const countEl = document.getElementById(`reel-like-count-${index}`);
      
      const likeData = likesData.get(reelId) || { count: 0, userLiked: false };
      
      try {
        if (likeData.userLiked) {
          await supabase.from('likes').delete().eq('post_id', reelId).eq('user_id', currentUser.id);
          
          icon.classList.remove('liked');
          icon.querySelector('i').className = 'bi bi-heart';
          likeData.count = Math.max(0, likeData.count - 1);
          likeData.userLiked = false;
        } else {
          await supabase.from('likes').insert({ post_id: reelId, user_id: currentUser.id });
          
          icon.classList.add('liked');
          icon.querySelector('i').className = 'bi bi-heart-fill';
          likeData.count++;
          likeData.userLiked = true;
        }
        
        likesData.set(reelId, likeData);
        countEl.textContent = likeData.count;
      } catch (error) {
        console.error('[Reel Like] Error:', error);
      }
    }

    // ============================================
    // CHATS
    // ============================================
    async function loadChats() {
      const list = document.getElementById('chats-list');
      list.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading chats...</div></div>';
      
      try {
        const { count, error: countError } = await supabase
          .from('messages')
          .select('*', { count: 'exact', head: true });
        
        if (countError) {
          console.error('[Chats] Table error:', countError);
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon"><i class="bi bi-chat-dots"></i></div>
              <div class="empty-title">Messages coming soon!</div>
              <div style="color:var(--gray);margin-top:8px;font-size:0.85rem;">Chat feature will be available soon</div>
            </div>
          `;
          return;
        }
        
        const { data: messages, error } = await supabase
          .from('messages')
          .select('*')
          .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
          .order('created_at', { ascending: false })
          .limit(100);
        
        if (error) {
          console.error('[Chats] Load error:', error);
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon"><i class="bi bi-chat-dots"></i></div>
              <div class="empty-title">No messages yet</div>
              <div style="color:var(--gray);margin-top:8px;font-size:0.85rem;">Start a conversation!</div>
            </div>
          `;
          return;
        }
        
        if (!messages || messages.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon"><i class="bi bi-chat-dots"></i></div>
              <div class="empty-title">No messages yet</div>
              <div style="color:var(--gray);margin-top:8px;font-size:0.85rem;">Start a conversation!</div>
            </div>
          `;
          return;
        }
        
        const conversations = {};
        messages.forEach(msg => {
          const partnerId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
          if (!conversations[partnerId] || new Date(msg.created_at) > new Date(conversations[partnerId].created_at)) {
            conversations[partnerId] = msg;
          }
        });
        
        const partnerIds = Object.keys(conversations);
        const { data: profiles } = await supabase
          .from('profiles')
          .select('*')
          .in('id', partnerIds);
        
        const profileMap = {};
        if (profiles) profiles.forEach(p => profileMap[p.id] = p);
        
        list.innerHTML = Object.entries(conversations).map(([partnerId, msg]) => {
          const partner = profileMap[partnerId];
          if (!partner) return '';
          
          const avatarUrl = getAvatarUrl(partner);
          const isUnread = msg.sender_id !== currentUser.id && !msg.read;
          
          return `
            <div class="chat-item" onclick="showToast('Chat with ${partner.full_name}')">
              <div style="position:relative;">
                <img class="chat-avatar" src="${avatarUrl}" alt="${partner.full_name}" />
                ${Math.random() > 0.5 ? '<div class="online-indicator"></div>' : ''}
              </div>
              <div class="chat-info">
                <div class="chat-name">${escapeHtml(partner.full_name || 'User')}</div>
                <div class="chat-last-message ${isUnread ? 'unread' : ''}">
                  ${msg.sender_id === currentUser.id ? 'You: ' : ''}${escapeHtml(msg.content || 'Media')}
                </div>
              </div>
              <div class="chat-meta">
                <div class="chat-time">${getTimeAgo(msg.created_at)}</div>
                ${isUnread ? '<div class="unread-badge">1</div>' : ''}
              </div>
            </div>
          `;
        }).filter(html => html).join('');
      } catch (error) {
        console.error('[Chats] Error:', error);
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon"><i class="bi bi-chat-dots"></i></div>
            <div class="empty-title">Messages coming soon!</div>
          </div>
        `;
      }
    }

    function searchChats(query) {
      const items = document.querySelectorAll('.chat-item');
      items.forEach(item => {
        const name = item.querySelector('.chat-name')?.textContent.toLowerCase() || '';
        const message = item.querySelector('.chat-last-message')?.textContent.toLowerCase() || '';
        const matches = name.includes(query.toLowerCase()) || message.includes(query.toLowerCase());
        item.style.display = matches ? 'flex' : 'none';
      });
    }

    // ============================================
    // CREATE POST WITH REELS
    // ============================================
    function openCreatePost() {
      document.getElementById('create-post-modal').classList.remove('hidden');
      document.getElementById('post-content').value = '';
      document.getElementById('post-tags').value = '';
      removePostMedia();
      selectPostType('note');
      selectVisibility('public');
    }

    function closeCreatePost() {
      document.getElementById('create-post-modal').classList.add('hidden');
    }

    function selectPostType(type) {
      currentPostType = type;
      
      document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
      });
      
      const mediaContainer = document.getElementById('media-upload-container');
      const pollCreator = document.getElementById('poll-creator');
      const uploadText = document.getElementById('upload-text');
      const mediaFile = document.getElementById('post-media-file');
      
      mediaContainer.classList.add('hidden');
      pollCreator.classList.add('hidden');
      
      if (type === 'image') {
        mediaContainer.classList.remove('hidden');
        uploadText.textContent = 'Upload image';
        mediaFile.accept = 'image/*';
      } else if (type === 'reel') {
        mediaContainer.classList.remove('hidden');
        uploadText.textContent = 'Upload reel (vertical video)';
        mediaFile.accept = 'video/*';
      } else if (type === 'poll') {
        pollCreator.classList.remove('hidden');
      }
    }

    function selectVisibility(visibility) {
      postVisibility = visibility;
      
      document.querySelectorAll('.visibility-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.visibility === visibility);
      });
    }

    function handlePostMediaSelect() {
      const file = document.getElementById('post-media-file').files[0];
      if (!file) return;
      
      selectedPostMedia = file;
      const url = URL.createObjectURL(file);
      
      const preview = document.getElementById('post-media-preview');
      const img = document.getElementById('preview-img');
      const video = document.getElementById('preview-video');
      
      if (file.type.startsWith('image/')) {
        img.src = url;
        img.style.display = 'block';
        video.style.display = 'none';
      } else {
        video.src = url;
        video.style.display = 'block';
        img.style.display = 'none';
      }
      
      preview.classList.remove('hidden');
    }

    function removePostMedia() {
      selectedPostMedia = null;
      document.getElementById('post-media-file').value = '';
      document.getElementById('post-media-preview').classList.add('hidden');
      document.getElementById('preview-img').src = '';
      document.getElementById('preview-video').src = '';
    }

    function addPollOption() {
      const optionsList = document.getElementById('poll-options-list');
      const count = optionsList.children.length + 1;
      
      if (count > 6) {
        showToast('Maximum 6 options allowed');
        return;
      }
      
      const newOption = document.createElement('div');
      newOption.className = 'poll-option-input';
      newOption.innerHTML = `
        <input type="text" placeholder="Option ${count}" class="poll-option-text" />
        <button class="poll-remove-btn" onclick="this.parentElement.remove()">
          <i class="bi bi-x-lg"></i>
        </button>
      `;
      
      optionsList.appendChild(newOption);
    }

    async function createPost() {
      const content = document.getElementById('post-content').value.trim();
      const tagsInput = document.getElementById('post-tags').value.trim();
      
      if (!content && !selectedPostMedia && currentPostType !== 'poll') {
        showToast('Please add content or media');
        return;
      }
      
      if (currentPostType === 'poll') {
        return await createPollPost(content, tagsInput);
      }
      
      const btn = document.getElementById('btn-create');
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i><span>Posting...</span>';
      
      try {
        let mediaUrl = null;
        let mediaType = null;
        
        if (selectedPostMedia) {
          const fileName = `${currentUser.id}_${Date.now()}_${selectedPostMedia.name}`;
          const { error: uploadError } = await supabase.storage.from('posts').upload(fileName, selectedPostMedia);
          if (uploadError) throw uploadError;
          
          mediaUrl = supabase.storage.from('posts').getPublicUrl(fileName).data.publicUrl;
          mediaType = selectedPostMedia.type.startsWith('video/') ? 'video' : 'image';
        }
        
        const tags = tagsInput ? tagsInput.split(/[\s,]+/).map(t => t.replace('#', '').trim()).filter(t => t) : [];
        
        const { error } = await supabase.from('posts').insert({
          user_id: currentUser.id,
          content: content || null,
          media_url: mediaUrl,
          media_type: mediaType,
          post_type: currentPostType,
          tags: tags,
          visibility: postVisibility
        });
        
        if (error) throw error;
        
        closeCreatePost();
        
        if (currentPostType === 'reel') {
          showToast('Reel posted! üé¨');
          await loadReels();
        } else {
          showToast('Post shared! üéâ');
          await loadFeed();
        }
      } catch (error) {
        console.error('[Create Post] Error:', error);
        showToast('Failed to create post');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send-fill"></i><span>Share Post</span>';
      }
    }

    async function createPollPost(content, tagsInput) {
      const question = document.getElementById('poll-question').value.trim();
      const options = Array.from(document.querySelectorAll('#poll-options-list input'))
        .map(input => input.value.trim())
        .filter(text => text);
      
      if (!question) {
        showToast('Please enter a poll question');
        return;
      }
      
      if (options.length < 2) {
        showToast('Please add at least 2 options');
        return;
      }
      
      const btn = document.getElementById('btn-create');
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i><span>Posting...</span>';
      
      try {
        const tags = tagsInput ? tagsInput.split(/[\s,]+/).map(t => t.replace('#', '').trim()).filter(t => t) : [];
        
        const pollData = {
          question,
          options,
          votes: {},
          userVotes: {}
        };
        
        const { error } = await supabase.from('posts').insert({
          user_id: currentUser.id,
          content: content || question,
          post_type: 'poll',
          poll_data: pollData,
          tags: tags,
          visibility: postVisibility
        });
        
        if (error) throw error;
        
        closeCreatePost();
        await loadFeed();
        showToast('Poll posted! üìä');
      } catch (error) {
        console.error('[Create Poll] Error:', error);
        showToast('Failed to create poll');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send-fill"></i><span>Share Post</span>';
      }
    }

    // ============================================
    // NAVIGATION
    // ============================================
    function switchView(view) {
      console.log('[Nav] Switching to:', view);
      currentView = view;
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      
      document.getElementById('feed-view').classList.add('hidden');
      document.getElementById('explore-view').classList.add('hidden');
      document.getElementById('chats-view').classList.add('hidden');
      document.getElementById('profile-view').classList.add('hidden');
      document.getElementById('reels-view').classList.add('hidden');
      
      document.getElementById(`${view}-view`).classList.remove('hidden');
      
      if (view === 'feed') {
        loadFeed();
      } else if (view === 'explore') {
        loadExplore();
      } else if (view === 'chats') {
        loadChats();
      } else if (view === 'profile') {
        loadProfileStats();
      }
    }

    async function loadProfileStats() {
      try {
        const { count: postsCount } = await supabase
          .from('posts')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);
        
        document.getElementById('stat-posts').textContent = postsCount || 0;
        document.getElementById('stat-followers').textContent = '0';
        document.getElementById('stat-following').textContent = '0';
        
        await loadUserPosts();
      } catch (error) {
        console.error('[Profile Stats] Error:', error);
      }
    }

    async function loadUserPosts() {
      try {
        const { data: posts } = await supabase
          .from('posts')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });
        
        const grid = document.getElementById('profile-posts');
        if (!posts || posts.length === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon"><i class="bi bi-grid-3x3-gap"></i></div>
              <div class="empty-title">No Posts Yet</div>
            </div>
          `;
          return;
        }
        
        grid.innerHTML = posts.map(p => `
          <div class="grid-item" onclick="${p.post_type === 'reel' ? `openReelsFromExplore('${p.id}')` : `showToast('Post detail view')`}">
            ${p.media_url ? 
              (p.media_type === 'video' ? 
                `<video src="${p.media_url}" preload="metadata"></video>` : 
                `<img src="${p.media_url}" loading="lazy" />`) : 
              `<div style="background:var(--light);display:flex;align-items:center;justify-content:center;height:100%;"><i class="bi bi-file-text" style="font-size:2rem;color:var(--gray);"></i></div>`
            }
            ${p.post_type === 'reel' ? '<div class="grid-item-icon"><i class="bi bi-play-circle-fill"></i></div>' : ''}
          </div>
        `).join('');
      } catch (error) {
        console.error('[User Posts] Error:', error);
      }
    }

    // ============================================
    // UTILITIES
    // ============================================
    function showAuth() {
      document.getElementById('auth-screen').classList.remove('hidden');
      document.getElementById('onboarding-screen').classList.add('hidden');
      document.getElementById('main-app').classList.add('hidden');
    }

    function showOnboarding() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('onboarding-screen').classList.remove('hidden');
      document.getElementById('main-app').classList.add('hidden');
    }

    function showMainApp() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('onboarding-screen').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function getTimeAgo(timestamp) {
      const now = new Date();
      const past = new Date(timestamp);
      const seconds = Math.floor((now - past) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;
      return `${Math.floor(seconds / 604800)}w`;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function closeOnOutside(event, modalId) {
      if (event.target.classList.contains('comments-modal') || 
          event.target.classList.contains('settings-modal') ||
          event.target.id === modalId) {
        document.getElementById(modalId).classList.add('hidden');
      }
    }

    // ============================================
    // START APPLICATION
    // ============================================
    window.addEventListener('DOMContentLoaded', init);
    
    console.log('‚úÖ Right Talk v3.0 - All Features Working!');
  </script>
</body>
</html>

